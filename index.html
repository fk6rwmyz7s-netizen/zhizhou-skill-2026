<!DOCTYPE html>
<html lang="zh-CN" x-data="app()" x-cloak>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>çŸ¥èˆŸæŠ€èƒ½äº¤æ¢å¹³å° Â· ç¤¾äº¤ç‰ˆ</title>
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com/3.3.3"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <!-- html2canvas for sharing cards -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        [x-cloak] { display: none !important; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .skill-tag {
            display: inline-block;
            padding: 4px 12px;
            background: #e6f7ff;
            color: #1890ff;
            border-radius: 16px;
            font-size: 14px;
            margin: 4px;
        }
        .skill-tag.teach {
            background: #f6ffed;
            color: #52c41a;
            border: 1px solid #b7eb8f;
        }
        .skill-tag.learn {
            background: #fff7e6;
            color: #fa8c16;
            border: 1px solid #ffd591;
        }
        .match-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        .match-high { background: #f6ffed; color: #52c41a; }
        .match-medium { background: #fff7e6; color: #fa8c16; }
        .match-low { background: #fff2f0; color: #ff4d4f; }
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: #1890ff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .message-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            margin-bottom: 8px;
        }
        .message-sent { background: #1890ff; color: white; margin-left: auto; }
        .message-received { background: #f0f0f0; color: #333; }
        .message-failed {
            background: linear-gradient(135deg, #ffcdd2 0%, #ffebee 100%);
            color: #d32f2f;
            margin-left: auto;
            position: relative;
            border: 1px solid #ffcdd2;
        }
        .message-failed::after {
            content: "å‘é€å¤±è´¥";
            position: absolute;
            top: -18px;
            right: 10px;
            font-size: 11px;
            color: #d32f2f;
            background: #ffebee;
            padding: 1px 6px;
            border-radius: 8px;
        }
        .glasscard {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .modal-scrollable {
            max-height: calc(100vh - 120px);
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: rgba(0,0,0,0.2) transparent;
        }
        .modal-scrollable::-webkit-scrollbar { width: 6px; }
        .modal-scrollable::-webkit-scrollbar-track { background: transparent; }
        .modal-scrollable::-webkit-scrollbar-thumb { background-color: rgba(0,0,0,0.2); border-radius: 3px; }
        .video-room-panel {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .video-room-content {
            background: white;
            border-radius: 16px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(50px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* æ–°å¢ï¼šè¯„ä»·ç›¸å…³æ ·å¼ */
        .star-rating { display: flex; gap: 4px; }
        .star-rating i { cursor: pointer; transition: all 0.2s; }
        .star-rating i:hover, .star-rating i.active { color: #fbbf24; transform: scale(1.1); }
        .star-rating i.inactive { color: #d1d5db; }
        
        .review-tag {
            display: inline-block;
            padding: 6px 12px;
            background: #f3f4f6;
            border: 2px solid transparent;
            border-radius: 20px;
            font-size: 13px;
            margin: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .review-tag:hover, .review-tag.selected { background: #dbeafe; border-color: #3b82f6; color: #1d4ed8; }
        
        .trust-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: white;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        .trust-badge.platinum { background: linear-gradient(135deg, #e5e7eb 0%, #9ca3af 100%); }
        .trust-badge.gold { background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); }
        .trust-badge.silver { background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%); }
        
        /* åˆ†äº«å¡ç‰‡æ ·å¼ */
        .share-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            padding: 40px;
            color: white;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        .share-card::before {
            content: '';
            position: absolute;
            top: -50%; right: -50%;
            width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: pulse 4s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }
        .share-avatar {
            width: 80px; height: 80px;
            border-radius: 50%;
            border: 4px solid white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .share-badge {
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            display: inline-block;
            margin: 8px;
        }
        
        /* è¯„ä»·å¡ç‰‡å†…å®¹æˆªæ–­ */
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-6">
    <div class="max-w-6xl mx-auto">
        <!-- ===================== å¯¼èˆªæ ï¼ˆå·²æ¢å¤åŸå§‹æ ·å¼ï¼Œä»…å°å­—æ”¹ä¸ºâ€œæŠ€èƒ½äº¤æ¢ Â· åŒèˆŸå…±å­¦â€ï¼‰===================== -->
        <nav class="glass-card p-4 mb-6 flex justify-between items-center" x-show="isAuthenticated">
            <div class="flex items-center space-x-4">
                <div class="w-10 h-10 rounded-full bg-gradient-to-r from-blue-500 to-blue-600 flex items-center justify-center text-white font-bold">çŸ¥</div>
                <div>
                    <h1 class="text-xl font-bold text-gray-800">çŸ¥èˆŸæŠ€èƒ½äº¤æ¢</h1>
                    <p class="text-sm text-gray-600">æŠ€èƒ½äº¤æ¢ Â· åŒèˆŸå…±å­¦</p>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <button @click="activeTab = 'buddies'" :class="activeTab === 'buddies' ? 'text-blue-600 font-medium' : 'text-gray-600'"><i class="fas fa-users mr-2"></i>å­¦ä¹ æ­å­</button>
                <button @click="activeTab = 'profile'" :class="activeTab === 'profile' ? 'text-blue-600 font-medium' : 'text-gray-600'"><i class="fas fa-user mr-2"></i>ä¸ªäººä¸­å¿ƒ</button>
                <button @click="activeTab = 'explore'" :class="activeTab === 'explore' ? 'text-blue-600 font-medium' : 'text-gray-600'"><i class="fas fa-search mr-2"></i>æŠ€èƒ½æ¢ç´¢</button>
                <button @click="activeTab = 'community'" :class="activeTab === 'community' ? 'text-blue-600 font-medium' : 'text-gray-600'"><i class="fas fa-users mr-2"></i>ç¤¾åŒºæ´»åŠ¨</button>
                <button @click="activeTab = 'moments'" :class="activeTab === 'moments' ? 'text-blue-600 font-medium' : 'text-gray-600'"><i class="fas fa-camera mr-2"></i>ç²¾å½©æ—¶åˆ»</button>
                <button @click="activeTab = 'messages'" :class="activeTab === 'messages' ? 'text-blue-600 font-medium' : 'text-gray-600'"><i class="fas fa-comments mr-2"></i>æ¶ˆæ¯<span x-show="unreadCount > 0" class="ml-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center"><span x-text="unreadCount"></span></span></button>
                <button @click="logout" class="text-gray-600 hover:text-red-600"><i class="fas fa-sign-out-alt mr-2"></i>é€€å‡º</button>
            </div>
        </nav>

        <!-- ===================== æœªç™»å½•çŠ¶æ€ï¼ˆå®Œå…¨ä¿ç•™åŸæ ·ï¼‰===================== -->
        <div x-show="!isAuthenticated" class="flex flex-col items-center justify-center min-h-[80vh]">
            <div class="glass-card w-full max-w-md p-8">
                <div class="text-center mb-8"><h1 class="text-2xl font-bold text-gray-800 mb-2">çŸ¥èˆŸæŠ€èƒ½äº¤æ¢å¹³å°</h1><p class="text-gray-600">åˆ†äº«æŠ€èƒ½ï¼Œå­¦ä¹ æ–°çŸ¥ - æ¯ä¸ªäººéƒ½æœ‰è‡ªå·±çš„ç‹¬ç‰¹ä»·å€¼</p></div>
                <div class="flex border-b mb-6">
                    <button @click="authMode = 'login'" :class="authMode === 'login' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-500'" class="flex-1 py-3 font-medium text-center">ç™»å½•</button>
                    <button @click="authMode = 'register'" :class="authMode === 'register' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-500'" class="flex-1 py-3 font-medium text-center">æ³¨å†Œ</button>
                </div>
                <!-- ç™»å½•è¡¨å• -->
                <div x-show="authMode === 'login'" x-transition>
                    <form @submit.prevent="handleLogin" class="space-y-4">
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“§ é‚®ç®±åœ°å€</label><input type="email" x-model="loginForm.email" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" placeholder="è¯·è¾“å…¥æ³¨å†Œé‚®ç®±" required></div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">ğŸ”‘ å¯†ç </label><input type="password" x-model="loginForm.password" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" placeholder="è¯·è¾“å…¥å¯†ç " required></div>
                        <button type="submit" :disabled="loading" class="w-full py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white font-medium rounded-lg hover:from-blue-600 hover:to-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed"><span x-show="!loading">ç™»å½•</span><span x-show="loading" class="flex items-center justify-center"><span class="loading-spinner mr-2"></span>ç™»å½•ä¸­...</span></button>
                    </form>
                </div>
                <!-- æ³¨å†Œè¡¨å• -->
                <div x-show="authMode === 'register'" x-transition>
                    <form @submit.prevent="handleRegister" class="space-y-4">
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“§ é‚®ç®±åœ°å€</label><input type="email" x-model="registerForm.email" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" placeholder="è¯·è¾“å…¥é‚®ç®±" required></div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">ğŸ”‘ å¯†ç </label><input type="password" x-model="registerForm.password" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" placeholder="è‡³å°‘6ä½å­—ç¬¦" required></div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">ğŸ‘¤ ç”¨æˆ·å</label><input type="text" x-model="registerForm.username" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" placeholder="ç»™è‡ªå·±èµ·ä¸ªæ˜µç§°" required></div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">ğŸŒŸ æˆ‘èƒ½åˆ†äº«çš„æŠ€èƒ½</label><textarea x-model="registerForm.teachSkills" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" placeholder="æˆ‘æ“…é•¿åˆ†äº«çš„æŠ€èƒ½ï¼ˆæœ€å¤š5é¡¹ï¼‰&#10;æ¯è¡Œä¸€é¡¹æŠ€èƒ½"></textarea></div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“š æˆ‘æƒ³å­¦ä¹ çš„æŠ€èƒ½</label><textarea x-model="registerForm.learnSkills" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" placeholder="æˆ‘æ„Ÿå…´è¶£çš„å­¦ä¹ æŠ€èƒ½ï¼ˆæœ€å¤š5é¡¹ï¼‰&#10;æ¯è¡Œä¸€é¡¹æŠ€èƒ½"></textarea></div>
                        <button type="submit" :disabled="loading" class="w-full py-3 bg-gradient-to-r from-green-500 to-green-600 text-white font-medium rounded-lg hover:from-green-600 hover:to-green-700 transition disabled:opacity-50 disabled:cursor-not-allowed"><span x-show="!loading">æ³¨å†Œ</span><span x-show="loading" class="flex items-center justify-center"><span class="loading-spinner mr-2"></span>æ³¨å†Œä¸­...</span></button>
                    </form>
                </div>
                <div class="mt-6 text-center"><p class="text-gray-600"><span x-show="authMode === 'login'">è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ</span><span x-show="authMode === 'register'">å·²æœ‰è´¦å·ï¼Ÿ</span><button @click="authMode = authMode === 'login' ? 'register' : 'login'" class="text-blue-600 hover:text-blue-800 font-medium ml-1"><span x-show="authMode === 'login'">ç«‹å³æ³¨å†Œ</span><span x-show="authMode === 'register'">ç«‹å³ç™»å½•</span></button></p></div>
            </div>
        </div>

        <!-- ===================== å·²ç™»å½•çŠ¶æ€ ===================== -->
        <div x-show="isAuthenticated" x-transition>
            
            <!-- ===================== ä¸ªäººä¸­å¿ƒï¼ˆä¿ç•™åŸæœ‰+æ–°å¢æˆ‘çš„æ­å­æ ‡ç­¾ï¼‰===================== -->
            <div x-show="activeTab === 'profile'" x-transition>
                <!-- å­æ ‡ç­¾å¯¼èˆª -->
                <div class="flex space-x-4 mb-6 border-b">
                    <button @click="profileSubTab = 'info'" :class="profileSubTab === 'info' ? 'border-b-2 border-blue-500 text-blue-600 font-medium' : 'text-gray-600'" class="pb-3 px-2">ä¸ªäººèµ„æ–™</button>
                    <button @click="profileSubTab = 'favorites'; loadFavorites()" :class="profileSubTab === 'favorites' ? 'border-b-2 border-blue-500 text-blue-600 font-medium' : 'text-gray-600'" class="pb-3 px-2"><i class="fas fa-star mr-1"></i>æˆ‘çš„æ”¶è—</button>
                    <!-- æ–°å¢ï¼šæˆ‘çš„è¯„ä»·æ ‡ç­¾ï¼ˆä¿ç•™ä¸å˜ï¼‰ -->
                    <button @click="profileSubTab = 'reviews'; loadMyReviews()" :class="profileSubTab === 'reviews' ? 'border-b-2 border-blue-500 text-blue-600 font-medium' : 'text-gray-600'" class="pb-3 px-2"><i class="fas fa-thumbs-up mr-1"></i>æˆ‘çš„è¯„ä»·</button>
                    <!-- æ–°å¢ï¼šæˆ‘çš„æ­å­æ ‡ç­¾ -->
                    <button @click="profileSubTab = 'myBuddies'" :class="profileSubTab === 'myBuddies' ? 'border-b-2 border-blue-500 text-blue-600 font-medium' : 'text-gray-600'" class="pb-3 px-2"><i class="fas fa-user-friends mr-1"></i>æˆ‘çš„æ­å­</button>
                </div>

                <!-- ä¸ªäººèµ„æ–™å­é¡µé¢ï¼ˆä¿ç•™åŸæœ‰+æ–°å¢è¯„åˆ†å±•ç¤ºï¼‰ -->
                <div x-show="profileSubTab === 'info'">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- å·¦ä¾§ï¼šç”¨æˆ·ä¿¡æ¯ï¼ˆä¿ç•™åŸæœ‰+æ–°å¢ä¿¡èª‰å¾½ç« ï¼‰ -->
                        <div class="glass-card p-6">
                            <div class="flex items-center mb-6">
                                <template x-if="userProfile.avatar_url">
                                    <img :src="userProfile.avatar_url" class="w-16 h-16 rounded-full object-cover" alt="avatar">
                                </template>
                                <template x-else>
                                    <div class="w-16 h-16 rounded-full bg-gradient-to-r from-blue-500 to-blue-600 flex items-center justify-center text-white text-2xl font-bold">
                                        <span x-text="userProfile.username ? userProfile.username.charAt(0) : '?'"></span>
                                    </div>
                                </template>
                                <div class="ml-4">
                                    <div class="flex items-center gap-2">
                                        <h2 class="text-xl font-bold text-gray-800" x-text="userProfile.username || 'ç”¨æˆ·'"></h2>
                                        <!-- æ–°å¢ï¼šä¿¡èª‰å¾½ç«  -->
                                        <span x-show="userReviewStats.overall_rating >= 4.5" class="trust-badge"><i class="fas fa-crown mr-1"></i>ç™½é‡‘</span>
                                        <span x-show="userReviewStats.overall_rating >= 4.0 && userReviewStats.overall_rating < 4.5" class="trust-badge gold"><i class="fas fa-medal mr-1"></i>é‡‘ç‰Œ</span>
                                        <span x-show="userReviewStats.overall_rating >= 3.5 && userReviewStats.overall_rating < 4.0" class="trust-badge silver"><i class="fas fa-award mr-1"></i>é“¶ç‰Œ</span>
                                    </div>
                                    <p class="text-gray-600" x-text="userProfile.email"></p>
                                    <!-- æ–°å¢ï¼šè¯„åˆ†å±•ç¤º -->
                                    <div class="flex items-center mt-2" x-show="userReviewStats.total_reviews > 0">
                                        <div class="flex text-yellow-400 text-sm">
                                            <template x-for="i in 5">
                                                <i :class="i <= Math.round(userReviewStats.overall_rating) ? 'fas fa-star' : 'far fa-star'"></i>
                                            </template>
                                        </div>
                                        <span class="ml-2 text-sm text-gray-600" x-text="userReviewStats.overall_rating.toFixed(1) + 'åˆ† (' + userReviewStats.total_reviews + 'æ¡)'"></span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- æ–°å¢ï¼šè¯¦ç»†è¯„åˆ† -->
                            <div x-show="userReviewStats.total_reviews > 0" class="mb-4 p-4 bg-gray-50 rounded-lg">
                                <h4 class="font-medium text-gray-700 mb-3 text-sm">æŠ€èƒ½äº¤æ¢è¯„åˆ†</h4>
                                <div class="space-y-2 text-xs">
                                    <div class="flex justify-between items-center"><span>æŠ€èƒ½æ°´å¹³</span>
                                        <div class="flex text-yellow-400">
                                            <template x-for="i in 5"><i :class="i <= Math.round(userReviewStats.avg_skill_level) ? 'fas fa-star' : 'far fa-star'"></i></template>
                                        </div>
                                    </div>
                                    <div class="flex justify-between items-center"><span>æ•™å­¦æ€åº¦</span>
                                        <div class="flex text-yellow-400">
                                            <template x-for="i in 5"><i :class="i <= Math.round(userReviewStats.avg_teaching_attitude) ? 'fas fa-star' : 'far fa-star'"></i></template>
                                        </div>
                                    </div>
                                    <div class="flex justify-between items-center"><span>å®ˆæ—¶ç¨‹åº¦</span>
                                        <div class="flex text-yellow-400">
                                            <template x-for="i in 5"><i :class="i <= Math.round(userReviewStats.avg_punctuality) ? 'fas fa-star' : 'far fa-star'"></i></template>
                                        </div>
                                    </div>
                                    <div class="flex justify-between items-center"><span>æ²Ÿé€šèƒ½åŠ›</span>
                                        <div class="flex text-yellow-400">
                                            <template x-for="i in 5"><i :class="i <= Math.round(userReviewStats.avg_communication) ? 'fas fa-star' : 'far fa-star'"></i></template>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-3 pt-3 border-t">
                                    <span class="text-green-600 font-medium" x-text="userReviewStats.positive_rate + '%'"></span>
                                    <span class="text-gray-500 text-xs"> å¥½è¯„ç‡</span>
                                </div>
                            </div>

                            <!-- åŸæœ‰æŠ€èƒ½ä¿¡æ¯ï¼ˆå®Œå…¨ä¿ç•™ï¼‰ -->
                            <div class="space-y-4">
                                <div><h3 class="font-medium text-gray-700 mb-2">ğŸŒŸ æˆ‘èƒ½åˆ†äº«</h3><div><span x-show="userProfile.teach_skill" class="skill-tag teach" x-text="userProfile.teach_skill"></span><span x-show="!userProfile.teach_skill" class="text-gray-500 text-sm">æœªè®¾ç½®</span></div></div>
                                <div><h3 class="font-medium text-gray-700 mb-2">ğŸ“š æˆ‘æƒ³å­¦ä¹ </h3><div><span x-show="userProfile.learn_skill" class="skill-tag learn" x-text="userProfile.learn_skill"></span><span x-show="!userProfile.learn_skill" class="text-gray-500 text-sm">æœªè®¾ç½®</span></div></div>
                                <div><h3 class="font-medium text-gray-700 mb-2">ğŸ“ æ‰€åœ¨åŸå¸‚</h3><div><span x-show="userProfile.city" class="skill-tag" x-text="userProfile.city"></span><span x-show="!userProfile.city" class="text-gray-500 text-sm">æœªè®¾ç½®</span></div></div>
                                <div><h3 class="font-medium text-gray-700 mb-2">ğŸ“ ä¸ªäººç®€ä»‹</h3><p x-show="userProfile.bio" class="text-gray-600 text-sm" x-text="userProfile.bio"></p><p x-show="!userProfile.bio" class="text-gray-500 text-sm">æœªè®¾ç½®</p></div>
                            </div>
                            <button @click="showEditModal = true" class="mt-6 w-full py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white font-medium rounded-lg hover:from-blue-600 hover:to-blue-700 transition"><i class="fas fa-edit mr-2"></i>ç¼–è¾‘èµ„æ–™</button>
                        </div>
                        
                        <!-- ä¸­é—´ï¼šæŠ€èƒ½åŒ¹é…ï¼ˆä¿ç•™åŸæœ‰+æ–°å¢è¯„åˆ†+åˆ†äº«æŒ‰é’®ï¼‰ -->
                        <div class="glass-card p-6 md:col-span-2">
                            <h2 class="text-xl font-bold text-gray-800 mb-6">ğŸ¯ æ¨èåŒ¹é…</h2>
                            <div x-show="matches.length === 0" class="text-center py-8"><i class="fas fa-users text-gray-300 text-4xl mb-4"></i><p class="text-gray-500">æš‚æ— åŒ¹é…ç”¨æˆ·</p><p class="text-gray-400 text-sm mt-2">è¯·å®Œå–„æ‚¨çš„æŠ€èƒ½ä¿¡æ¯ä»¥è·å¾—æ›´ç²¾å‡†çš„åŒ¹é…</p></div>
                            <div class="space-y-4" x-show="matches.length > 0">
                                <template x-for="match in matches" :key="match.id">
                                    <div class="border border-gray-200 rounded-lg p-4 hover:border-blue-300 transition">
                                        <div class="flex justify-between items-start mb-3">
                                            <div class="flex items-center gap-3">
                                                <template x-if="match.avatar_url">
                                                    <img :src="match.avatar_url" class="w-12 h-12 rounded-full object-cover">
                                                </template>
                                                <template x-else>
                                                    <div class="w-12 h-12 rounded-full bg-gradient-to-r from-blue-500 to-blue-600 flex items-center justify-center text-white font-bold" x-text="match.username.charAt(0)"></div>
                                                </template>
                                                <div>
                                                    <div class="flex items-center gap-2">
                                                        <h3 class="font-bold text-gray-800" x-text="match.username"></h3>
                                                        <!-- æ–°å¢ï¼šä¿¡èª‰å¾½ç«  -->
                                                        <span x-show="match.overall_rating >= 4.5" class="trust-badge text-xs"><i class="fas fa-crown"></i></span>
                                                    </div>
                                                    <div class="flex items-center text-sm text-gray-500">
                                                        <span x-show="match.overall_rating > 0" class="text-yellow-500 mr-2"><i class="fas fa-star"></i> <span x-text="match.overall_rating.toFixed(1)"></span></span>
                                                        <span x-show="match.city"><i class="fas fa-map-marker-alt mr-1"></i><span x-text="match.city"></span></span>
                                                    </div>
                                                </div>
                                            </div>
                                            <span :class="{'match-high': match.matchScore >= 80, 'match-medium': match.matchScore >= 50 && match.matchScore < 80, 'match-low': match.matchScore < 50}" class="match-badge">åŒ¹é…åº¦: <span x-text="match.matchScore"></span>%</span>
                                        </div>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                            <div><h4 class="font-medium text-gray-700 text-sm mb-2">èƒ½åˆ†äº«ï¼š</h4><span class="skill-tag teach" x-text="match.teach_skill || 'æœªè®¾ç½®'"></span></div>
                                            <div><h4 class="font-medium text-gray-700 text-sm mb-2">æƒ³å­¦ä¹ ï¼š</h4><span class="skill-tag learn" x-text="match.learn_skill || 'æœªè®¾ç½®'"></span></div>
                                        </div>
                                        <div class="flex space-x-3">
                                            <button @click="sendMessage(match.id, match.username)" class="flex-1 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white font-medium rounded-lg hover:from-blue-600 hover:to-blue-700 transition text-sm"><i class="fas fa-comment mr-2"></i>å‘é€æ¶ˆæ¯</button>
                                            <button @click="viewProfile(match.id)" class="flex-1 py-2 border border-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-50 transition text-sm"><i class="fas fa-eye mr-2"></i>æŸ¥çœ‹èµ„æ–™</button>
                                            <!-- æ–°å¢ï¼šåˆ†äº«åŒ¹é…æŒ‰é’® -->
                                            <button @click="openMatchShareModal(match)" class="py-2 px-4 bg-gradient-to-r from-pink-500 to-purple-600 text-white rounded-lg hover:from-pink-600 hover:to-purple-700 transition text-sm" title="åˆ†äº«åŒ¹é…"><i class="fas fa-share-alt"></i></button>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æˆ‘çš„æ”¶è—ï¼ˆå®Œå…¨ä¿ç•™åŸæœ‰ï¼‰ -->
                <div x-show="profileSubTab === 'favorites'" x-transition>
                    <div class="glass-card p-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-6"><i class="fas fa-star text-yellow-400 mr-2"></i>æˆ‘æ”¶è—çš„æŠ€èƒ½</h2>
                        <div x-show="favoriteSkills.length === 0" class="text-center py-12">
                            <i class="far fa-star text-gray-300 text-4xl mb-4"></i>
                            <p class="text-gray-500">æš‚æ— æ”¶è—çš„æŠ€èƒ½</p>
                            <p class="text-gray-400 text-sm mt-2">åœ¨æŠ€èƒ½æ¢ç´¢é¡µé¢ç‚¹å‡»æ˜Ÿæ˜Ÿæ”¶è—ä½ æ„Ÿå…´è¶£çš„æŠ€èƒ½</p>
                            <button @click="activeTab = 'explore'" class="mt-4 px-6 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white font-medium rounded-lg hover:from-blue-600 hover:to-blue-700 transition"><i class="fas fa-search mr-2"></i>æ¢ç´¢æŠ€èƒ½</button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" x-show="favoriteSkills.length > 0">
                            <template x-for="skill in favoriteSkills" :key="skill.id">
                                <div class="border border-gray-200 rounded-lg p-5 hover:shadow-lg transition">
                                    <div class="flex justify-between items-start mb-4">
                                        <div>
                                            <h3 class="font-bold text-gray-800" x-text="skill.title"></h3>
                                            <p class="text-gray-600 text-sm" x-text="skill.author"></p>
                                        </div>
                                        <span :class="{
                                            'bg-blue-100 text-blue-800': skill.category === 'ç¼–ç¨‹å¼€å‘',
                                            'bg-purple-100 text-purple-800': skill.category === 'è®¾è®¡åˆ›æ„',
                                            'bg-orange-100 text-orange-800': skill.category === 'ç”Ÿæ´»æŠ€èƒ½',
                                            'bg-green-100 text-green-800': skill.category === 'è¯­è¨€å­¦ä¹ ',
                                            'bg-pink-100 text-pink-800': skill.category === 'éŸ³ä¹è‰ºæœ¯',
                                            'bg-red-100 text-red-800': skill.category === 'è¿åŠ¨å¥èº«',
                                            'bg-yellow-100 text-yellow-800': skill.category === 'å•†ä¸šæŠ€èƒ½',
                                            'bg-indigo-100 text-indigo-800': skill.category === 'å­¦æœ¯è¾…å¯¼',
                                            'bg-gray-100 text-gray-800': skill.category === 'å…¶ä»–'
                                        }" class="px-3 py-1 rounded-full text-xs font-medium" x-text="skill.category"></span>
                                    </div>
                                    <p class="text-gray-600 text-sm mb-4" x-text="skill.description"></p>
                                    <div class="mb-4">
                                        <template x-for="tag in skill.tags" :key="tag">
                                            <span class="skill-tag" x-text="tag"></span>
                                        </template>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <div class="text-left">
                                            <span class="text-gray-500 text-sm block"><i class="far fa-clock mr-1"></i><span x-text="formatDate(skill.created_at)"></span></span>
                                            <span x-show="skill.city" class="text-gray-500 text-sm"><i class="fas fa-map-marker-alt mr-1"></i><span x-text="skill.city"></span></span>
                                        </div>
                                        <div class="flex space-x-2">
                                            <button @click="toggleFavorite(skill)" class="text-yellow-400 hover:text-yellow-500 transition" title="å–æ¶ˆæ”¶è—"><i class="fas fa-star text-xl"></i></button>
                                            <button @click="contactSkillOwner(skill)" class="px-4 py-2 bg-gradient-to-r from-green-500 to-green-600 text-white text-sm font-medium rounded-lg hover:from-green-600 hover:to-green-700 transition">è”ç³»å­¦ä¹ </button>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>

                <!-- æˆ‘çš„è¯„ä»·å­é¡µé¢ï¼ˆä¿ç•™ä¸å˜ï¼Œç”¨äºè‡ªå·±æŸ¥çœ‹æ”¶åˆ°çš„è¯„ä»·ï¼‰ -->
                <div x-show="profileSubTab === 'reviews'" x-transition>
                    <div class="glass-card p-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-6"><i class="fas fa-thumbs-up text-blue-500 mr-2"></i>æˆ‘æ”¶åˆ°çš„è¯„ä»·</h2>
                        <div x-show="myReviews.length === 0" class="text-center py-12">
                            <i class="far fa-comment-dots text-gray-300 text-4xl mb-4"></i>
                            <p class="text-gray-500">è¿˜æ²¡æœ‰æ”¶åˆ°è¯„ä»·</p>
                            <p class="text-gray-400 text-sm mt-2">ç§¯æå‚ä¸æŠ€èƒ½äº¤æ¢ï¼Œè·å¾—å¥½è¯„å§ï¼</p>
                        </div>
                        <div class="space-y-4" x-show="myReviews.length > 0">
                            <template x-for="review in myReviews" :key="review.id">
                                <div class="border border-gray-200 rounded-lg p-4">
                                    <div class="flex justify-between items-start mb-3">
                                        <div class="flex items-center gap-3">
                                            <template x-if="!review.is_anonymous && review.reviewer_avatar">
                                                <img :src="review.reviewer_avatar" class="w-10 h-10 rounded-full object-cover">
                                            </template>
                                            <template x-else>
                                                <div class="w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center text-white"><i class="fas fa-user"></i></div>
                                            </template>
                                            <div>
                                                <p class="font-medium text-gray-800" x-text="review.is_anonymous ? 'åŒ¿åç”¨æˆ·' : review.reviewer_name"></p>
                                                <p class="text-xs text-gray-500" x-text="formatDate(review.created_at)"></p>
                                            </div>
                                        </div>
                                        <div class="flex text-yellow-400 text-sm">
                                            <template x-for="i in 5">
                                                <i :class="i <= review.overall_rating ? 'fas fa-star' : 'far fa-star'"></i>
                                            </template>
                                        </div>
                                    </div>
                                    <p class="text-gray-700 text-sm mb-3" x-text="review.content || 'ç”¨æˆ·æœªç•™ä¸‹æ–‡å­—è¯„ä»·'"></p>
                                    <div class="flex flex-wrap gap-2">
                                        <template x-for="tag in review.tags" :key="tag">
                                            <span class="px-3 py-1 bg-blue-50 text-blue-600 rounded-full text-xs" x-text="tag"></span>
                                        </template>
                                    </div>
                                    <div class="mt-3 pt-3 border-t text-xs text-gray-500">
                                        è¯„ä»·åœºæ™¯ï¼š<span x-text="review.context_type === 'skill_exchange' ? 'æŠ€èƒ½äº¤æ¢' : review.context_type === 'event' ? 'ç¤¾åŒºæ´»åŠ¨' : 'è§†é¢‘æ•™å®¤'"></span>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>

                <!-- æˆ‘çš„æ­å­é¡µé¢ï¼ˆå±•ç¤ºæ”¶è—çš„æ­å­å¸–å­ï¼‰ -->
                <div x-show="profileSubTab === 'myBuddies'" x-transition>
                    <div class="glass-card p-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-6"><i class="fas fa-star text-yellow-400 mr-2"></i>æˆ‘æ”¶è—çš„æ­å­</h2>
                        <div x-show="savedBuddiesList.length === 0" class="text-center py-12">
                            <i class="far fa-star text-gray-300 text-4xl mb-4"></i>
                            <p class="text-gray-500">æš‚æ— æ”¶è—çš„æ­å­</p>
                            <p class="text-gray-400 text-sm mt-2">åœ¨â€œå­¦ä¹ æ­å­â€é¡µé¢ç‚¹å‡»æ˜Ÿæ˜Ÿæ”¶è—ä½ æ„Ÿå…´è¶£çš„æ­å­</p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" x-show="savedBuddiesList.length > 0">
                            <template x-for="buddy in savedBuddiesList" :key="buddy.id">
                                <div class="border border-gray-200 rounded-lg p-5 hover:shadow-lg transition">
                                    <div class="flex items-center gap-3 mb-3">
                                        <template x-if="buddy.avatar_url">
                                            <img :src="buddy.avatar_url" class="w-10 h-10 rounded-full object-cover">
                                        </template>
                                        <template x-else>
                                            <div class="w-10 h-10 rounded-full bg-gradient-to-r from-blue-500 to-blue-600 flex items-center justify-center text-white font-bold" x-text="buddy.username?.charAt(0) || '?'"></div>
                                        </template>
                                        <div>
                                            <h3 class="font-bold text-gray-800" x-text="buddy.username"></h3>
                                            <p class="text-xs text-gray-500" x-text="formatTimeAgo(buddy.created_at)"></p>
                                        </div>
                                    </div>
                                    <div class="mb-2">
                                        <span class="inline-block px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm mr-2" x-text="buddy.goal"></span>
                                        <span class="inline-block px-3 py-1 bg-gray-100 text-gray-800 rounded-full text-sm" x-text="buddy.mode"></span>
                                    </div>
                                    <p class="text-gray-600 text-sm mb-2"><i class="far fa-clock mr-1"></i><span x-text="buddy.time_slot"></span></p>
                                    <p x-show="buddy.city" class="text-gray-500 text-sm mb-4"><i class="fas fa-map-marker-alt mr-1"></i><span x-text="buddy.city"></span></p>
                                    <div class="flex gap-2">
                                        <button @click="contactBuddy(buddy)" class="flex-1 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg text-sm">è”ç³»æ­å­</button>
                                        <button @click="toggleSaveBuddy(buddy)" class="px-3 py-2 border rounded-lg text-gray-600" title="å–æ¶ˆæ”¶è—"><i class="fas fa-star text-yellow-500"></i></button>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ===================== æŠ€èƒ½æ¢ç´¢ï¼ˆå®Œå…¨ä¿ç•™åŸæœ‰+æ–°å¢è¯„åˆ†å±•ç¤ºï¼‰===================== -->
            <div x-show="activeTab === 'explore'" x-transition>
                <div class="glass-card p-6">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                        <div><h2 class="text-xl font-bold text-gray-800 mb-2">ğŸ” æŠ€èƒ½æ¢ç´¢</h2><p class="text-gray-600">å‘ç°ä½ æ„Ÿå…´è¶£çš„æŠ€èƒ½ï¼Œæˆ–åˆ†äº«ä½ çš„ä¸“é•¿</p></div>
                        <button @click="openSkillModal()" class="px-5 py-3 bg-gradient-to-r from-green-500 to-green-600 text-white font-medium rounded-lg hover:from-green-600 hover:to-green-700 transition-all duration-300 shadow-md hover:shadow-lg flex items-center"><i class="fas fa-plus mr-2"></i>å‘å¸ƒæŠ€èƒ½</button>
                    </div>
                    <div class="mb-6">
                        <div class="flex flex-col md:flex-row md:items-center space-y-4 md:space-y-0 md:space-x-4">
                            <div class="flex-1"><input type="text" x-model="searchQuery" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" placeholder="æœç´¢æŠ€èƒ½æˆ–ç”¨æˆ·..."></div>
                            <div class="flex space-x-4">
                                <select x-model="skillFilter" class="px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"><option value="">å…¨éƒ¨æŠ€èƒ½</option><option value="teach">æˆ‘èƒ½åˆ†äº«çš„</option><option value="learn">æˆ‘æƒ³å­¦ä¹ çš„</option></select>
                                <button @click="toggleSameCityFilter()" :class="showSameCityOnly ? 'bg-blue-600 text-white border-blue-600 hover:bg-blue-700' : 'border-gray-300 text-gray-700 hover:bg-gray-50'" class="px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition flex items-center"><i class="fas fa-map-marker-alt mr-2"></i> <span x-text="showSameCityOnly ? 'åŒåŸâœ“' : 'åŒåŸ'"></span></button>
                                <button @click="searchSkills" class="px-6 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white font-medium rounded-lg hover:from-blue-600 hover:to-blue-700 transition"><i class="fas fa-search mr-2"></i>æœç´¢</button>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <template x-for="skill in filteredSkills" :key="skill.id">
                            <div class="border border-gray-200 rounded-lg p-5 hover:shadow-lg transition">
                                <div class="flex justify-between items-start mb-4">
                                    <div>
                                        <h3 class="font-bold text-gray-800" x-text="skill.title"></h3>
                                        <div class="flex items-center gap-2 mt-1">
                                            <p class="text-gray-600 text-sm" x-text="skill.author"></p>
                                            <!-- æ–°å¢ï¼šæ˜¾ç¤ºä½œè€…è¯„åˆ† -->
                                            <span x-show="skill.user_rating > 0" class="text-yellow-500 text-xs"><i class="fas fa-star"></i> <span x-text="skill.user_rating.toFixed(1)"></span></span>
                                        </div>
                                    </div>
                                    <span :class="{
                                        'bg-blue-100 text-blue-800': skill.category === 'ç¼–ç¨‹å¼€å‘',
                                        'bg-purple-100 text-purple-800': skill.category === 'è®¾è®¡åˆ›æ„',
                                        'bg-orange-100 text-orange-800': skill.category === 'ç”Ÿæ´»æŠ€èƒ½',
                                        'bg-green-100 text-green-800': skill.category === 'è¯­è¨€å­¦ä¹ ',
                                        'bg-pink-100 text-pink-800': skill.category === 'éŸ³ä¹è‰ºæœ¯',
                                        'bg-red-100 text-red-800': skill.category === 'è¿åŠ¨å¥èº«',
                                        'bg-yellow-100 text-yellow-800': skill.category === 'å•†ä¸šæŠ€èƒ½',
                                        'bg-indigo-100 text-indigo-800': skill.category === 'å­¦æœ¯è¾…å¯¼',
                                        'bg-gray-100 text-gray-800': skill.category === 'å…¶ä»–'
                                    }" class="px-3 py-1 rounded-full text-xs font-medium" x-text="skill.category"></span>
                                </div>
                                <p class="text-gray-600 text-sm mb-4" x-text="skill.description"></p>
                                <div class="mb-4">
                                    <template x-for="tag in skill.tags" :key="tag">
                                        <span class="skill-tag" x-text="tag"></span>
                                    </template>
                                </div>
                                <div class="flex justify-between items-center">
                                    <div class="text-left">
                                        <span class="text-gray-500 text-sm block"><i class="far fa-clock mr-1"></i><span x-text="formatDate(skill.created_at)"></span></span>
                                        <span x-show="skill.city" class="text-gray-500 text-sm"><i class="fas fa-map-marker-alt mr-1"></i><span x-text="skill.city"></span></span>
                                    </div>
                                    <div class="flex space-x-2">
                                        <button @click="toggleFavorite(skill)" class="text-yellow-400 hover:text-yellow-500 transition" :title="isFavorite(skill.id) ? 'å–æ¶ˆæ”¶è—' : 'æ”¶è—æŠ€èƒ½'">
                                            <i :class="isFavorite(skill.id) ? 'fas fa-star' : 'far fa-star'" class="text-xl"></i>
                                        </button>
                                        <button @click="contactSkillOwner(skill)" class="px-4 py-2 bg-gradient-to-r from-green-500 to-green-600 text-white text-sm font-medium rounded-lg hover:from-green-600 hover:to-green-700 transition">è”ç³»å­¦ä¹ </button>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                    <div x-show="filteredSkills.length === 0" class="text-center py-12"><i class="fas fa-search text-gray-300 text-4xl mb-4"></i><p class="text-gray-500" x-text="getEmptyStateMessage()"></p><button @click="resetFilters()" class="mt-4 px-6 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white font-medium rounded-lg hover:from-blue-600 hover:to-blue-700 transition">æ¸…é™¤ç­›é€‰æ¡ä»¶</button></div>
                </div>
            </div>

            <!-- ===================== ç¤¾åŒºæ´»åŠ¨ï¼ˆå®Œå…¨ä¿ç•™åŸæœ‰ï¼‰===================== -->
            <div x-show="activeTab === 'community'" x-transition>
                <div class="glass-card p-6 mb-6">
                    <div class="flex justify-between items-center">
                        <div><h2 class="text-xl font-bold text-gray-800">ç¤¾åŒºæ´»åŠ¨</h2><p class="text-gray-600">å‘ç°åŒåŸæŠ€èƒ½äº¤æµæ´»åŠ¨ï¼Œç›´æ¥è”ç³»å‘èµ·è€…</p></div>
                        <div class="flex space-x-2">
                            <button @click="communityView = 'myEvents'; loadMyEvents()" :class="communityView === 'myEvents' ? 'bg-blue-100 text-blue-600 border-blue-300' : 'bg-gray-100 text-gray-700 border-gray-300'" class="px-4 py-2 border rounded-lg text-sm font-medium transition"><i class="fas fa-user mr-2"></i>æˆ‘çš„æ´»åŠ¨</button>
                            <button @click="communityView = 'allEvents'; loadCommunityEvents()" :class="communityView === 'allEvents' ? 'bg-blue-100 text-blue-600 border-blue-300' : 'bg-gray-100 text-gray-700 border-gray-300'" class="px-4 py-2 border rounded-lg text-sm font-medium transition"><i class="fas fa-users mr-2"></i>å…¨éƒ¨æ´»åŠ¨</button>
                            <button @click="showCreateEventModal = true" class="px-4 py-2 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-lg hover:from-green-600 hover:to-green-700 transition"><i class="fas fa-plus mr-2"></i>å‘èµ·æ´»åŠ¨</button>
                        </div>
                    </div>
                    <div class="mt-4 flex flex-wrap gap-3">
                        <select x-model="communityCityFilter" @change="filterCommunityEvents" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"><option value="">æ‰€æœ‰åŸå¸‚</option><option value="åŒ—äº¬">åŒ—äº¬</option><option value="ä¸Šæµ·">ä¸Šæµ·</option><option value="å¹¿å·">å¹¿å·</option><option value="æ·±åœ³">æ·±åœ³</option><option value="æ­å·">æ­å·</option><option value="æˆéƒ½">æˆéƒ½</option><option value="é‡åº†">é‡åº†</option><option value="æ­¦æ±‰">æ­¦æ±‰</option><option value="å—äº¬">å—äº¬</option><option value="è¥¿å®‰">è¥¿å®‰</option><option value="å¤©æ´¥">å¤©æ´¥</option><option value="è‹å·">è‹å·</option><option value="éƒ‘å·">éƒ‘å·</option><option value="é•¿æ²™">é•¿æ²™</option><option value="ä¸œè">ä¸œè</option><option value="å®æ³¢">å®æ³¢</option><option value="é’å²›">é’å²›</option><option value="æ²ˆé˜³">æ²ˆé˜³</option><option value="åˆè‚¥">åˆè‚¥</option><option value="ä½›å±±">ä½›å±±</option><option value="æµå—">æµå—</option><option value="æ— é”¡">æ— é”¡</option><option value="å¦é—¨">å¦é—¨</option><option value="æ˜†æ˜">æ˜†æ˜</option><option value="ç¦å·">ç¦å·</option><option value="å¤§è¿">å¤§è¿</option><option value="å“ˆå°”æ»¨">å“ˆå°”æ»¨</option><option value="çŸ³å®¶åº„">çŸ³å®¶åº„</option><option value="å—æ˜Œ">å—æ˜Œ</option></select>
                        <select x-model="communityTypeFilter" @change="filterCommunityEvents" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"><option value="">æ‰€æœ‰ç±»å‹</option><option value="æ²™é¾™">æŠ€èƒ½æ²™é¾™</option><option value="å·¥ä½œåŠ">æŠ€èƒ½å·¥ä½œåŠ</option><option value="äº¤æ¢ä¼š">æŠ€èƒ½äº¤æ¢ä¼š</option><option value="ç»ƒä¹ ç»„">ç»ƒä¹ å°ç»„</option><option value="é¡¹ç›®ç»„">é¡¹ç›®åä½œ</option><option value="ç¤¾äº¤ä¼š">ç¤¾äº¤èšä¼š</option></select>
                        <select x-model="communityDateFilter" @change="filterCommunityEvents" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"><option value="all">æ‰€æœ‰æ—¶é—´</option><option value="today">ä»Šå¤©</option><option value="tomorrow">æ˜å¤©</option><option value="weekend">æœ¬å‘¨æœ«</option><option value="nextWeek">ä¸‹å‘¨</option></select>
                    </div>
                </div>
                <div x-show="communityView === 'allEvents' || communityView === 'myEvents'">
                    <div x-show="filteredCommunityEvents.length === 0" class="text-center py-12"><i class="fas fa-calendar-alt text-gray-300 text-4xl mb-4"></i><p class="text-gray-500" x-text="getCommunityEmptyMessage()"></p><button @click="showCreateEventModal = true" class="mt-4 px-6 py-3 bg-gradient-to-r from-green-500 to-green-600 text-white font-medium rounded-lg hover:from-green-600 hover:to-green-700 transition"><i class="fas fa-plus mr-2"></i>å‘èµ·ç¬¬ä¸€ä¸ªæ´»åŠ¨</button></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <template x-for="event in filteredCommunityEvents" :key="event.id">
                            <div class="glass-card p-5 hover:shadow-lg transition cursor-pointer" @click="showEventDetail(event.id)">
                                <div class="flex justify-between items-start mb-3">
                                    <span :class="{'bg-blue-100 text-blue-800': event.event_type === 'æ²™é¾™', 'bg-green-100 text-green-800': event.event_type === 'å·¥ä½œåŠ', 'bg-purple-100 text-purple-800': event.event_type === 'äº¤æ¢ä¼š', 'bg-orange-100 text-orange-800': event.event_type === 'ç»ƒä¹ ç»„', 'bg-pink-100 text-pink-800': event.event_type === 'é¡¹ç›®ç»„', 'bg-teal-100 text-teal-800': event.event_type === 'ç¤¾äº¤ä¼š'}" class="px-3 py-1 rounded-full text-xs font-medium"><span x-text="event.event_type"></span></span>
                                </div>
                                <h3 class="font-bold text-gray-800 text-lg mb-2" x-text="event.title"></h3>
                                <div class="space-y-2 mb-4">
                                    <div class="flex items-center text-gray-600"><i class="fas fa-calendar-alt w-5 mr-2"></i><span class="text-sm" x-text="formatEventDate(event.event_date)"></span><span class="mx-2">|</span><span class="text-sm" x-text="event.start_time + '-' + event.end_time"></span></div>
                                    <div class="flex items-center text-gray-600"><i class="fas fa-map-marker-alt w-5 mr-2"></i><span class="text-sm" x-text="event.city + (event.address ? ' Â· ' + event.address : '')"></span></div>
                                </div>
                                <div class="flex items-center border-t pt-3">
                                    <template x-if="event.organizer_avatar">
                                        <img :src="event.organizer_avatar" class="w-8 h-8 rounded-full object-cover mr-2" alt="avatar">
                                    </template>
                                    <template x-else>
                                        <div class="w-8 h-8 rounded-full bg-gradient-to-r from-blue-500 to-blue-600 flex items-center justify-center text-white text-xs font-bold mr-2"><span x-text="getUserInitial(event.organizer_name)"></span></div>
                                    </template>
                                    <div><p class="text-sm font-medium text-gray-700" x-text="event.organizer_name"></p><p class="text-xs text-gray-500" x-text="formatTimeAgo(event.created_at)"></p></div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
                <div x-show="communityView === 'eventDetail'" x-transition>
                    <div class="glass-card p-6 mb-6">
                        <div class="flex justify-between items-start">
                            <div>
                                <button @click="communityView = 'allEvents'; loadCommunityEvents()" class="text-gray-600 hover:text-gray-800 mb-4"><i class="fas fa-arrow-left mr-2"></i>è¿”å›æ´»åŠ¨åˆ—è¡¨</button>
                                <h2 class="text-2xl font-bold text-gray-800" x-text="currentEventDetail?.title"></h2>
                                <div class="flex items-center mt-2">
                                    <span :class="{'bg-blue-100 text-blue-800': currentEventDetail?.event_type === 'æ²™é¾™', 'bg-green-100 text-green-800': currentEventDetail?.event_type === 'å·¥ä½œåŠ'}" class="px-3 py-1 rounded-full text-sm font-medium mr-3"><span x-text="currentEventDetail?.event_type"></span></span>
                                    <span class="text-gray-600"><i class="fas fa-map-marker-alt mr-1"></i><span x-text="currentEventDetail?.city"></span></span>
                                </div>
                            </div>
                            <div class="flex space-x-3">
                                <button @click="sendMessageToOrganizer(currentEventDetail?.user_id, currentEventDetail?.organizer_name)" class="px-5 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white font-medium rounded-lg hover:from-blue-600 hover:to-green-700 transition"><i class="fas fa-comment mr-2"></i>è”ç³»å‘èµ·è€…</button>
                                <button x-show="currentEventDetail?.user_id === currentUser?.id" @click="editEvent(currentEventDetail?.id)" class="px-5 py-2 bg-yellow-100 text-yellow-700 font-medium rounded-lg border border-yellow-300"><i class="fas fa-edit mr-2"></i>ç¼–è¾‘æ´»åŠ¨</button>
                                <button @click="shareEvent(currentEventDetail?.id, currentEventDetail?.title)" class="px-4 py-2 border border-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-50 transition"><i class="fas fa-share-alt mr-2"></i>åˆ†äº«</button>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="glass-card p-6 md:col-span-2">
                            <h3 class="font-bold text-gray-800 mb-4">æ´»åŠ¨è¯¦æƒ…</h3>
                            <div class="prose max-w-none" x-html="formatEventDescription(currentEventDetail?.description)"></div>
                            <div class="mt-8 grid grid-cols-2 gap-4">
                                <div class="border border-gray-200 rounded-lg p-4"><div class="flex items-center text-gray-700 mb-2"><i class="fas fa-calendar-alt mr-3"></i><div><p class="font-medium">æ´»åŠ¨æ—¶é—´</p><p class="text-sm" x-text="formatEventDate(currentEventDetail?.event_date) + ' ' + currentEventDetail?.start_time + '-' + currentEventDetail?.end_time"></p></div></div></div>
                                <div class="border border-gray-200 rounded-lg p-4"><div class="flex items-center text-gray-700 mb-2"><i class="fas fa-map-marker-alt mr-3"></i><div><p class="font-medium">æ´»åŠ¨åœ°ç‚¹</p><p class="text-sm" x-text="currentEventDetail?.city + ' ' + currentEventDetail?.address"></p></div></div></div>
                                <div class="border border-gray-200 rounded-lg p-4"><div class="flex items-center text-gray-700 mb-2"><i class="fas fa-money-bill-wave mr-3"></i><div><p class="font-medium">è´¹ç”¨è¯´æ˜</p><p class="text-sm" x-text="currentEventDetail?.fee_info || 'å…è´¹'"></p></div></div></div>
                                <div x-show="currentEventDetail?.notes" class="border border-gray-200 rounded-lg p-4 col-span-2"><div class="flex items-start text-gray-700"><i class="fas fa-exclamation-triangle mr-3 mt-1"></i><div><p class="font-medium">æ³¨æ„äº‹é¡¹</p><p class="text-sm" x-text="currentEventDetail?.notes"></p></div></div></div>
                            </div>
                        </div>
                        <div class="space-y-6">
                            <div class="glass-card p-6">
                                <h3 class="font-bold text-gray-800 mb-4">æ´»åŠ¨å‘èµ·è€…</h3>
                                <div class="flex items-center">
                                    <template x-if="currentEventDetail?.organizer_avatar">
                                        <img :src="currentEventDetail.organizer_avatar" class="w-12 h-12 rounded-full object-cover mr-4" alt="avatar">
                                    </template>
                                    <template x-else>
                                        <div class="w-12 h-12 rounded-full bg-gradient-to-r from-blue-500 to-blue-600 flex items-center justify-center text-white text-lg font-bold mr-4"><span x-text="getUserInitial(currentEventDetail?.organizer_name)"></span></div>
                                    </template>
                                    <div><p class="font-medium text-gray-800" x-text="currentEventDetail?.organizer_name"></p><p class="text-sm text-gray-600">æ‰€åœ¨åŸå¸‚: <span x-text="currentEventDetail?.organizer_city || 'æœªè®¾ç½®'"></span></p><p class="text-sm text-gray-600">å‘èµ·è¿‡ <span x-text="currentEventDetail?.organizer_event_count || 0"></span> ä¸ªæ´»åŠ¨</p></div>
                                </div>
                                <button @click="sendMessageToOrganizer(currentEventDetail?.user_id, currentEventDetail?.organizer_name)" class="mt-4 w-full py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white font-medium rounded-lg hover:from-blue-600 hover:to-green-700 transition"><i class="fas fa-comment mr-2"></i>å‘é€æ¶ˆæ¯</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ===================== æ–°å¢ï¼šç²¾å½©æ—¶åˆ»ï¼ˆç¤¾äº¤åˆ†äº«å¢™ï¼‰===================== -->
            <div x-show="activeTab === 'moments'" x-transition>
                <div class="glass-card p-6 mb-6">
                    <div class="flex justify-between items-center">
                        <div>
                            <h2 class="text-xl font-bold text-gray-800">ğŸ“¸ ç²¾å½©æ—¶åˆ»</h2>
                            <p class="text-gray-600">åˆ†äº«æŠ€èƒ½äº¤æ¢çš„ç¾å¥½ç¬é—´ï¼Œæ¿€åŠ±æ›´å¤šäººåŠ å…¥</p>
                        </div>
                        <button @click="openCreateMomentModal()" class="px-5 py-3 bg-gradient-to-r from-pink-500 to-purple-600 text-white font-medium rounded-lg hover:from-pink-600 hover:to-purple-700 transition shadow-md flex items-center">
                            <i class="fas fa-camera mr-2"></i>åˆ†äº«æˆ‘çš„æ•…äº‹
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <template x-for="moment in moments" :key="moment.id">
                        <div class="glass-card overflow-hidden hover:shadow-xl transition">
                            <div class="relative aspect-video bg-gray-100">
                                <template x-if="moment.media_type === 'image'">
                                    <img :src="moment.media_url" class="w-full h-full object-cover" @click="openMomentDetail(moment)">
                                </template>
                                <template x-if="moment.media_type === 'video'">
                                    <video :src="moment.media_url" class="w-full h-full object-cover" controls></video>
                                </template>
                                <div class="absolute top-3 right-3 bg-black bg-opacity-50 text-white px-3 py-1 rounded-full text-sm">
                                    <i :class="moment.media_type === 'video' ? 'fas fa-video' : 'fas fa-image'" class="mr-1"></i>
                                    <span x-text="moment.media_type === 'video' ? 'è§†é¢‘' : 'å›¾ç‰‡'"></span>
                                </div>
                            </div>
                            <div class="p-5">
                                <div class="flex items-center gap-3 mb-3">
                                    <template x-if="moment.author_avatar">
                                        <img :src="moment.author_avatar" class="w-10 h-10 rounded-full object-cover">
                                    </template>
                                    <template x-else>
                                        <div class="w-10 h-10 rounded-full bg-gradient-to-r from-blue-500 to-blue-600 flex items-center justify-center text-white font-bold" x-text="moment.author_name.charAt(0)"></div>
                                    </template>
                                    <div>
                                        <p class="font-medium text-gray-800" x-text="moment.author_name"></p>
                                        <p class="text-xs text-gray-500" x-text="formatTimeAgo(moment.created_at)"></p>
                                    </div>
                                </div>
                                <h3 class="font-bold text-gray-800 mb-2" x-text="moment.title"></h3>
                                <p class="text-gray-600 text-sm mb-3 line-clamp-2" x-text="moment.description"></p>
                                <div class="flex items-center gap-2 mb-3 p-3 bg-gray-50 rounded-lg">
                                    <span class="text-sm text-gray-600">äº¤æ¢ï¼š</span>
                                    <span class="skill-tag teach text-xs" x-text="moment.skill_given"></span>
                                    <i class="fas fa-exchange-alt text-gray-400"></i>
                                    <span class="skill-tag learn text-xs" x-text="moment.skill_received"></span>
                                </div>
                                <div class="flex justify-between items-center pt-3 border-t">
                                    <div class="flex space-x-4">
                                        <button @click="likeMoment(moment)" class="text-gray-500 hover:text-red-500 transition flex items-center gap-1">
                                            <i :class="moment.is_liked ? 'fas fa-heart text-red-500' : 'far fa-heart'"></i>
                                            <span x-text="moment.likes_count"></span>
                                        </button>
                                        <button @click="openCommentModal(moment)" class="text-gray-500 hover:text-blue-500 transition flex items-center gap-1">
                                            <i class="far fa-comment"></i>
                                            <span x-text="moment.comments_count"></span>
                                        </button>
                                    </div>
                                    <button @click="shareMoment(moment)" class="text-gray-500 hover:text-green-500 transition"><i class="fas fa-share-alt"></i></button>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
                
                <div x-show="moments.length === 0" class="text-center py-12">
                    <i class="fas fa-camera-retro text-gray-300 text-5xl mb-4"></i>
                    <p class="text-gray-500">è¿˜æ²¡æœ‰ç²¾å½©æ—¶åˆ»</p>
                    <p class="text-gray-400 text-sm mt-2">æˆä¸ºç¬¬ä¸€ä¸ªåˆ†äº«æŠ€èƒ½äº¤æ¢æ•…äº‹çš„äººå§ï¼</p>
                </div>
            </div>

            <!-- ===================== æ¶ˆæ¯ä¸­å¿ƒï¼ˆåˆ é™¤æŒ‰é’®æ‚¬æµ®æ˜¾ç¤ºï¼‰===================== -->
            <div x-show="activeTab === 'messages'" x-transition>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- å·¦ä¾§å¯¹è¯åˆ—è¡¨ï¼šåˆ é™¤æŒ‰é’®æ‚¬æµ®æ˜¾ç¤º -->
                    <div class="glass-card p-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-6">ğŸ’¬ å¯¹è¯åˆ—è¡¨</h2>
                        <div class="mb-4"><input type="text" x-model="searchConversation" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" placeholder="æœç´¢å¯¹è¯..."></div>
                        <div class="space-y-2">
                            <template x-for="conversation in filteredConversations" :key="conversation.id">
                                <!-- å¯¹è¯æ¡ç›®ï¼šå¤–å±‚æ·»åŠ  group ç±»ç”¨äºæ‚¬æµ®æ§åˆ¶ -->
                                <div @click="selectConversation(conversation.id)" :class="{'border-blue-300 bg-blue-50': selectedConversationId === conversation.id, 'border-gray-200': selectedConversationId !== conversation.id}" class="group border rounded-lg p-3 flex items-center cursor-pointer hover:border-blue-300 transition relative">
                                    <!-- å¤´åƒå’Œå†…å®¹åŒºåŸŸ (flex-1) -->
                                    <div class="flex items-start flex-1 min-w-0">
                                        <template x-if="conversation.avatar_url">
                                            <img :src="conversation.avatar_url" class="w-10 h-10 rounded-full object-cover" alt="avatar">
                                        </template>
                                        <template x-else>
                                            <div :class="['w-10 h-10 rounded-full flex items-center justify-center text-white font-bold bg-gradient-to-r', conversation.avatarColor || 'from-blue-500 to-blue-600']"><span x-text="conversation.username.charAt(0)"></span></div>
                                        </template>
                                        <div class="ml-2 flex-1 min-w-0">
                                            <div class="flex justify-between items-start">
                                                <div>
                                                    <h3 class="font-bold text-gray-800 text-sm" x-text="conversation.username"></h3>
                                                    <p x-show="conversation.skillTitle" class="text-[10px] text-blue-600 bg-blue-50 px-1.5 py-0.5 rounded inline-block mt-0.5"><i class="fas fa-graduation-cap mr-0.5"></i><span x-text="conversation.skillTitle"></span></p>
                                                </div>
                                                <span x-show="conversation.unread > 0" class="bg-red-500 text-white text-[10px] rounded-full w-4 h-4 flex items-center justify-center"><span x-text="conversation.unread"></span></span>
                                            </div>
                                            <p class="text-gray-500 text-xs truncate max-w-full mt-0.5" x-text="conversation.lastMessage"></p>
                                            <div class="flex justify-between items-center mt-1"><span class="text-gray-400 text-[10px]" x-text="formatTime(conversation.timestamp)"></span><span x-show="conversation.skillId" class="text-blue-500 text-[10px]"><i class="fas fa-link"></i></span></div>
                                        </div>
                                    </div>
                                    <!-- åˆ é™¤æŒ‰é’®ï¼ˆé»˜è®¤éšè—ï¼Œæ‚¬æµ®æ˜¾ç¤ºï¼‰ -->
                                    <button @click.stop="deleteConversation(conversation.id, conversation.username)" class="w-8 h-8 rounded-full bg-gray-100 hover:bg-red-100 flex items-center justify-center ml-2 flex-shrink-0 opacity-0 group-hover:opacity-100 transition-opacity" title="åˆ é™¤å¯¹è¯">
                                        <i class="fas fa-times text-gray-500"></i>
                                    </button>
                                </div>
                            </template>
                        </div>
                        <div x-show="conversations.length === 0" class="text-center py-8"><i class="fas fa-comments text-gray-300 text-4xl mb-4"></i><p class="text-gray-500">æš‚æ— å¯¹è¯</p><p class="text-gray-400 text-sm mt-2">å»æŠ€èƒ½åŒ¹é…ä¸­è”ç³»æ–°çš„ä¼™ä¼´</p><button @click="activeTab = 'profile'" class="mt-4 px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white text-sm font-medium rounded-lg hover:from-blue-600 hover:to-blue-700 transition"><i class="fas fa-search mr-2"></i>æŸ¥æ‰¾ä¼™ä¼´</button></div>
                    </div>
                    <!-- å³ä¾§èŠå¤©çª—å£ï¼ˆä¿æŒä¸å˜ï¼‰ -->
                    <div class="glass-card p-6 md:col-span-2 flex flex-col">
                        <div x-show="selectedConversationId">
                            <div class="border-b pb-4 mb-4">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center">
                                        <template x-if="selectedConversation?.avatar_url">
                                            <img :src="selectedConversation.avatar_url" class="w-12 h-12 rounded-full object-cover" alt="avatar">
                                        </template>
                                        <template x-else>
                                            <div class="w-12 h-12 rounded-full bg-gradient-to-r from-blue-500 to-blue-600 flex items-center justify-center text-white font-bold"><span x-text="selectedConversation ? selectedConversation.username.charAt(0) : ''"></span></div>
                                        </template>
                                        <div class="ml-4"><h3 class="font-bold text-gray-800" x-text="selectedConversation ? selectedConversation.username : ''"></h3><p class="text-gray-600 text-sm">åœ¨çº¿</p></div>
                                    </div>
                                    <div class="flex items-center space-x-3">
                                        <!-- è¯„ä»·æŒ‰é’® -->
                                        <button @click="openReviewModalFromChat()" class="flex items-center px-4 py-2 bg-gradient-to-r from-yellow-500 to-orange-500 text-white text-sm font-medium rounded-lg hover:from-yellow-600 hover:to-orange-600 transition shadow" title="è¯„ä»·å¯¹æ–¹">
                                            <i class="fas fa-star mr-2"></i>è¯„ä»·
                                        </button>
                                        <!-- è§†é¢‘æ•™å®¤æŒ‰é’® -->
                                        <button @click="openVideoRoomModal" :disabled="!selectedConversation" :class="{ 'opacity-50 cursor-not-allowed': !selectedConversation }" class="flex items-center px-4 py-2 bg-gradient-to-r from-green-500 to-green-600 text-white text-sm font-medium rounded-lg hover:from-green-600 hover:to-green-700 transition shadow" title="åˆ›å»ºè§†é¢‘æ•™å®¤"><i class="fas fa-video mr-2"></i><span>è§†é¢‘æ•™å®¤</span></button>
                                        <!-- æ¸…ç©ºèŠå¤©è®°å½•æŒ‰é’® -->
                                        <button @click="confirmClearChat" class="px-3 py-2 text-sm bg-gray-100 rounded-lg" title="æ¸…ç©ºèŠå¤©è®°å½•">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                        <!-- å…³é—­å¯¹è¯æŒ‰é’® -->
                                        <button @click="selectedConversationId = null" class="text-gray-500 hover:text-gray-700 p-2" title="å…³é—­å¯¹è¯"><i class="fas fa-times text-xl"></i></button>
                                    </div>
                                </div>
                            </div>
                            <div x-ref="messageContainer" class="flex-1 overflow-y-auto mb-4 space-y-4" style="max-height: 400px;">
                                <template x-for="message in selectedConversationMessages" :key="message.id">
                                    <div :class="message.sender === 'me' ? 'flex justify-end' : 'flex justify-start'">
                                        <div :class="{'message-bubble message-sent': message.sender === 'me' && !message.failed, 'message-bubble message-failed': message.sender === 'me' && message.failed, 'message-bubble message-received': message.sender === 'other'}">
                                            <p class="text-sm break-words" x-text="message.content"></p>
                                            <p class="text-xs opacity-70 mt-1" x-text="formatTime(message.timestamp)"></p>
                                        </div>
                                    </div>
                                </template>
                            </div>
                            <div class="border-t pt-4">
                                <div class="flex space-x-3">
                                    <input type="text" x-model="newMessage" @keyup.enter="sendNewMessage" class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" placeholder="è¾“å…¥æ¶ˆæ¯...">
                                    <button @click="sendNewMessage" :disabled="!newMessage.trim()" class="px-6 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white font-medium rounded-lg hover:from-blue-600 hover:to-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed">å‘é€</button>
                                </div>
                            </div>
                        </div>
                        <div x-show="!selectedConversationId" class="flex-1 flex flex-col items-center justify-center"><i class="fas fa-comments text-gray-300 text-6xl mb-6"></i><h3 class="text-xl font-medium text-gray-700 mb-2">é€‰æ‹©ä¸€ä¸ªå¯¹è¯</h3><p class="text-gray-500 text-center max-w-md">ä»å·¦ä¾§é€‰æ‹©å¯¹è¯å¼€å§‹èŠå¤©ï¼Œæˆ–ä»æŠ€èƒ½åŒ¹é…ä¸­è”ç³»æ–°çš„ä¼™ä¼´</p></div>
                    </div>
                </div>
            </div>

            <!-- ===================== å­¦ä¹ æ­å­ä¸»é¡µé¢ï¼ˆç­›é€‰æ å·²ä¿®æ”¹ï¼Œå¡ç‰‡å®¹å™¨å·²ä¼˜åŒ–ï¼‰===================== -->
            <div x-show="activeTab === 'buddies'" x-transition>
                <div class="glass-card p-6 mb-6">
                    <div class="flex justify-between items-center">
                        <h2 class="text-xl font-bold text-gray-800">ğŸ“š å­¦ä¹ æ­å­</h2>
                        <button @click="showBuddyModal = true" class="px-5 py-2 bg-gradient-to-r from-green-500 to-green-600 text-white font-medium rounded-lg hover:from-green-600 hover:to-green-700 transition flex items-center">
                            <i class="fas fa-plus mr-2"></i>å‘å¸ƒæ­å­
                        </button>
                    </div>
                    <!-- æ–°å¢æ ‡è¯­ -->
                    <p class="text-gray-600 mt-2 mb-4 italic">ä¸€ä¸ªäººå­¦å¾—å¿«ï¼Œä¸€ç¾¤äººå­¦å¾—è¿œ</p>
                    
                    <!-- ç­›é€‰æ ï¼šæœç´¢æ¡† + ç›®æ ‡ + æ–¹å¼ + åŒåŸï¼ˆç§»åŠ¨ç«¯å‚ç›´æ’åˆ—ï¼Œpcæ°´å¹³ï¼‰ -->
                    <div class="flex flex-col gap-2 p-2 sm:flex-row sm:items-center">
                        <!-- æœç´¢æ¡†ï¼ˆflex-1ï¼‰ -->
                        <input type="text" x-model="buddySearchInput" @input.debounce.300ms="buddySearchKeyword = buddySearchInput; filterBuddies()" class="w-full px-3 py-2 border rounded text-sm" placeholder="æœç´¢ç›®æ ‡ã€åŸå¸‚æˆ–å…³é”®è¯">
                        <div class="flex gap-2">
                            <!-- ç›®æ ‡ä¸‹æ‹‰æ¡† -->
                            <select x-model="buddyGoalFilter" @change="filterBuddies" class="flex-1 min-w-[80px] px-3 py-2 border rounded text-sm">
                                <option value="">ç›®æ ‡</option>
                                <option value="è€ƒç ”">è€ƒç ”</option>
                                <option value="è‹±è¯­">è‹±è¯­</option>
                                <option value="è€ƒå…¬">è€ƒå…¬</option>
                                <option value="ç¼–ç¨‹">ç¼–ç¨‹</option>
                                <option value="å…¶ä»–">å…¶ä»–</option>
                            </select>
                            <!-- æ–¹å¼ä¸‹æ‹‰æ¡† -->
                            <select x-model="buddyModeFilter" @change="filterBuddies" class="flex-1 min-w-[80px] px-3 py-2 border rounded text-sm">
                                <option value="">æ–¹å¼</option>
                                <option value="çº¿ä¸Š">çº¿ä¸Š</option>
                                <option value="çº¿ä¸‹">çº¿ä¸‹</option>
                                <option value="å‡å¯">å‡å¯</option>
                            </select>
                            <!-- åŒåŸå¼€å…³ï¼ˆç‚¹å‡»é«˜äº®ï¼‰ -->
                            <button @click="toggleSameCityBuddy" :class="sameCityActive ? 'bg-blue-600 text-white border-blue-600' : 'border-gray-300 text-gray-700 hover:bg-gray-50'" class="px-4 py-2 border rounded text-sm whitespace-nowrap">åŒåŸ</button>
                        </div>
                    </div>
                </div>

                <!-- æ­å­åˆ—è¡¨å®¹å™¨ï¼ˆæ–°åŠ çš„gridæ ·å¼ï¼‰ -->
                <div class="grid grid-cols-1 gap-3 p-2 sm:grid-cols-2 lg:grid-cols-3">
                    <template x-for="buddy in filteredBuddies" :key="buddy.id">
                        <div class="glass-card p-5 hover:shadow-lg transition">
                            <div class="flex items-center gap-3 mb-3">
                                <template x-if="buddy.avatar_url">
                                    <img :src="buddy.avatar_url" class="w-10 h-10 rounded-full object-cover">
                                </template>
                                <template x-else>
                                    <div class="w-10 h-10 rounded-full bg-gradient-to-r from-blue-500 to-blue-600 flex items-center justify-center text-white font-bold" x-text="buddy.username?.charAt(0) || '?'"></div>
                                </template>
                                <div>
                                    <h3 class="font-bold text-gray-800" x-text="buddy.username"></h3>
                                    <p class="text-xs text-gray-500" x-text="formatTimeAgo(buddy.created_at)"></p>
                                </div>
                            </div>
                            <div class="mb-2">
                                <span class="inline-block px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm mr-2" x-text="buddy.goal"></span>
                                <span class="inline-block px-3 py-1 bg-gray-100 text-gray-800 rounded-full text-sm" x-text="buddy.mode"></span>
                            </div>
                            <p class="text-gray-600 text-sm mb-2"><i class="far fa-clock mr-1"></i><span x-text="buddy.time_slot"></span></p>
                            <p x-show="buddy.city" class="text-gray-500 text-sm mb-4"><i class="fas fa-map-marker-alt mr-1"></i><span x-text="buddy.city"></span></p>
                            <div class="flex gap-2">
                                <button @click="contactBuddy(buddy)" class="flex-1 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white font-medium rounded-lg hover:from-blue-600 hover:to-blue-700 transition text-sm"><i class="fas fa-comment mr-1"></i>è”ç³»æ­å­</button>
                                <button @click="toggleSaveBuddy(buddy)" class="px-3 py-2 border border-gray-300 rounded-lg text-gray-600 hover:bg-gray-50 transition"><i :class="isSaved(buddy.id) ? 'fas fa-star text-yellow-500' : 'far fa-star'"></i></button>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- ç©ºçŠ¶æ€ -->
                <div x-show="filteredBuddies.length === 0" class="text-center py-12">
                    <i class="fas fa-users text-gray-300 text-4xl mb-4"></i>
                    <p class="text-gray-500">æš‚æ— å­¦ä¹ æ­å­ä¿¡æ¯</p>
                    <p class="text-gray-400 text-sm mt-2">ç‚¹å‡»â€œå‘å¸ƒæ­å­â€æˆä¸ºç¬¬ä¸€ä¸ªå‘èµ·è€…</p>
                </div>
            </div>
        </div>

        <!-- ===================== æ‰€æœ‰æ¨¡æ€æ¡†ï¼ˆå®Œå…¨ä¿ç•™åŸæœ‰ï¼‰===================== -->
        
        <!-- ç¼–è¾‘èµ„æ–™æ¨¡æ€æ¡†ï¼ˆå®Œå…¨ä¿ç•™ï¼‰ -->
        <div x-show="showEditModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" x-transition>
            <div class="glasscard w-full max-w-md p-6" @click.away="showEditModal = false">
                <div class="flex justify-between items-center mb-6"><h2 class="text-xl font-bold text-gray-800">ç¼–è¾‘ä¸ªäººèµ„æ–™</h2><button @click="showEditModal = false" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times text-xl"></i></button></div>
                <form @submit.prevent="updateProfile" class="space-y-4">
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">ğŸ‘¤ ç”¨æˆ·å</label><input type="text" x-model="editForm.username" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" placeholder="è¾“å…¥ç”¨æˆ·å" required></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“ æ‰€åœ¨åŸå¸‚</label><input type="text" x-model="editForm.city" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" placeholder="ä¾‹å¦‚ï¼šåŒ—äº¬å¸‚ã€ä¸Šæµ·å¸‚ã€å¹¿å·å¸‚" required></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">ğŸŒŸ æˆ‘èƒ½åˆ†äº«çš„æŠ€èƒ½</label><input type="text" x-model="editForm.teach_skill" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" placeholder="ä¾‹å¦‚ï¼šè‹±è¯­æ•™å­¦ã€ç¼–ç¨‹ã€æ‘„å½±..."></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“š æˆ‘æƒ³å­¦ä¹ çš„æŠ€èƒ½</label><input type="text" x-model="editForm.learn_skill" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" placeholder="ä¾‹å¦‚ï¼šè§†é¢‘å‰ªè¾‘ã€çƒ¹é¥ªã€è¥¿ç­ç‰™è¯­..."></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“ ä¸ªäººç®€ä»‹</label><textarea x-model="editForm.bio" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" placeholder="ç®€å•ä»‹ç»ä¸€ä¸‹è‡ªå·±..."></textarea></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">ğŸ–¼ï¸ å¤´åƒURL</label><input type="url" x-model="editForm.avatar_url" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" placeholder="https://example.com/avatar.jpg"></div>
                    <div class="flex space-x-3 pt-4"><button type="submit" :disabled="loading" class="flex-1 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white font-medium rounded-lg hover:from-blue-600 hover:to-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed"><span x-show="!loading">ä¿å­˜ä¿®æ”¹</span><span x-show="loading" class="flex items-center justify-center"><span class="loading-spinner mr-2"></span>ä¿å­˜ä¸­...</span></button><button type="button" @click="showEditModal = false" class="flex-1 py-3 border border-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-50 transition">å–æ¶ˆ</button></div>
                </form>
            </div>
        </div>

        <!-- ===================== æŸ¥çœ‹ç”¨æˆ·èµ„æ–™æ¨¡æ€æ¡†ï¼ˆå·²ä¿®æ”¹ï¼šè¯„åˆ†ç§»è‡³å¤´åƒä¸‹æ–¹+è¿‘æœŸè¯„ä»·åŒºå—ï¼‰===================== -->
        <div x-show="showViewProfileModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" x-transition>
            <div class="glasscard w-full max-w-md p-6 max-h-[90vh] overflow-y-auto" @click.away="showViewProfileModal = false">
                <div class="flex justify-between items-center mb-6"><h2 class="text-xl font-bold text-gray-800">ç”¨æˆ·èµ„æ–™</h2><button @click="showViewProfileModal = false" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times text-xl"></i></button></div>
                <div x-show="!viewProfileLoading && viewedUserProfile" class="space-y-4">
                    <!-- å¤´åƒåŒºåŸŸ + è¯„åˆ†ï¼ˆç´§æŒ¨ç”¨æˆ·åï¼‰ -->
                    <div class="flex items-center mb-4">
                        <template x-if="viewedUserProfile?.avatar_url">
                            <img :src="viewedUserProfile.avatar_url" class="w-16 h-16 rounded-full object-cover" alt="avatar">
                        </template>
                        <template x-else>
                            <div class="w-16 h-16 rounded-full bg-gradient-to-r from-blue-500 to-blue-600 flex items-center justify-center text-white text-2xl font-bold"><span x-text="viewedUserProfile?.username?.charAt(0) || '?'"></span></div>
                        </template>
                        <div class="ml-4 flex-1">
                            <div class="flex items-center gap-2 flex-wrap">
                                <h2 class="text-xl font-bold text-gray-800" x-text="viewedUserProfile?.username || 'ç”¨æˆ·'"></h2>
                                <!-- è¯„åˆ†æ˜¾ç¤º -->
                                <span x-show="viewedUserProfile?.overall_rating > 0" class="flex items-center text-sm text-yellow-500">
                                    <i class="fas fa-star mr-1"></i>
                                    <span x-text="viewedUserProfile?.overall_rating?.toFixed(1)"></span>
                                    <span class="text-gray-500 ml-1">(<span x-text="viewedUserProfile?.total_reviews"></span>æ¡)</span>
                                </span>
                                <!-- ä¿¡èª‰å¾½ç« ï¼ˆå¦‚æœæœ‰ï¼‰ -->
                                <span x-show="viewedUserProfile?.overall_rating >= 4.5" class="trust-badge text-xs"><i class="fas fa-crown"></i></span>
                            </div>
                            <p class="text-gray-600 text-sm" x-text="viewedUserProfile?.email || ''"></p>
                        </div>
                    </div>

                    <!-- åŸºç¡€ä¿¡æ¯ -->
                    <div><h3 class="font-medium text-gray-700 mb-2">ğŸ“ æ‰€åœ¨åŸå¸‚</h3><p x-show="viewedUserProfile?.city" class="text-gray-600" x-text="viewedUserProfile?.city"></p><p x-show="!viewedUserProfile?.city" class="text-gray-500 text-sm">æœªè®¾ç½®</p></div>
                    <div><h3 class="font-medium text-gray-700 mb-2">ğŸŒŸ æˆ‘èƒ½åˆ†äº«</h3><div><span x-show="viewedUserProfile?.teach_skill" class="skill-tag teach" x-text="viewedUserProfile?.teach_skill"></span><span x-show="!viewedUserProfile?.teach_skill" class="text-gray-500 text-sm">æœªè®¾ç½®</span></div></div>
                    <div><h3 class="font-medium text-gray-700 mb-2">ğŸ“š æˆ‘æƒ³å­¦ä¹ </h3><div><span x-show="viewedUserProfile?.learn_skill" class="skill-tag learn" x-text="viewedUserProfile?.learn_skill"></span><span x-show="!viewedUserProfile?.learn_skill" class="text-gray-500 text-sm">æœªè®¾ç½®</span></div></div>
                    <div><h3 class="font-medium text-gray-700 mb-2">ğŸ“ ä¸ªäººç®€ä»‹</h3><p x-show="viewedUserProfile?.bio" class="text-gray-600 text-sm" x-text="viewedUserProfile?.bio"></p><p x-show="!viewedUserProfile?.bio" class="text-gray-500 text-sm">æœªè®¾ç½®</p></div>
                    
                    <!-- ========== æ–°å¢ï¼šè¿‘æœŸè¯„ä»·åŒºå— ========== -->
                    <div x-show="viewedUserProfile?.total_reviews > 0" class="mt-4 border-t pt-4">
                        <h3 class="font-medium text-gray-700 mb-3 flex items-center">
                            <i class="fas fa-star text-yellow-400 mr-1"></i>è¿‘æœŸè¯„ä»·
                        </h3>
                        <div class="space-y-3">
                            <template x-for="review in recentReviews" :key="review.id">
                                <div class="flex items-start gap-3">
                                    <!-- è¯„ä»·äººå¤´åƒ -->
                                    <template x-if="!review.is_anonymous && review.reviewer?.avatar_url">
                                        <img :src="review.reviewer.avatar_url" class="w-8 h-8 rounded-full object-cover">
                                    </template>
                                    <template x-else>
                                        <div class="w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center text-white text-xs font-bold">
                                            <span x-text="review.is_anonymous ? 'åŒ¿' : (review.reviewer?.username?.charAt(0) || '?')"></span>
                                        </div>
                                    </template>
                                    <div class="flex-1">
                                        <div class="flex justify-between items-center">
                                            <p class="text-sm font-medium" x-text="review.is_anonymous ? 'åŒ¿åç”¨æˆ·' : review.reviewer?.username"></p>
                                            <div class="flex text-yellow-400 text-xs">
                                                <template x-for="i in 5">
                                                    <i :class="i <= review.overall_rating ? 'fas fa-star' : 'far fa-star'"></i>
                                                </template>
                                            </div>
                                        </div>
                                        <p class="text-xs text-gray-500" x-text="formatTimeAgo(review.created_at)"></p>
                                        <p class="text-sm text-gray-700 mt-1 line-clamp-2" x-text="review.content || 'ç”¨æˆ·æœªç•™ä¸‹æ–‡å­—è¯„ä»·'"></p>
                                    </div>
                                </div>
                            </template>
                        </div>
                        <!-- æŸ¥çœ‹å…¨éƒ¨æŒ‰é’®ï¼ˆå¦‚æœæ€»è¯„ä»·æ•° > 3ï¼‰ -->
                        <button x-show="viewedUserProfile?.total_reviews > 3" 
                                @click="loadAllReviews(viewedUserProfile.id); showAllReviews = true" 
                                class="mt-2 text-sm text-blue-600 hover:text-blue-800">
                            æŸ¥çœ‹å…¨éƒ¨ <span x-text="viewedUserProfile.total_reviews"></span> æ¡è¯„ä»· â†’
                        </button>
                    </div>
                </div>
                <div x-show="viewProfileLoading" class="text-center py-8"><span class="loading-spinner"></span><p class="text-gray-500 mt-2">æ­£åœ¨åŠ è½½ç”¨æˆ·èµ„æ–™...</p></div>
                <div x-show="!viewProfileLoading && !viewedUserProfile" class="text-center py-8"><i class="fas fa-user-slash text-gray-300 text-4xl mb-4"></i><p class="text-gray-500">æ— æ³•åŠ è½½ç”¨æˆ·èµ„æ–™</p></div>
                <div class="flex space-x-3 pt-6">
                    <button @click="sendMessage(viewedUserProfile?.id, viewedUserProfile?.username)" x-show="viewedUserProfile" class="flex-1 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white font-medium rounded-lg hover:from-blue-600 hover:to-blue-700 transition"><i class="fas fa-comment mr-2"></i>å‘é€æ¶ˆæ¯</button>
                    <button type="button" @click="showViewProfileModal = false" class="flex-1 py-3 border border-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-50 transition">å…³é—­</button>
                </div>
            </div>
        </div>

        <!-- ===================== æ–°å¢ï¼šå…¨éƒ¨è¯„ä»·æ¨¡æ€æ¡† ===================== -->
        <div x-show="showAllReviews" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" x-transition>
            <div class="glasscard w-full max-w-lg p-6 max-h-[80vh] overflow-y-auto" @click.away="showAllReviews = false">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold">å…¨éƒ¨è¯„ä»· Â· <span x-text="viewedUserProfile?.username || ''"></span></h3>
                    <button @click="showAllReviews = false" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
                </div>
                <div class="space-y-4">
                    <template x-if="allReviews.length === 0">
                        <p class="text-center text-gray-500 py-8">æš‚æ— è¯„ä»·</p>
                    </template>
                    <template x-for="review in allReviews" :key="review.id">
                        <div class="border-b pb-4 last:border-0">
                            <div class="flex items-start gap-3">
                                <template x-if="!review.is_anonymous && review.reviewer?.avatar_url">
                                    <img :src="review.reviewer.avatar_url" class="w-8 h-8 rounded-full object-cover">
                                </template>
                                <template x-else>
                                    <div class="w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center text-white text-xs font-bold">
                                        <span x-text="review.is_anonymous ? 'åŒ¿' : (review.reviewer?.username?.charAt(0) || '?')"></span>
                                    </div>
                                </template>
                                <div class="flex-1">
                                    <div class="flex justify-between items-center">
                                        <p class="text-sm font-medium" x-text="review.is_anonymous ? 'åŒ¿åç”¨æˆ·' : review.reviewer?.username"></p>
                                        <div class="flex text-yellow-400 text-xs">
                                            <template x-for="i in 5">
                                                <i :class="i <= review.overall_rating ? 'fas fa-star' : 'far fa-star'"></i>
                                            </template>
                                        </div>
                                    </div>
                                    <p class="text-xs text-gray-500" x-text="formatTimeAgo(review.created_at)"></p>
                                    <p class="text-sm text-gray-700 mt-1" x-text="review.content || 'ç”¨æˆ·æœªç•™ä¸‹æ–‡å­—è¯„ä»·'"></p>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <!-- å‘å¸ƒæŠ€èƒ½æ¨¡æ€æ¡†ï¼ˆå®Œå…¨ä¿ç•™åŸæœ‰ï¼‰ -->
        <div x-show="showSkillModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" x-transition>
            <div class="glasscard w-full max-w-md p-6" @click.away="showSkillModal = false">
                <div class="flex justify-between items-center mb-6"><h2 class="text-xl font-bold text-gray-800">å‘å¸ƒæŠ€èƒ½</h2><button @click="showSkillModal = false" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times text-xl"></i></button></div>
                <form @submit.prevent="publishSkill()" class="space-y-6">
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">æŠ€èƒ½æ ‡é¢˜</label><input type="text" x-model="newSkill.title" placeholder="ä¾‹å¦‚ï¼šVue.js å‰ç«¯å¼€å‘å®æˆ˜" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" required></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">æŠ€èƒ½æè¿°</label><textarea x-model="newSkill.description" rows="6" placeholder="è¯¦ç»†æè¿°ä½ çš„æŠ€èƒ½å†…å®¹ã€æ•™å­¦æ–¹å¼ã€èƒ½æ•™ä»€ä¹ˆã€é€‚åˆä»€ä¹ˆäººç¾¤..." class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition resize-none" required></textarea></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">é€‰æ‹©åˆ†ç±»</label><select x-model="newSkill.category" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" required><option value="">è¯·é€‰æ‹©åˆ†ç±»</option><option value="ç¼–ç¨‹å¼€å‘">ç¼–ç¨‹å¼€å‘</option><option value="è®¾è®¡åˆ›æ„">è®¾è®¡åˆ›æ„</option><option value="ç”Ÿæ´»æŠ€èƒ½">ç”Ÿæ´»æŠ€èƒ½</option><option value="è¯­è¨€å­¦ä¹ ">è¯­è¨€å­¦ä¹ </option><option value="éŸ³ä¹è‰ºæœ¯">éŸ³ä¹è‰ºæœ¯</option><option value="è¿åŠ¨å¥èº«">è¿åŠ¨å¥èº«</option><option value="å•†ä¸šæŠ€èƒ½">å•†ä¸šæŠ€èƒ½</option><option value="å­¦æœ¯è¾…å¯¼">å­¦æœ¯è¾…å¯¼</option><option value="å…¶ä»–">å…¶ä»–</option></select></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">æ•™å­¦æ–¹å¼</label><div class="flex space-x-4"><label class="flex items-center"><input type="radio" x-model="newSkill.teachingMethod" value="åœ¨çº¿" class="mr-2 text-blue-600 focus:ring-blue-500"><span>åœ¨çº¿</span></label><label class="flex items-center"><input type="radio" x-model="newSkill.teachingMethod" value="çº¿ä¸‹" class="mr-2 text-blue-600 focus:ring-blue-500"><span>çº¿ä¸‹</span></label><label class="flex items-center"><input type="radio" x-model="newSkill.teachingMethod" value="çº¿ä¸Šçº¿ä¸‹ç»“åˆ" class="mr-2 text-blue-600 focus:ring-blue-500"><span>çº¿ä¸Šçº¿ä¸‹ç»“åˆ</span></label></div></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">åŸå¸‚</label><input type="text" x-model="newSkill.city" placeholder="è¾“å…¥æ•™å­¦åŸå¸‚" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"></div>
                    <div class="flex space-x-3 pt-4"><button type="submit" class="flex-1 py-3 bg-gradient-to-r from-green-500 to-green-600 text-white font-medium rounded-lg hover:from-green-600 hover:to-green-700 transition"><i class="fas fa-paper-plane mr-2"></i>å‘å¸ƒæŠ€èƒ½</button><button type="button" @click="showSkillModal = false" class="flex-1 py-3 border border-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-50 transition">å–æ¶ˆ</button></div>
                </form>
            </div>
        </div>

        <!-- è§†é¢‘æ•™å®¤æ¨¡æ€æ¡†ï¼ˆå®Œå…¨ä¿ç•™åŸæœ‰ï¼‰ -->
        <div x-show="showVideoRoomModal" class="video-room-panel" x-transition.opacity>
            <div class="video-room-content p-6" @click.away="closeVideoRoomModal">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-xl font-bold text-gray-800">ğŸ¥ è§†é¢‘æ•™å®¤</h2>
                        <p class="text-gray-600 text-sm mt-1" x-show="selectedConversation">ä¸ <span x-text="selectedConversation?.username"></span> çš„æŠ€èƒ½äº¤æµ</p>
                    </div>
                    <button @click="closeVideoRoomModal" class="text-gray-500 hover:text-gray-700 w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 transition"><i class="fas fa-times text-xl"></i></button>
                </div>
                <div x-show="isCreatingVideoRoom" class="text-center py-12"><span class="loading-spinner mb-4"></span><p class="text-gray-600">æ­£åœ¨åˆ›å»ºä¸“å±è§†é¢‘æ•™å®¤...</p><p class="text-gray-400 text-sm mt-2">è¯·ç¨å€™ï¼Œå³å°†ç”Ÿæˆæˆ¿é—´é“¾æ¥å’Œå¯†ç </p></div>
                <div x-show="!isCreatingVideoRoom && videoRoomUrl" class="space-y-4">
                    <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                        <div class="flex items-center mb-3"><i class="fas fa-check-circle text-green-500 mr-2 text-xl"></i><span class="font-medium text-gray-800">è§†é¢‘æ•™å®¤åˆ›å»ºæˆåŠŸï¼</span></div>
                        <p class="text-gray-600 text-sm">è¯·å°†ä»¥ä¸‹ä¿¡æ¯åˆ†äº«ç»™å¯¹æ–¹ï¼ŒåŒæ–¹è¾“å…¥ç›¸åŒå¯†ç å³å¯è¿›å…¥ï¼š</p>
                    </div>
                    <div class="space-y-3">
                        <div>
                            <label class="text-sm font-medium text-gray-700 block mb-1">æˆ¿é—´é“¾æ¥ï¼š</label>
                            <div class="flex items-center gap-2">
                                <a :href="videoRoomUrl" target="_blank" x-text="videoRoomUrl" class="flex-1 text-blue-600 hover:text-blue-800 underline text-sm p-3 bg-gray-50 rounded border truncate font-mono"></a>
                                <button @click="copyVideoLinkAndPassword" class="px-4 py-3 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition text-sm font-medium whitespace-nowrap"><i class="fas fa-copy mr-1"></i>å¤åˆ¶</button>
                            </div>
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-700 block mb-1">è¿æ¥å¯†ç ï¼š</label>
                            <div class="flex items-center gap-2">
                                <span x-text="videoRoomPassword" class="flex-1 font-mono text-2xl font-bold text-gray-800 p-3 bg-gray-50 rounded border tracking-widest text-center"></span>
                                <button @click="copyPassword" class="px-4 py-3 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition text-sm font-medium whitespace-nowrap"><i class="fas fa-copy mr-1"></i>å¤åˆ¶å¯†ç </button>
                            </div>
                        </div>
                    </div>
                    <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                        <p class="font-medium text-yellow-800 mb-2 text-sm">ğŸ’¡ ä½¿ç”¨æ­¥éª¤ï¼š</p>
                        <ol class="list-decimal pl-5 space-y-1 text-sm text-yellow-700">
                            <li>ç‚¹å‡»ä¸Šæ–¹é“¾æ¥è¿›å…¥è§†é¢‘æˆ¿é—´</li>
                            <li>é€‰æ‹© "JOIN PRIVATE ROOM" æŒ‰é’®</li>
                            <li>è¾“å…¥å¯†ç ï¼š<span x-text="videoRoomPassword" class="font-bold font-mono"></span></li>
                            <li>åŒæ–¹è¾“å…¥ç›¸åŒå¯†ç åå³å¯å¼€å§‹è§†é¢‘äº¤æµ</li>
                        </ol>
                    </div>
                    <div class="flex gap-3 pt-2">
                        <a :href="videoRoomUrl" target="_blank" class="flex-1 py-3 bg-gradient-to-r from-green-500 to-green-600 text-white font-medium rounded-lg hover:from-green-600 hover:to-green-700 transition text-center"><i class="fas fa-external-link-alt mr-2"></i>ç«‹å³è¿›å…¥æ•™å®¤</a>
                        <button @click="sendVideoRoomLinkToChat" class="flex-1 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white font-medium rounded-lg hover:from-blue-600 hover:to-blue-700 transition"><i class="fas fa-paper-plane mr-2"></i>å‘é€åˆ°èŠå¤©</button>
                    </div>
                </div>
                <div x-show="videoError && !isCreatingVideoRoom && !videoRoomUrl" class="text-center py-8"><i class="fas fa-exclamation-circle text-red-500 text-4xl mb-4"></i><p class="text-red-600 font-medium" x-text="videoError"></p><button @click="createVideoRoom" class="mt-4 px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">é‡è¯•</button></div>
            </div>
        </div>

        <!-- å‘èµ·æ´»åŠ¨æ¨¡æ€æ¡†ï¼ˆå®Œå…¨ä¿ç•™åŸæœ‰ï¼‰ -->
        <div x-show="showCreateEventModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" x-transition>
            <div class="glasscard w-full max-w-md p-6 flex flex-col max-h-[90vh]" @click.away="showCreateEventModal = false">
                <div class="flex justify-between items-center mb-6 flex-shrink-0"><h2 class="text-xl font-bold text-gray-800">å‘èµ·çº¿ä¸‹æ´»åŠ¨</h2><button @click="showCreateEventModal = false" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times text-xl"></i></button></div>
                <form @submit.prevent="createCommunityEvent" class="space-y-4 modal-scrollable pr-2">
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">æ´»åŠ¨æ ‡é¢˜</label><input type="text" x-model="newEvent.title" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" placeholder="ä¾‹å¦‚ï¼šPythonæ•°æ®åˆ†æå®æˆ˜å·¥ä½œåŠ" required></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">æ´»åŠ¨ç±»å‹</label><select x-model="newEvent.event_type" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"><option value="æ²™é¾™">æŠ€èƒ½æ²™é¾™ï¼ˆå°è§„æ¨¡åˆ†äº«ï¼‰</option><option value="å·¥ä½œåŠ">æŠ€èƒ½å·¥ä½œåŠï¼ˆåŠ¨æ‰‹å®è·µï¼‰</option><option value="äº¤æ¢ä¼š">æŠ€èƒ½äº¤æ¢ä¼šï¼ˆäº’ç›¸å­¦ä¹ ï¼‰</option><option value="ç»ƒä¹ ç»„">ç»ƒä¹ å°ç»„ï¼ˆå®šæœŸç»ƒä¹ ï¼‰</option><option value="é¡¹ç›®ç»„">é¡¹ç›®åä½œï¼ˆå…±åŒå®Œæˆï¼‰</option><option value="ç¤¾äº¤ä¼š">ç¤¾äº¤èšä¼šï¼ˆè½»æ¾äº¤æµï¼‰</option></select></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">æ´»åŠ¨æè¿°</label><textarea x-model="newEvent.description" rows="4" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" placeholder="è¯¦ç»†æè¿°æ´»åŠ¨å†…å®¹ã€æµç¨‹ã€æ”¶è·..." required></textarea></div>
                    <div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium text-gray-700 mb-2">æ´»åŠ¨æ—¥æœŸ</label><input type="date" x-model="newEvent.event_date" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" required></div><div><label class="block text-sm font-medium text-gray-700 mb-2">å¼€å§‹æ—¶é—´</label><input type="time" x-model="newEvent.start_time" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" required></div></div>
                    <div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium text-gray-700 mb-2">ç»“æŸæ—¶é—´</label><input type="time" x-model="newEvent.end_time" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" required></div><div><label class="block text-sm font-medium text-gray-700 mb-2">æœ€å¤šäººæ•°</label><input type="number" x-model="newEvent.max_people" min="2" max="50" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" placeholder="é€‰å¡«ï¼Œç”¨äºå‚è€ƒ"></div></div>
                    <div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium text-gray-700 mb-2">åŸå¸‚</label><input type="text" x-model="newEvent.city" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" placeholder="ä¾‹å¦‚ï¼šåŒ—äº¬å¸‚" required></div><div><label class="block text-sm font-medium text-gray-700 mb-2">è¯¦ç»†åœ°å€</label><input type="text" x-model="newEvent.address" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" placeholder="ä¾‹å¦‚ï¼šæµ·æ·€åŒºä¸­å…³æ‘åˆ›ä¸šå¤§è¡—3Wå’–å•¡" required></div></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">è´¹ç”¨è¯´æ˜</label><input type="text" x-model="newEvent.fee_info" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" placeholder="ä¾‹å¦‚ï¼šå…è´¹ / åœºåœ°è´¹å¹³æ‘Šçº¦30å…ƒ / ææ–™è´¹50å…ƒ"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">æ³¨æ„äº‹é¡¹</label><textarea x-model="newEvent.notes" rows="2" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" placeholder="ä¾‹å¦‚ï¼šè¯·è‡ªå¸¦ç¬”è®°æœ¬ç”µè„‘ï¼Œæœ‰PythonåŸºç¡€"></textarea></div>
                    <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg"><div class="flex items-start"><input type="checkbox" x-model="newEvent.disclaimer_accepted" id="disclaimer" class="mt-1 mr-3"><label for="disclaimer" class="text-sm text-yellow-800">æˆ‘ç†è§£å¹¶åŒæ„ï¼šæœ¬æ¬¡æ´»åŠ¨ç”±æˆ‘è‡ªæ„¿å‘èµ·ï¼Œæ´»åŠ¨äº§ç”Ÿçš„ä»»ä½•è´¹ç”¨ç”±å‚ä¸è€…è‡ªè¡Œåå•†è§£å†³ï¼Œå¹³å°ä»…æä¾›ä¿¡æ¯å‘å¸ƒæœåŠ¡ï¼Œä¸æ‰¿æ‹…ä»»ä½•è´£ä»»ã€‚æˆ‘å°†ç¡®ä¿æ´»åŠ¨åœ¨å®‰å…¨åˆæ³•çš„åœºæ‰€è¿›è¡Œã€‚</label></div></div>
                    <div class="flex space-x-3 pt-4 pb-2"><button type="submit" :disabled="!newEvent.disclaimer_accepted || eventCreating" class="flex-1 py-3 bg-gradient-to-r from-green-500 to-green-600 text-white font-medium rounded-lg hover:from-green-600 hover:to-green-700 transition disabled:opacity-50 disabled:cursor-not-allowed"><span x-show="!eventCreating">å‘å¸ƒæ´»åŠ¨</span><span x-show="eventCreating" class="flex items-center justify-center"><span class="loading-spinner mr-2"></span>å‘å¸ƒä¸­...</span></button><button type="button" @click="showCreateEventModal = false" class="flex-1 py-3 border border-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-50 transition">å–æ¶ˆ</button></div>
                </form>
            </div>
        </div>

        <!-- ç¼–è¾‘æ´»åŠ¨æ¨¡æ€æ¡†ï¼ˆå®Œå…¨ä¿ç•™åŸæœ‰ï¼‰ -->
        <div x-show="showEditEventModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" x-transition>
            <div class="glasscard w-full max-w-md p-6 flex flex-col max-h-[90vh]" @click.away="showEditEventModal = false">
                <div class="flex justify-between items-center mb-6 flex-shrink-0"><h2 class="text-xl font-bold text-gray-800">ç¼–è¾‘æ´»åŠ¨</h2><button @click="showEditEventModal = false" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times text-xl"></i></button></div>
                <form @submit.prevent="updateEvent" class="space-y-4 modal-scrollable pr-2" x-show="editingEvent">
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">æ´»åŠ¨æ ‡é¢˜</label><input type="text" x-model="editingEvent?.title" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" required></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">æ´»åŠ¨ç±»å‹</label><select x-model="editingEvent?.event_type" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"><option value="æ²™é¾™">æŠ€èƒ½æ²™é¾™</option><option value="å·¥ä½œåŠ">æŠ€èƒ½å·¥ä½œåŠ</option><option value="äº¤æ¢ä¼š">æŠ€èƒ½äº¤æ¢ä¼š</option><option value="ç»ƒä¹ ç»„">ç»ƒä¹ å°ç»„</option><option value="é¡¹ç›®ç»„">é¡¹ç›®åä½œ</option><option value="ç¤¾äº¤ä¼š">ç¤¾äº¤èšä¼š</option></select></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">æ´»åŠ¨æè¿°</label><textarea x-model="editingEvent?.description" rows="4" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" required></textarea></div>
                    <div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium text-gray-700 mb-2">æ´»åŠ¨æ—¥æœŸ</label><input type="date" x-model="editingEvent?.event_date" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" required></div><div><label class="block text-sm font-medium text-gray-700 mb-2">å¼€å§‹æ—¶é—´</label><input type="time" x-model="editingEvent?.start_time" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" required></div></div>
                    <div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium text-gray-700 mb-2">ç»“æŸæ—¶é—´</label><input type="time" x-model="editingEvent?.end_time" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" required></div><div><label class="block text-sm font-medium text-gray-700 mb-2">æœ€å¤šäººæ•°</label><input type="number" x-model="editingEvent?.max_people" min="2" max="50" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"></div></div>
                    <div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium text-gray-700 mb-2">åŸå¸‚</label><input type="text" x-model="editingEvent?.city" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" required></div><div><label class="block text-sm font-medium text-gray-700 mb-2">è¯¦ç»†åœ°å€</label><input type="text" x-model="editingEvent?.address" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" required></div></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">è´¹ç”¨è¯´æ˜</label><input type="text" x-model="editingEvent?.fee_info" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">æ³¨æ„äº‹é¡¹</label><textarea x-model="editingEvent?.notes" rows="2" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"></textarea></div>
                    <div class="flex space-x-3 pt-4 pb-2"><button type="submit" class="flex-1 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white font-medium rounded-lg hover:from-blue-600 hover:to-blue-700 transition">ä¿å­˜ä¿®æ”¹</button><button type="button" @click="showEditEventModal = false" class="flex-1 py-3 border border-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-50 transition">å–æ¶ˆ</button></div>
                </form>
            </div>
        </div>

        <!-- ===================== æ–°å¢ï¼šè¯„ä»·æ¨¡æ€æ¡†ï¼ˆç”¨äºå†™è¯„ä»·ï¼‰===================== -->
        <div x-show="showReviewModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" x-transition>
            <div class="glasscard w-full max-w-lg p-6 max-h-[90vh] overflow-y-auto" @click.away="showReviewModal = false">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-800">ğŸ“ è¯„ä»· <span x-text="reviewTarget?.username"></span></h2>
                    <button @click="showReviewModal = false" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times text-xl"></i></button>
                </div>
                <div class="space-y-6">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">æŠ€èƒ½æ°´å¹³</label>
                            <div class="star-rating text-2xl" @mouseleave="reviewForm.hover_skill = 0">
                                <template x-for="i in 5">
                                    <i @mouseover="reviewForm.hover_skill = i" @click="reviewForm.skill_level = i" :class="(reviewForm.hover_skill || reviewForm.skill_level) >= i ? 'fas fa-star active' : 'far fa-star inactive'"></i>
                                </template>
                                <span class="ml-2 text-sm text-gray-500" x-text="reviewForm.skill_level > 0 ? reviewForm.skill_level + 'æ˜Ÿ' : 'è¯·è¯„åˆ†'"></span>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">æ•™å­¦æ€åº¦</label>
                            <div class="star-rating text-2xl" @mouseleave="reviewForm.hover_teaching = 0">
                                <template x-for="i in 5">
                                    <i @mouseover="reviewForm.hover_teaching = i" @click="reviewForm.teaching_attitude = i" :class="(reviewForm.hover_teaching || reviewForm.teaching_attitude) >= i ? 'fas fa-star active' : 'far fa-star inactive'"></i>
                                </template>
                                <span class="ml-2 text-sm text-gray-500" x-text="reviewForm.teaching_attitude > 0 ? reviewForm.teaching_attitude + 'æ˜Ÿ' : 'è¯·è¯„åˆ†'"></span>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">å®ˆæ—¶ç¨‹åº¦</label>
                            <div class="star-rating text-2xl" @mouseleave="reviewForm.hover_punctuality = 0">
                                <template x-for="i in 5">
                                    <i @mouseover="reviewForm.hover_punctuality = i" @click="reviewForm.punctuality = i" :class="(reviewForm.hover_punctuality || reviewForm.punctuality) >= i ? 'fas fa-star active' : 'far fa-star inactive'"></i>
                                </template>
                                <span class="ml-2 text-sm text-gray-500" x-text="reviewForm.punctuality > 0 ? reviewForm.punctuality + 'æ˜Ÿ' : 'è¯·è¯„åˆ†'"></span>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">æ²Ÿé€šèƒ½åŠ›</label>
                            <div class="star-rating text-2xl" @mouseleave="reviewForm.hover_communication = 0">
                                <template x-for="i in 5">
                                    <i @mouseover="reviewForm.hover_communication = i" @click="reviewForm.communication = i" :class="(reviewForm.hover_communication || reviewForm.communication) >= i ? 'fas fa-star active' : 'far fa-star inactive'"></i>
                                </template>
                                <span class="ml-2 text-sm text-gray-500" x-text="reviewForm.communication > 0 ? reviewForm.communication + 'æ˜Ÿ' : 'è¯·è¯„åˆ†'"></span>
                            </div>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">å¿«é€Ÿè¯„ä»·ï¼ˆå¯å¤šé€‰ï¼‰</label>
                        <div class="flex flex-wrap">
                            <button @click="toggleReviewTag('è€å¿ƒç»†è‡´')" :class="reviewForm.tags.includes('è€å¿ƒç»†è‡´') ? 'selected' : ''" class="review-tag">è€å¿ƒç»†è‡´</button>
                            <button @click="toggleReviewTag('ä¸“ä¸šèƒ½åŠ›å¼º')" :class="reviewForm.tags.includes('ä¸“ä¸šèƒ½åŠ›å¼º') ? 'selected' : ''" class="review-tag">ä¸“ä¸šèƒ½åŠ›å¼º</button>
                            <button @click="toggleReviewTag('è®²è§£æ¸…æ™°')" :class="reviewForm.tags.includes('è®²è§£æ¸…æ™°') ? 'selected' : ''" class="review-tag">è®²è§£æ¸…æ™°</button>
                            <button @click="toggleReviewTag('å®ˆæ—¶å®ˆä¿¡')" :class="reviewForm.tags.includes('å®ˆæ—¶å®ˆä¿¡') ? 'selected' : ''" class="review-tag">å®ˆæ—¶å®ˆä¿¡</button>
                            <button @click="toggleReviewTag('çƒ­æƒ…å‹å¥½')" :class="reviewForm.tags.includes('çƒ­æƒ…å‹å¥½') ? 'selected' : ''" class="review-tag">çƒ­æƒ…å‹å¥½</button>
                            <button @click="toggleReviewTag('æ”¶è·å¾ˆå¤§')" :class="reviewForm.tags.includes('æ”¶è·å¾ˆå¤§') ? 'selected' : ''" class="review-tag">æ”¶è·å¾ˆå¤§</button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">è¯¦ç»†è¯„ä»·ï¼ˆé€‰å¡«ï¼‰</label>
                        <textarea x-model="reviewForm.content" rows="4" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" placeholder="åˆ†äº«ä½ çš„å…·ä½“ä½“éªŒå’Œæ„Ÿå—..."></textarea>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" x-model="reviewForm.is_anonymous" id="anonymous" class="mr-2">
                        <label for="anonymous" class="text-sm text-gray-600">åŒ¿åè¯„ä»·</label>
                    </div>
                    <div class="flex space-x-3 pt-4">
                        <button @click="submitReview" :disabled="!isReviewValid()" class="flex-1 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white font-medium rounded-lg hover:from-blue-600 hover:to-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed">æäº¤è¯„ä»·</button>
                        <button @click="showReviewModal = false" class="flex-1 py-3 border border-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-50 transition">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ===================== æ–°å¢ï¼šåŒ¹é…æˆåŠŸåˆ†äº«æ¨¡æ€æ¡† ===================== -->
        <div x-show="showMatchShareModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" x-transition>
            <div class="glasscard w-full max-w-md p-6" @click.away="showMatchShareModal = false">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-800">ğŸ‰ åˆ†äº«åŒ¹é…æˆåŠŸ</h2>
                    <button @click="showMatchShareModal = false" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times text-xl"></i></button>
                </div>
                <div id="matchShareCard" class="share-card mb-6">
                    <div class="relative z-10">
                        <div class="text-4xl mb-4">ğŸŠ</div>
                        <h3 class="text-2xl font-bold mb-2">æŠ€èƒ½åŒ¹é…æˆåŠŸï¼</h3>
                        <p class="text-white text-opacity-90 mb-6">åœ¨çŸ¥èˆŸå¹³å°æ‰¾åˆ°äº†å®Œç¾çš„æŠ€èƒ½ä¼™ä¼´</p>
                        <div class="flex justify-center items-center gap-4 mb-6">
                            <div class="text-center">
                                <template x-if="shareMatchData?.myAvatar">
                                    <img :src="shareMatchData.myAvatar" class="share-avatar mx-auto mb-2">
                                </template>
                                <template x-else>
                                    <div class="share-avatar mx-auto mb-2 bg-gradient-to-r from-blue-400 to-blue-600 flex items-center justify-center text-2xl font-bold" x-text="shareMatchData?.myName?.charAt(0)"></div>
                                </template>
                                <p class="text-sm font-medium" x-text="shareMatchData?.myName"></p>
                                <span class="share-badge" x-text="shareMatchData?.mySkill"></span>
                            </div>
                            <div class="text-3xl">ğŸ¤</div>
                            <div class="text-center">
                                <template x-if="shareMatchData?.matchAvatar">
                                    <img :src="shareMatchData.matchAvatar" class="share-avatar mx-auto mb-2">
                                </template>
                                <template x-else>
                                    <div class="share-avatar mx-auto mb-2 bg-gradient-to-r from-purple-400 to-purple-600 flex items-center justify-center text-2xl font-bold" x-text="shareMatchData?.matchName?.charAt(0)"></div>
                                </template>
                                <p class="text-sm font-medium" x-text="shareMatchData?.matchName"></p>
                                <span class="share-badge" x-text="shareMatchData?.matchSkill"></span>
                            </div>
                        </div>
                        <div class="space-y-2 mb-6">
                            <div class="share-badge text-lg"><i class="fas fa-chart-line mr-2"></i>åŒ¹é…åº¦ <span x-text="shareMatchData?.matchScore"></span>%</div>
                            <div class="share-badge" x-show="shareMatchData?.sameCity"><i class="fas fa-map-marker-alt mr-2"></i>åŒåŸä¼™ä¼´ Â· <span x-text="shareMatchData?.city"></span></div>
                        </div>
                        <div class="text-sm text-white text-opacity-80">
                            <p>ğŸ’¡ æŠ€èƒ½äº¤æ¢ï¼Œè®©çŸ¥è¯†æµåŠ¨èµ·æ¥</p>
                            <p class="mt-1">æ‰«ç åŠ å…¥çŸ¥èˆŸï¼Œæ‰¾åˆ°ä½ çš„æŠ€èƒ½ä¼™ä¼´</p>
                        </div>
                    </div>
                </div>
                <div class="space-y-3">
                    <button @click="downloadShareCard" class="w-full py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white font-medium rounded-lg hover:from-blue-600 hover:to-blue-700 transition flex items-center justify-center"><i class="fas fa-download mr-2"></i>ä¸‹è½½åˆ†äº«å¡ç‰‡</button>
                    <button @click="shareToSocial" class="w-full py-3 bg-gradient-to-r from-green-500 to-green-600 text-white font-medium rounded-lg hover:from-green-600 hover:to-green-700 transition flex items-center justify-center"><i class="fas fa-share-alt mr-2"></i>åˆ†äº«åˆ°å¾®ä¿¡/æœ‹å‹åœˆ</button>
                    <button @click="copyShareText" class="w-full py-3 border border-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-50 transition flex items-center justify-center"><i class="fas fa-copy mr-2"></i>å¤åˆ¶åˆ†äº«æ–‡æ¡ˆ</button>
                </div>
            </div>
        </div>

        <!-- ===================== æ–°å¢ï¼šå‘å¸ƒç²¾å½©æ—¶åˆ»æ¨¡æ€æ¡† ===================== -->
        <div x-show="showCreateMomentModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" x-transition>
            <div class="glasscard w-full max-w-lg p-6 max-h-[90vh] overflow-y-auto" @click.away="showCreateMomentModal = false">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-800">ğŸ“¸ åˆ†äº«ç²¾å½©æ—¶åˆ»</h2>
                    <button @click="showCreateMomentModal = false" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times text-xl"></i></button>
                </div>
                <form @submit.prevent="submitMoment" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">æ ‡é¢˜</label>
                        <input type="text" x-model="momentForm.title" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition" placeholder="ç»™ä½ çš„æ•…äº‹èµ·ä¸ªæ ‡é¢˜" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">åˆ†äº«å†…å®¹</label>
                        <textarea x-model="momentForm.description" rows="4" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition" placeholder="åˆ†äº«ä½ ä»¬çš„æŠ€èƒ½äº¤æ¢æ•…äº‹..." required></textarea>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">æˆ‘åˆ†äº«çš„æŠ€èƒ½</label>
                            <input type="text" x-model="momentForm.skill_given" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition" placeholder="ä¾‹å¦‚ï¼šPythonç¼–ç¨‹">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">æˆ‘å­¦åˆ°çš„æŠ€èƒ½</label>
                            <input type="text" x-model="momentForm.skill_received" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition" placeholder="ä¾‹å¦‚ï¼šæ‘„å½±æŠ€å·§">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ä¸Šä¼ å›¾ç‰‡æˆ–è§†é¢‘</label>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-500 transition cursor-pointer" @click="$refs.momentFile.click()">
                            <input type="file" x-ref="momentFile" @change="handleMomentFileUpload" accept="image/*,video/*" class="hidden">
                            <template x-if="!momentForm.preview_url">
                                <div>
                                    <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-2"></i>
                                    <p class="text-gray-500">ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡æˆ–è§†é¢‘</p>
                                    <p class="text-gray-400 text-sm">æ”¯æŒ JPGã€PNGã€MP4ï¼Œæœ€å¤§ 20MB</p>
                                </div>
                            </template>
                            <template x-if="momentForm.preview_url">
                                <div>
                                    <img :src="momentForm.preview_url" class="max-h-48 mx-auto rounded-lg">
                                    <p class="text-sm text-gray-500 mt-2">ç‚¹å‡»æ›´æ¢æ–‡ä»¶</p>
                                </div>
                            </template>
                        </div>
                    </div>
                    <div class="flex space-x-3 pt-4">
                        <button type="submit" :disabled="momentForm.submitting" class="flex-1 py-3 bg-gradient-to-r from-pink-500 to-purple-600 text-white font-medium rounded-lg hover:from-pink-600 hover:to-purple-700 transition disabled:opacity-50">
                            <span x-show="!momentForm.submitting">å‘å¸ƒåˆ†äº«</span>
                            <span x-show="momentForm.submitting"><span class="loading-spinner mr-2 border-white border-t-transparent"></span>å‘å¸ƒä¸­...</span>
                        </button>
                        <button type="button" @click="showCreateMomentModal = false" class="flex-1 py-3 border border-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-50 transition">å–æ¶ˆ</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- ===================== æ–°å¢ï¼šè¯„è®ºæ¨¡æ€æ¡† ===================== -->
        <div x-show="showCommentModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" x-transition>
            <div class="glasscard w-full max-w-lg p-6 max-h-[90vh] overflow-y-auto" @click.away="showCommentModal = false">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-800">ğŸ’¬ è¯„è®º</h2>
                    <button @click="showCommentModal = false" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times text-xl"></i></button>
                </div>
                <div class="space-y-4 mb-6 max-h-96 overflow-y-auto">
                    <template x-for="comment in currentMomentComments" :key="comment.id">
                        <div class="flex gap-3 p-3 bg-gray-50 rounded-lg">
                            <template x-if="comment.author_avatar">
                                <img :src="comment.author_avatar" class="w-8 h-8 rounded-full object-cover">
                            </template>
                            <template x-else>
                                <div class="w-8 h-8 rounded-full bg-gradient-to-r from-blue-500 to-blue-600 flex items-center justify-center text-white text-xs font-bold" x-text="comment.author_name.charAt(0)"></div>
                            </template>
                            <div class="flex-1">
                                <div class="flex justify-between items-start">
                                    <p class="font-medium text-sm text-gray-800" x-text="comment.author_name"></p>
                                    <p class="text-xs text-gray-400" x-text="formatTimeAgo(comment.created_at)"></p>
                                </div>
                                <p class="text-sm text-gray-600 mt-1" x-text="comment.content"></p>
                            </div>
                        </div>
                    </template>
                    <div x-show="currentMomentComments.length === 0" class="text-center py-8 text-gray-500">
                        æš‚æ— è¯„è®ºï¼Œæ¥è¯´ç‚¹ä»€ä¹ˆå§ï½
                    </div>
                </div>
                <div class="flex gap-3">
                    <input type="text" x-model="newCommentContent" @keyup.enter="submitComment" class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition" placeholder="å†™ä¸‹ä½ çš„è¯„è®º...">
                    <button @click="submitComment" :disabled="!newCommentContent.trim()" class="px-6 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white font-medium rounded-lg hover:from-blue-600 hover:to-blue-700 transition disabled:opacity-50">å‘é€</button>
                </div>
            </div>
        </div>

        <!-- ===================== æ–°å¢ï¼šå‘å¸ƒå­¦ä¹ æ­å­æ¨¡æ€æ¡† ===================== -->
        <div x-show="showBuddyModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" x-transition>
            <div class="glasscard w-full max-w-md p-6" @click.away="showBuddyModal = false">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-800">å‘å¸ƒå­¦ä¹ æ­å­ä¿¡æ¯</h2>
                    <button @click="showBuddyModal = false" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times text-xl"></i></button>
                </div>
                <form @submit.prevent="submitBuddy">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">å­¦ä¹ ç›®æ ‡ <span class="text-red-500">*</span></label>
                            <input type="text" x-model="newBuddy.goal" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" placeholder="ä¾‹å¦‚ï¼šè€ƒç ”æ•°å­¦ã€è‹±è¯­å£è¯­" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">å­¦ä¹ æ—¶é—´æ®µ <span class="text-red-500">*</span></label>
                            <input type="text" x-model="newBuddy.time_slot" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" placeholder="ä¾‹å¦‚ï¼šæ¯æ™š7-10ç‚¹ã€å‘¨æœ«å…¨å¤©" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">åŸå¸‚ï¼ˆé€‰å¡«ï¼‰</label>
                            <input type="text" x-model="newBuddy.city" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" placeholder="ä¾‹å¦‚ï¼šåŒ—äº¬å¸‚">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">å­¦ä¹ æ–¹å¼</label>
                            <div class="flex space-x-4">
                                <label class="flex items-center"><input type="radio" x-model="newBuddy.mode" value="çº¿ä¸Š" class="mr-2">çº¿ä¸Š</label>
                                <label class="flex items-center"><input type="radio" x-model="newBuddy.mode" value="çº¿ä¸‹" class="mr-2">çº¿ä¸‹</label>
                                <label class="flex items-center"><input type="radio" x-model="newBuddy.mode" value="å‡å¯" class="mr-2">å‡å¯</label>
                            </div>
                        </div>
                    </div>
                    <div class="flex space-x-3 pt-6">
                        <button type="submit" :disabled="!newBuddy.goal || !newBuddy.time_slot" class="flex-1 py-3 bg-gradient-to-r from-green-500 to-green-600 text-white font-medium rounded-lg hover:from-green-600 hover:to-green-700 transition disabled:opacity-50 disabled:cursor-not-allowed">å‘å¸ƒ</button>
                        <button type="button" @click="showBuddyModal = false" class="flex-1 py-3 border border-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-50 transition">å–æ¶ˆ</button>
                    </div>
                </form>
            </div>
        </div>

    </div>

    <!-- é€šçŸ¥åŒºåŸŸ -->
    <div class="fixed top-4 right-4 z-50 space-y-3">
        <template x-for="notification in notifications" :key="notification.id">
            <div x-show="notification.visible" x-transition :class="{'bg-green-100 border-green-400 text-green-800': notification.type === 'success', 'bg-red-100 border-red-400 text-red-800': notification.type === 'error', 'bg-blue-100 border-blue-400 text-blue-800': notification.type === 'info'}" class="border rounded-lg p-4 shadow-lg max-w-sm">
                <div class="flex justify-between items-start">
                    <div class="flex items-center">
                        <i :class="{'fas fa-check-circle text-green-600': notification.type === 'success', 'fas fa-exclamation-circle text-red-600': notification.type === 'error', 'fas fa-info-circle text-blue-600': notification.type === 'info'}" class="mr-3"></i>
                        <div>
                            <h4 class="font-medium" x-text="notification.title"></h4>
                            <p class="text-sm mt-1" x-text="notification.message"></p>
                        </div>
                    </div>
                    <button @click="closeNotification(notification.id)" class="text-gray-500 hover:text-gray-700 ml-4"><i class="fas fa-times"></i></button>
                </div>
            </div>
        </template>
    </div>

    <!-- Alpine.js åº”ç”¨é€»è¾‘ï¼ˆä¿ç•™å…¨éƒ¨åŸæœ‰æ–¹æ³•ï¼Œå¹¶æ–°å¢ confirmClearChat / clearChatMessagesï¼‰ -->
    <script>
        const SUPABASE_URL = 'https://bsxrwsgewqgeeikfeeoa.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_kABjoeJgvH8l196MDbpA-A_3YyAGNqo';
        
        document.addEventListener('alpine:init', () => {
            Alpine.data('app', () => ({
                supabase: null,
                
                // åŸæœ‰çŠ¶æ€ï¼ˆå®Œå…¨ä¿ç•™ï¼‰
                authMode: 'login',
                activeTab: 'profile',
                profileSubTab: 'info',
                isAuthenticated: false,
                loading: false,
                currentUser: null,
                userProfile: {},
                loginForm: { email: '', password: '' },
                registerForm: { email: '', password: '', username: '', teachSkills: '', learnSkills: '' },
                editForm: { username: '', city: '', teach_skill: '', learn_skill: '', bio: '', avatar_url: '' },
                showEditModal: false,
                newSkill: { title: '', description: '', category: '', teachingMethod: 'åœ¨çº¿', city: '' },
                showSkillModal: false,
                skills: [],
                searchQuery: '',
                skillFilter: '',
                showSameCityOnly: false,
                favorites: [],
                favoriteSkills: [],
                showViewProfileModal: false,
                viewProfileLoading: false,
                viewedUserProfile: null,
                matches: [],
                conversations: [],
                selectedConversationId: null,
                selectedConversation: null,
                selectedConversationMessages: [],
                newMessage: '',
                unreadCount: 0,
                searchConversation: '',
                deletedConversations: [],
                showVideoRoomModal: false,
                isCreatingVideoRoom: false,
                videoRoomUrl: '',
                videoRoomPassword: '',
                videoError: '',
                communityView: 'allEvents',
                communityEvents: [],
                filteredCommunityEvents: [],
                currentEventDetail: null,
                communityCityFilter: '',
                communityTypeFilter: '',
                communityDateFilter: 'all',
                showCreateEventModal: false,
                eventCreating: false,
                showEditEventModal: false,
                editingEvent: null,
                newEvent: { title: '', event_type: 'æ²™é¾™', description: '', event_date: '', start_time: '', end_time: '', max_people: 10, city: '', address: '', fee_info: '', notes: '', disclaimer_accepted: false },
                notifications: [],
                notificationId: 0,
                messagePollTimer: null,
                isRegistering: false,
                
                // è¯„ä»·ç³»ç»ŸçŠ¶æ€ï¼ˆéƒ¨åˆ†ä¿ç•™ï¼‰
                showReviewModal: false,
                reviewTarget: null,
                reviewForm: {
                    skill_level: 0,
                    teaching_attitude: 0,
                    punctuality: 0,
                    communication: 0,
                    hover_skill: 0,
                    hover_teaching: 0,
                    hover_punctuality: 0,
                    hover_communication: 0,
                    tags: [],
                    content: '',
                    is_anonymous: false
                },
                myReviews: [],
                userReviewStats: {
                    total_reviews: 0,
                    avg_skill_level: 0,
                    avg_teaching_attitude: 0,
                    avg_punctuality: 0,
                    avg_communication: 0,
                    overall_rating: 0,
                    positive_rate: 0
                },
                
                // åˆ†äº«ç³»ç»ŸçŠ¶æ€
                showMatchShareModal: false,
                shareMatchData: null,
                moments: [],
                showCreateMomentModal: false,
                momentForm: {
                    title: '',
                    description: '',
                    skill_given: '',
                    skill_received: '',
                    media_type: 'image',
                    media_url: '',
                    preview_url: '',
                    submitting: false
                },

                // è¯„è®ºæ¨¡æ€æ¡†çŠ¶æ€
                showCommentModal: false,
                currentMomentComments: [],
                currentCommentMomentId: null,
                newCommentContent: '',

                // ========== æ–°å¢ï¼šå­¦ä¹ æ­å­çŠ¶æ€ ==========
                buddies: [],
                filteredBuddies: [],
                showBuddyModal: false,
                newBuddy: {
                    goal: '',
                    time_slot: '',
                    city: '',
                    mode: 'çº¿ä¸Š'
                },
                buddySearchInput: '',
                buddySearchKeyword: '',
                buddyGoalFilter: '',
                buddyModeFilter: '',
                sameCityActive: false,
                savedBuddies: [],
                savedBuddiesList: [],
                
                // ========== æ–°å¢ï¼šä»–äººèµ„æ–™é¡µè¯„ä»·çŠ¶æ€ ==========
                recentReviews: [],       // æœ€æ–°ä¸‰æ¡è¯„ä»·
                showAllReviews: false,   // æ§åˆ¶â€œæŸ¥çœ‹å…¨éƒ¨â€å¼¹çª—
                allReviews: [],          // æ‰€æœ‰è¯„ä»·ï¼ˆç”¨äºå¼¹çª—ï¼‰
                
                // ========== åˆå§‹åŒ– ==========
                async init() {
                    let retries = 0;
                    while (!window.supabase && retries < 50) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                        retries++;
                    }
                    if (!window.supabase) {
                        this.showNotification('error', 'åŠ è½½å¤±è´¥', 'æ ¸å¿ƒåº“åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢');
                        return;
                    }
                    this.supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    this.loadDeletedConversations();
                    await this.checkAuthStatus();
                    if (this.isAuthenticated) {
                        await this.loadUserProfile();
                        await this.loadUserReviewStats();
                        await this.loadMatches();
                        await this.loadSkills();
                        await this.loadConversations();
                        await this.loadCommunityEvents();
                        await this.loadFavorites();
                        await this.loadMoments();
                        await this.loadBuddies();
                        await this.loadSavedBuddies();
                    }
                    this.supabase.auth.onAuthStateChange((event, session) => {
                        if (event === 'SIGNED_IN' || event === 'USER_UPDATED') {
                            this.isAuthenticated = true;
                            this.currentUser = session.user;
                            this.loadUserProfile();
                            this.loadUserReviewStats();
                            this.loadMatches();
                            this.loadSkills();
                            this.loadConversations();
                            this.loadCommunityEvents();
                            this.loadFavorites();
                            this.loadMoments();
                            this.loadBuddies();
                            this.loadSavedBuddies();
                        } else if (event === 'SIGNED_OUT') {
                            this.resetState();
                        }
                    });
                    this.$watch('activeTab', (value) => {
                        if (value === 'messages' && this.isAuthenticated) {
                            this.startMessagePolling();
                        } else {
                            this.stopMessagePolling();
                        }
                    });
                },
                
                resetState() {
                    this.isAuthenticated = false;
                    this.currentUser = null;
                    this.userProfile = {};
                    this.matches = [];
                    this.conversations = [];
                    this.skills = [];
                    this.communityEvents = [];
                    this.favorites = [];
                    this.favoriteSkills = [];
                    this.myReviews = [];
                    this.moments = [];
                    this.buddies = [];
                    this.filteredBuddies = [];
                    this.savedBuddies = [];
                    this.savedBuddiesList = [];
                    this.stopMessagePolling();
                },
                
                // ========== åŸæœ‰æ–¹æ³•ï¼ˆå®Œå…¨ä¿ç•™ï¼‰==========
                async checkAuthStatus() {
                    try {
                        const { data: { session } } = await this.supabase.auth.getSession();
                        if (session) {
                            this.isAuthenticated = true;
                            this.currentUser = session.user;
                        }
                    } catch (error) {
                        console.error('æ£€æŸ¥è®¤è¯çŠ¶æ€å¤±è´¥:', error);
                    }
                },
                
                async loadUserProfile() {
                    if (!this.currentUser) return;
                    try {
                        const { data, error } = await this.supabase
                            .from('profiles')
                            .select('*')
                            .eq('id', this.currentUser.id)
                            .single();
                        if (error) {
                            if (error.code === 'PGRST116') {
                                await this.waitForProfile();
                                return;
                            }
                            throw error;
                        }
                        this.userProfile = data;
                        this.editForm = {
                            username: data.username || '',
                            city: data.city || '',
                            teach_skill: data.teach_skill || '',
                            learn_skill: data.learn_skill || '',
                            bio: data.bio || '',
                            avatar_url: data.avatar_url || ''
                        };
                    } catch (error) {
                        console.error('åŠ è½½ç”¨æˆ·èµ„æ–™å¤±è´¥:', error);
                    }
                },
                
                async waitForProfile(maxRetries = 5) {
                    let retries = 0;
                    while (retries < maxRetries) {
                        await new Promise(resolve => setTimeout(resolve, 500));
                        try {
                            const { data, error } = await this.supabase
                                .from('profiles')
                                .select('*')
                                .eq('id', this.currentUser.id)
                                .single();
                            if (data && !error) {
                                this.userProfile = data;
                                return;
                            }
                        } catch (e) {}
                        retries++;
                    }
                    await this.createUserProfile();
                },
                
                async createUserProfile() {
                    try {
                        const { error } = await this.supabase
                            .from('profiles')
                            .insert({
                                id: this.currentUser.id,
                                username: this.currentUser.user_metadata?.username || this.currentUser.email.split('@')[0],
                                email: this.currentUser.email,
                                teach_skill: this.currentUser.user_metadata?.teach_skill || '',
                                learn_skill: this.currentUser.user_metadata?.learn_skill || '',
                                created_at: new Date().toISOString(),
                                updated_at: new Date().toISOString()
                            });
                        if (error && error.code !== '23505') throw error;
                        await this.loadUserProfile();
                    } catch (error) {
                        console.error('åˆ›å»ºç”¨æˆ·èµ„æ–™å¤±è´¥:', error);
                    }
                },
                
                async updateProfile() {
                    if (!this.currentUser) return;
                    this.loading = true;
                    try {
                        const cleanSkill = (skill) => {
                            if (!skill) return '';
                            return skill.trim().replace(/[ã€ï¼Œ,]/g, ',').split(',')[0].trim();
                        };
                        const updates = {
                            username: this.editForm.username || '',
                            city: this.editForm.city || '',
                            teach_skill: cleanSkill(this.editForm.teach_skill),
                            learn_skill: cleanSkill(this.editForm.learn_skill),
                            bio: this.editForm.bio || '',
                            avatar_url: this.editForm.avatar_url || null,
                            updated_at: new Date().toISOString()
                        };
                        const { error } = await this.supabase
                            .from('profiles')
                            .update(updates)
                            .eq('id', this.currentUser.id);
                        if (error) throw error;
                        this.userProfile = { ...this.userProfile, ...updates };
                        this.showEditModal = false;
                        this.showNotification('success', 'æ›´æ–°æˆåŠŸ', 'ä¸ªäººèµ„æ–™å·²æ›´æ–°');
                        await this.loadMatches();
                    } catch (error) {
                        console.error('æ›´æ–°ç”¨æˆ·èµ„æ–™å¤±è´¥:', error);
                        this.showNotification('error', 'æ›´æ–°å¤±è´¥', 'æ— æ³•æ›´æ–°ä¸ªäººèµ„æ–™');
                    } finally {
                        this.loading = false;
                    }
                },
                
                async handleLogin() {
                    if (!this.loginForm.email || !this.loginForm.password) {
                        this.showNotification('error', 'è¾“å…¥é”™è¯¯', 'è¯·å¡«å†™é‚®ç®±å’Œå¯†ç ');
                        return;
                    }
                    this.loading = true;
                    try {
                        const { data, error } = await this.supabase.auth.signInWithPassword({
                            email: this.loginForm.email,
                            password: this.loginForm.password
                        });
                        if (error) throw error;
                        this.isAuthenticated = true;
                        this.currentUser = data.user;
                        this.loginForm = { email: '', password: '' };
                        await this.loadUserProfile();
                        await this.loadUserReviewStats();
                        await this.loadMatches();
                        await this.loadSkills();
                        await this.loadConversations();
                        await this.loadCommunityEvents();
                        await this.loadFavorites();
                        await this.loadMoments();
                        await this.loadBuddies();
                        await this.loadSavedBuddies();
                        this.showNotification('success', 'ç™»å½•æˆåŠŸ', 'æ¬¢è¿å›æ¥ï¼');
                    } catch (error) {
                        this.showNotification('error', 'ç™»å½•å¤±è´¥', error.message);
                    } finally {
                        this.loading = false;
                    }
                },
                
                async handleRegister() {
                    if (this.isRegistering) return;
                    if (!this.registerForm.email || !this.registerForm.password || !this.registerForm.username) {
                        this.showNotification('error', 'è¾“å…¥é”™è¯¯', 'è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
                        return;
                    }
                    if (this.registerForm.password.length < 6) {
                        this.showNotification('error', 'å¯†ç å¤ªçŸ­', 'å¯†ç è‡³å°‘éœ€è¦6ä½');
                        return;
                    }
                    this.loading = true;
                    this.isRegistering = true;
                    try {
                        const processSkills = (skillText) => {
                            if (!skillText) return '';
                            const skills = skillText.split('\n').map(s => s.trim()).filter(s => s).slice(0, 5);
                            return skills[0] || '';
                        };
                        const mainTeachSkill = processSkills(this.registerForm.teachSkills);
                        const mainLearnSkill = processSkills(this.registerForm.learnSkills);
                        const { data: authData, error: authError } = await this.supabase.auth.signUp({
                            email: this.registerForm.email,
                            password: this.registerForm.password,
                            options: {
                                data: {
                                    username: this.registerForm.username,
                                    teach_skill: mainTeachSkill,
                                    learn_skill: mainLearnSkill
                                }
                            }
                        });
                        if (authData?.user) {
                            await new Promise(resolve => setTimeout(resolve, 500));
                            try {
                                await this.supabase.from('profiles').upsert([{
                                    id: authData.user.id,
                                    username: this.registerForm.username,
                                    email: this.registerForm.email,
                                    city: '',
                                    teach_skill: mainTeachSkill,
                                    learn_skill: mainLearnSkill,
                                    created_at: new Date().toISOString(),
                                    updated_at: new Date().toISOString()
                                }], { onConflict: 'id' });
                            } catch (e) {}
                            this.isAuthenticated = true;
                            this.currentUser = authData.user;
                            this.registerForm = { email: '', password: '', username: '', teachSkills: '', learnSkills: '' };
                            await this.loadUserProfile();
                            await this.loadMatches();
                            await this.loadSkills();
                            await this.loadMoments();
                            await this.loadBuddies();
                            await this.loadSavedBuddies();
                            this.showNotification('success', 'æ³¨å†ŒæˆåŠŸ', 'æ¬¢è¿åŠ å…¥çŸ¥èˆŸï¼');
                            this.activeTab = 'profile';
                        } else if (authError) {
                            throw authError;
                        }
                    } catch (error) {
                        this.showNotification('error', 'æ³¨å†Œå¤±è´¥', error.message);
                    } finally {
                        this.loading = false;
                        setTimeout(() => this.isRegistering = false, 2000);
                    }
                },
                
                async logout() {
                    try {
                        await this.supabase.auth.signOut();
                        this.resetState();
                        this.showNotification('success', 'å·²é€€å‡º', 'æ‚¨å·²æˆåŠŸé€€å‡º');
                    } catch (error) {
                        this.showNotification('error', 'é€€å‡ºå¤±è´¥', error.message);
                    }
                },
                
                // ========== æŠ€èƒ½ç›¸å…³ï¼ˆå®Œå…¨ä¿ç•™åŸæœ‰ï¼‰==========
                
                async loadSkills() {
                    try {
                        const { data, error } = await this.supabase
                            .from('skills')
                            .select('*')
                            .order('created_at', { ascending: false });
                        if (error) {
                            console.error('åŠ è½½æŠ€èƒ½å¤±è´¥:', error);
                            this.loadMockSkills();
                            return;
                        }
                        if (!data || data.length === 0) {
                            this.loadMockSkills();
                            return;
                        }
                        this.skills = data.map(skill => {
                            let tags = skill.tags || [];
                            if (typeof tags === 'string') {
                                tags = tags.split(',').map(tag => tag.trim()).filter(tag => tag);
                            }
                            return {
                                id: skill.id.toString(),
                                user_id: skill.user_id,
                                title: skill.title || 'æœªå‘½åæŠ€èƒ½',
                                author: skill.author || 'åŒ¿åç”¨æˆ·',
                                description: skill.description || 'æš‚æ— æè¿°',
                                category: skill.category || 'æœªåˆ†ç±»',
                                city: skill.city || '',
                                tags: tags,
                                method: skill.method || 'çº¿ä¸Šæ•™å­¦',
                                schedule: skill.schedule || 'æ—¶é—´çµæ´»',
                                created_at: skill.created_at || new Date().toISOString(),
                                user_rating: skill.user_rating || 0
                            };
                        });
                    } catch (error) {
                        console.error('æŠ€èƒ½åŠ è½½é”™è¯¯:', error);
                        this.loadMockSkills();
                    }
                },
                
                loadMockSkills() {
                    this.skills = [
                        { id: '1', title: 'Pythonç¼–ç¨‹å…¥é—¨', author: 'å¼ è€å¸ˆ', description: 'ä»é›¶å¼€å§‹å­¦ä¹ Pythonç¼–ç¨‹ï¼Œé€‚åˆå®Œå…¨æ²¡æœ‰ç¼–ç¨‹åŸºç¡€çš„æ–°æ‰‹ã€‚', category: 'ç¼–ç¨‹å¼€å‘', city: 'åŒ—äº¬å¸‚', tags: ['ç¼–ç¨‹', 'Python', 'å…¥é—¨'], method: 'çº¿ä¸Šæ•™å­¦', schedule: 'å‘¨æœ«å…¨å¤©', created_at: '2023-10-15T10:30:00Z', user_rating: 4.8 },
                        { id: '2', title: 'å•†åŠ¡è‹±è¯­å£è¯­', author: 'æè€å¸ˆ', description: 'ä¸“æ³¨äºå•†åŠ¡åœºæ™¯ä¸‹çš„è‹±è¯­å£è¯­è¡¨è¾¾ï¼Œæå‡èŒåœºæ²Ÿé€šèƒ½åŠ›ã€‚', category: 'è¯­è¨€å­¦ä¹ ', city: 'ä¸Šæµ·å¸‚', tags: ['è‹±è¯­', 'å•†åŠ¡', 'å£è¯­'], method: 'çº¿ä¸Š+çº¿ä¸‹', schedule: 'å·¥ä½œæ—¥æ™šä¸Š', created_at: '2023-10-18T14:20:00Z', user_rating: 4.5 },
                        { id: '3', title: 'æ‰‹æœºæ‘„å½±æŠ€å·§', author: 'ç‹æ‘„å½±å¸ˆ', description: 'æ•™ä½ å¦‚ä½•ç”¨æ‰‹æœºæ‹å‡ºä¸“ä¸šçº§åˆ«çš„ç…§ç‰‡ï¼Œæ— éœ€ä¸“ä¸šè®¾å¤‡ã€‚', category: 'è®¾è®¡åˆ›æ„', city: 'åŒ—äº¬å¸‚', tags: ['æ‘„å½±', 'æ‰‹æœº', 'è‰ºæœ¯'], method: 'è§†é¢‘æ•™ç¨‹', schedule: 'æ—¶é—´çµæ´»', created_at: '2023-10-20T09:15:00Z', user_rating: 4.9 },
                        { id: '4', title: 'å®¶å¸¸èœçƒ¹é¥ª', author: 'é™ˆå¤§å¨', description: 'å­¦ä¹ åˆ¶ä½œç¾å‘³å®¶å¸¸èœï¼Œè®©å®¶äººäº«å—å¥åº·ç¾é£Ÿã€‚', category: 'ç”Ÿæ´»æŠ€èƒ½', city: 'åŒ—äº¬å¸‚', tags: ['çƒ¹é¥ª', 'ç¾é£Ÿ', 'ç”Ÿæ´»'], method: 'çº¿ä¸‹æ•™å­¦', schedule: 'å‘¨æœ«ä¸‹åˆ', created_at: '2023-10-22T16:45:00Z', user_rating: 4.7 },
                        { id: '5', title: 'ç‘œä¼½åŸºç¡€ä¸è¿›é˜¶', author: 'æç‘œä¼½', description: 'ä»åŸºç¡€åˆ°è¿›é˜¶çš„ç‘œä¼½æ•™å­¦ï¼Œé€‚åˆå„æ°´å¹³å­¦å‘˜ã€‚', category: 'è¿åŠ¨å¥èº«', city: 'åŒ—äº¬å¸‚', tags: ['ç‘œä¼½', 'å¥èº«', 'å¥åº·'], method: 'çº¿ä¸‹æ•™å­¦', schedule: 'å‘¨æœ«ä¸Šåˆ', created_at: '2023-10-24T09:30:00Z', user_rating: 4.6 }
                    ];
                },
                
                openSkillModal() {
                    if (!this.currentUser) {
                        this.showNotification('warning', 'è¯·å…ˆç™»å½•', 'ç™»å½•åæ‰èƒ½å‘å¸ƒæŠ€èƒ½');
                        return;
                    }
                    if (this.userProfile && this.userProfile.city) {
                        this.newSkill.city = this.userProfile.city;
                    }
                    this.showSkillModal = true;
                },
                
                async publishSkill() {
                    if (!this.currentUser) {
                        this.showNotification('warning', 'è¯·å…ˆç™»å½•', 'ç™»å½•åæ‰èƒ½å‘å¸ƒæŠ€èƒ½');
                        return;
                    }
                    if (!this.newSkill.title.trim() || !this.newSkill.description.trim() || !this.newSkill.category) {
                        this.showNotification('error', 'ä¿¡æ¯ä¸å®Œæ•´', 'è¯·å¡«å†™æ ‡é¢˜ã€æè¿°å’Œåˆ†ç±»');
                        return;
                    }
                    this.loading = true;
                    try {
                        const skillData = {
                            user_id: this.currentUser.id,
                            author: this.userProfile.username || this.currentUser.email.split('@')[0] || 'åŒ¿åç”¨æˆ·',
                            title: this.newSkill.title.trim(),
                            description: this.newSkill.description.trim(),
                            category: this.newSkill.category,
                            method: this.newSkill.teachingMethod || 'åœ¨çº¿',
                            city: this.newSkill.city || (this.userProfile && this.userProfile.city) || 'æœªè®¾ç½®',
                            created_at: new Date().toISOString(),
                            updated_at: new Date().toISOString()
                        };
                        const { data, error } = await this.supabase
                            .from('skills')
                            .insert([skillData])
                            .select();
                        if (error) throw error;
                        this.newSkill = { title: '', description: '', category: '', teachingMethod: 'åœ¨çº¿', city: '' };
                        this.showSkillModal = false;
                        this.showNotification('success', 'å‘å¸ƒæˆåŠŸ', 'æŠ€èƒ½å·²æˆåŠŸå‘å¸ƒï¼');
                        await this.loadSkills();
                        await this.updateUserTeachSkills(skillData.title);
                    } catch (error) {
                        console.error('å‘å¸ƒæŠ€èƒ½å¤±è´¥:', error);
                        this.showNotification('error', 'å‘å¸ƒå¤±è´¥', error.message || 'å‘å¸ƒæŠ€èƒ½æ—¶å‡ºç°å¼‚å¸¸');
                    } finally {
                        this.loading = false;
                    }
                },
                
                async updateUserTeachSkills(newSkill) {
                    if (!this.userProfile || !this.currentUser) return;
                    try {
                        const currentSkills = this.userProfile.teach_skill || '';
                        const skillsArray = currentSkills.split(',').filter(s => s.trim());
                        if (!skillsArray.includes(newSkill)) {
                            skillsArray.push(newSkill);
                            const updatedSkills = skillsArray.join(',');
                            await this.supabase
                                .from('profiles')
                                .update({ teach_skill: updatedSkills, updated_at: new Date().toISOString() })
                                .eq('id', this.currentUser.id);
                        }
                    } catch (error) {
                        console.warn('æ›´æ–°ç”¨æˆ·æŠ€èƒ½å¤±è´¥:', error);
                    }
                },
                
                searchSkills() {
                    console.log('æœç´¢æŠ€èƒ½:', this.searchQuery, this.skillFilter);
                },
                
                get filteredSkills() {
                    let filtered = this.skills;
                    if (this.searchQuery) {
                        const query = this.searchQuery.toLowerCase();
                        filtered = filtered.filter(skill => 
                            skill.title.toLowerCase().includes(query) ||
                            skill.description.toLowerCase().includes(query) ||
                            skill.author.toLowerCase().includes(query) ||
                            (skill.tags && skill.tags.some(tag => tag.toLowerCase().includes(query)))
                        );
                    }
                    if (this.skillFilter) {
                        filtered = filtered.filter(skill => {
                            if (this.skillFilter === 'teach') return skill.category !== 'è¯­è¨€å­¦ä¹ ';
                            else if (this.skillFilter === 'learn') return skill.category === 'è¯­è¨€å­¦ä¹ ';
                            return true;
                        });
                    }
                    if (this.showSameCityOnly && this.userProfile && this.userProfile.city) {
                        const userCity = this.userProfile.city;
                        filtered = filtered.filter(skill => {
                            if (!skill.city) return false;
                            return this.isSameCity(userCity, skill.city);
                        });
                    }
                    return filtered;
                },
                
                toggleSameCityFilter() {
                    if (!this.userProfile || !this.userProfile.city) {
                        this.showNotification('warning', 'è¯·å…ˆè®¾ç½®åŸå¸‚', 'è¯·åœ¨ä¸ªäººä¸­å¿ƒè®¾ç½®æ‚¨çš„åŸå¸‚ï¼Œæ‰èƒ½ä½¿ç”¨åŒåŸç­›é€‰åŠŸèƒ½');
                        this.activeTab = 'profile';
                        this.showEditModal = true;
                        return;
                    }
                    this.showSameCityOnly = !this.showSameCityOnly;
                },
                
                getEmptyStateMessage() {
                    if (this.showSameCityOnly && this.userProfile && this.userProfile.city) {
                        return `å½“å‰æ²¡æœ‰æ‰¾åˆ°ä¸"${this.userProfile.city}"åŒåŸçš„æŠ€èƒ½`;
                    }
                    if (this.searchQuery) return `æ²¡æœ‰æ‰¾åˆ°"${this.searchQuery}"ç›¸å…³çš„æŠ€èƒ½`;
                    if (this.skillFilter) return this.skillFilter === 'teach' ? 'æš‚æ—¶æ²¡æœ‰å¯åˆ†äº«çš„æŠ€èƒ½' : 'æš‚æ—¶æ²¡æœ‰å¯å­¦ä¹ çš„æŠ€èƒ½';
                    return 'è¿˜æ²¡æœ‰æŠ€èƒ½å‘å¸ƒ';
                },
                
                resetFilters() {
                    this.searchQuery = '';
                    this.skillFilter = '';
                    this.showSameCityOnly = false;
                },
                
                // ========== æ”¶è—åŠŸèƒ½ ==========
                
                async loadFavorites() {
                    if (!this.currentUser) return;
                    try {
                        const { data, error } = await this.supabase
                            .from('favorites')
                            .select('*')
                            .eq('user_id', this.currentUser.id)
                            .eq('target_type', 'skill');
                        
                        if (error) throw error;
                        this.favorites = data || [];
                        
                        if (this.favorites.length > 0) {
                            const skillIds = this.favorites.map(f => f.target_id);
                            const { data: skills, error: skillsError } = await this.supabase
                                .from('skills')
                                .select('*')
                                .in('id', skillIds);
                            
                            if (!skillsError && skills) {
                                this.favoriteSkills = this.favorites.map(fav => {
                                    const skill = skills.find(s => s.id.toString() === fav.target_id.toString());
                                    if (!skill) return null;
                                    let tags = skill.tags || [];
                                    if (typeof tags === 'string') tags = tags.split(',').map(t => t.trim()).filter(t => t);
                                    return {
                                        ...skill,
                                        tags,
                                        id: skill.id.toString(),
                                        favorite_id: fav.id
                                    };
                                }).filter(Boolean);
                            }
                        } else {
                            this.favoriteSkills = [];
                        }
                    } catch (error) {
                        console.error('åŠ è½½æ”¶è—å¤±è´¥:', error);
                    }
                },
                
                isFavorite(skillId) {
                    return this.favorites.some(f => f.target_type === 'skill' && f.target_id.toString() === skillId.toString());
                },
                
                async toggleFavorite(skill) {
                    if (!this.currentUser) {
                        this.showNotification('warning', 'è¯·å…ˆç™»å½•', 'ç™»å½•åæ‰èƒ½æ”¶è—æŠ€èƒ½');
                        return;
                    }
                    const skillId = skill.id.toString();
                    const existing = this.favorites.find(f => f.target_type === 'skill' && f.target_id.toString() === skillId);
                    
                    try {
                        if (existing) {
                            const { error } = await this.supabase
                                .from('favorites')
                                .delete()
                                .eq('id', existing.id);
                            if (error) throw error;
                            this.favorites = this.favorites.filter(f => f.id !== existing.id);
                            this.favoriteSkills = this.favoriteSkills.filter(s => s.id.toString() !== skillId);
                            this.showNotification('success', 'å·²å–æ¶ˆæ”¶è—', `ä½ å·²å–æ¶ˆæ”¶è—ã€Œ${skill.title}ã€`);
                        } else {
                            const { data, error } = await this.supabase
                                .from('favorites')
                                .insert([{
                                    user_id: this.currentUser.id,
                                    target_type: 'skill',
                                    target_id: skillId,
                                    created_at: new Date().toISOString()
                                }])
                                .select();
                            if (error) throw error;
                            this.favorites.push(data[0]);
                            await this.loadFavorites();
                            this.showNotification('success', 'æ”¶è—æˆåŠŸ', `ã€Œ${skill.title}ã€å·²æ·»åŠ åˆ°æˆ‘çš„æ”¶è—`);
                        }
                    } catch (error) {
                        console.error('æ”¶è—æ“ä½œå¤±è´¥:', error);
                        this.showNotification('error', 'æ“ä½œå¤±è´¥', error.message || 'è¯·ç¨åé‡è¯•');
                    }
                },
                
                // ========== åŒ¹é…ç›¸å…³ ==========
                
                async loadMatches() {
                    if (!this.currentUser) return;
                    try {
                        const { data: profiles, error } = await this.supabase
                            .from('profiles')
                            .select('*, user_review_stats(*)')
                            .neq('id', this.currentUser.id);
                        
                        if (error) throw error;
                        
                        const currentUserTeachSkill = this.userProfile.teach_skill || '';
                        const currentUserLearnSkill = this.userProfile.learn_skill || '';
                        const currentUserCity = this.userProfile.city || '';
                        
                        const cleanSkill = (skill) => {
                            if (!skill) return null;
                            const cleaned = skill.toString().trim().replace(/[ã€ï¼Œ,]/g, ',').split(',')[0].trim();
                            if (!cleaned || cleaned === 'æœªè®¾ç½®' || cleaned === 'null') return null;
                            return cleaned;
                        };
                        
                        const currentTeach = cleanSkill(currentUserTeachSkill);
                        const currentLearn = cleanSkill(currentUserLearnSkill);
                        
                        this.matches = profiles.map(profile => {
                            const otherTeach = cleanSkill(profile.teach_skill);
                            const otherLearn = cleanSkill(profile.learn_skill);
                            const otherCity = profile.city || '';
                            let matchScore = 0;
                            
                            if (!otherTeach && !otherLearn) return { ...profile, matchScore: 0 };
                            if (!currentTeach && !currentLearn) matchScore = 10;
                            else {
                                if (currentLearn && otherTeach) {
                                    if (currentLearn === otherTeach) matchScore += 50;
                                    else if (otherTeach.includes(currentLearn) || currentLearn.includes(otherTeach)) matchScore += 40;
                                }
                                if (currentTeach && otherLearn) {
                                    if (currentTeach === otherLearn) matchScore += 30;
                                    else if (otherLearn.includes(currentTeach) || currentTeach.includes(otherLearn)) matchScore += 20;
                                }
                                if ((currentTeach || currentLearn) && (otherTeach || otherLearn)) matchScore += 10;
                                if (currentUserCity && otherCity && this.isSameCity(currentUserCity, otherCity)) matchScore += 20;
                            }
                            
                            const stats = profile.user_review_stats || {};
                            
                            return {
                                ...profile,
                                matchScore: Math.min(100, Math.max(0, matchScore)),
                                overall_rating: stats.overall_rating || 0,
                                total_reviews: stats.total_reviews || 0
                            };
                        })
                        .filter(match => match.matchScore > 0)
                        .sort((a, b) => b.matchScore - a.matchScore)
                        .slice(0, 10);
                        
                    } catch (error) {
                        console.error('åŠ è½½åŒ¹é…ç”¨æˆ·å¤±è´¥:', error);
                        this.matches = [];
                    }
                },
                
                isSameCity(city1, city2) {
                    if (!city1 || !city2) return false;
                    const normalizeCity = (city) => city.replace(/å¸‚|åŒº|å¿|é•‡|ä¹¡|è¡—é“|åœ°åŒº$/g, '').trim();
                    return normalizeCity(city1) === normalizeCity(city2);
                },
                
                // ========== æ¶ˆæ¯ç›¸å…³ï¼ˆå®Œå…¨ä¿ç•™ï¼‰==========
                
                async loadConversations() {
                    if (!this.currentUser) return;
                    try {
                        const { data: messages, error } = await this.supabase
                            .from('messages')
                            .select('*')
                            .or(`sender_id.eq.${this.currentUser.id},receiver_id.eq.${this.currentUser.id}`)
                            .order('created_at', { ascending: false });
                        
                        if (error) throw error;
                        if (!messages || messages.length === 0) {
                            this.conversations = [];
                            return;
                        }
                        
                        const conversationsMap = new Map();
                        for (const message of messages) {
                            const otherUserId = message.sender_id === this.currentUser.id ? message.receiver_id : message.sender_id;
                            const conversationId = [this.currentUser.id, otherUserId].sort().join('_');
                            if (this.deletedConversations.includes(conversationId)) continue;
                            
                            if (!conversationsMap.has(conversationId)) {
                                let otherUserInfo = { username: 'æœªçŸ¥ç”¨æˆ·', teach_skill: '', avatar_url: null };
                                try {
                                    const { data: profile } = await this.supabase
                                        .from('profiles')
                                        .select('username, teach_skill, avatar_url')
                                        .eq('id', otherUserId)
                                        .single();
                                    if (profile) otherUserInfo = profile;
                                } catch (err) {}
                                
                                conversationsMap.set(conversationId, {
                                    id: conversationId,
                                    userId: otherUserId,
                                    username: otherUserInfo.username,
                                    skillTitle: otherUserInfo.teach_skill || 'æœªè®¾ç½®æŠ€èƒ½',
                                    avatar_url: otherUserInfo.avatar_url,
                                    lastMessage: message.content,
                                    timestamp: message.created_at,
                                    unread: !message.is_read && message.receiver_id === this.currentUser.id ? 1 : 0,
                                    avatarColor: this.getRandomColor()
                                });
                            } else {
                                const existing = conversationsMap.get(conversationId);
                                const currentTime = new Date(existing.timestamp);
                                const messageTime = new Date(message.created_at);
                                if (messageTime > currentTime) {
                                    existing.lastMessage = message.content;
                                    existing.timestamp = message.created_at;
                                    if (!message.is_read && message.receiver_id === this.currentUser.id) {
                                        existing.unread = (existing.unread || 0) + 1;
                                    }
                                } else if (!message.is_read && message.receiver_id === this.currentUser.id) {
                                    existing.unread = (existing.unread || 0) + 1;
                                }
                            }
                        }
                        
                        this.conversations = Array.from(conversationsMap.values())
                            .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                        this.unreadCount = this.conversations.reduce((sum, conv) => sum + (conv.unread || 0), 0);
                    } catch (error) {
                        console.error('åŠ è½½å¯¹è¯å¼‚å¸¸:', error);
                        this.conversations = [];
                    }
                },
                
                get filteredConversations() {
                    if (!this.searchConversation) return this.conversations;
                    const searchTerm = this.searchConversation.toLowerCase();
                    return this.conversations.filter(conv => 
                        conv.username.toLowerCase().includes(searchTerm) ||
                        (conv.skillTitle && conv.skillTitle.toLowerCase().includes(searchTerm)) ||
                        conv.lastMessage.toLowerCase().includes(searchTerm)
                    );
                },
                
                getRandomColor() {
                    const colors = ['from-blue-500 to-blue-600', 'from-green-500 to-green-600', 'from-purple-500 to-purple-600', 'from-pink-500 to-pink-600', 'from-orange-500 to-orange-600', 'from-teal-500 to-teal-600'];
                    return colors[Math.floor(Math.random() * colors.length)];
                },
                
                async selectConversation(conversationId, preserveScroll = false) {
                    this.selectedConversationId = conversationId;
                    this.selectedConversation = this.conversations.find(c => c.id === conversationId);
                    
                    if (!this.selectedConversation || !this.selectedConversation.userId) {
                        this.selectedConversationMessages = [];
                        return;
                    }
                    
                    try {
                        const otherUserId = this.selectedConversation.userId;
                        const { data: messages, error } = await this.supabase
                            .from('messages')
                            .select('*')
                            .or(`and(sender_id.eq.${this.currentUser.id},receiver_id.eq.${otherUserId}),and(sender_id.eq.${otherUserId},receiver_id.eq.${this.currentUser.id})`)
                            .order('created_at', { ascending: true });
                        
                        if (error) throw error;
                        
                        const container = this.$refs.messageContainer;
                        let oldScrollTop = preserveScroll && container ? container.scrollTop : 0;
                        
                        this.selectedConversationMessages = (messages || []).map(msg => ({
                            id: msg.id,
                            sender: msg.sender_id === this.currentUser.id ? 'me' : 'other',
                            content: msg.content,
                            timestamp: msg.created_at,
                            is_read: msg.is_read
                        }));
                        
                        const unreadMessages = messages.filter(msg => !msg.is_read && msg.receiver_id === this.currentUser.id);
                        if (unreadMessages.length > 0) {
                            const unreadIds = unreadMessages.map(msg => msg.id);
                            await this.supabase.from('messages').update({ is_read: true }).in('id', unreadIds);
                            if (this.selectedConversation) {
                                this.selectedConversation.unread = 0;
                                const convIndex = this.conversations.findIndex(c => c.id === conversationId);
                                if (convIndex !== -1) this.conversations[convIndex].unread = 0;
                                this.unreadCount = this.conversations.reduce((sum, conv) => sum + (conv.unread || 0), 0);
                            }
                        }
                        
                        this.$nextTick(() => {
                            if (!preserveScroll) {
                                this.scrollToBottom(false);
                            } else {
                                const wasAtBottom = this.isScrolledToBottom();
                                if (wasAtBottom) {
                                    this.scrollToBottom(false);
                                } else {
                                    if (container) container.scrollTop = oldScrollTop;
                                }
                            }
                        });
                    } catch (error) {
                        console.error('åŠ è½½å¯¹è¯æ¶ˆæ¯å¼‚å¸¸:', error);
                    }
                },
                
                isScrolledToBottom(threshold = 50) {
                    const container = this.$refs.messageContainer;
                    if (!container) return false;
                    return container.scrollHeight - container.scrollTop - container.clientHeight < threshold;
                },
                
                scrollToBottom(smooth = true) {
                    this.$nextTick(() => {
                        const container = this.$refs.messageContainer;
                        if (container) {
                            container.scrollTo({ top: container.scrollHeight, behavior: smooth ? 'smooth' : 'auto' });
                        }
                    });
                },
                
                async sendNewMessage() {
                    if (!this.newMessage.trim() || !this.selectedConversationId || !this.currentUser) {
                        this.showNotification('warning', 'æ— æ³•å‘é€', 'è¯·å…ˆé€‰æ‹©å¯¹è¯æˆ–ç™»å½•');
                        return;
                    }
                    
                    const tempMessage = {
                        id: 'temp_' + Date.now(),
                        sender: 'me',
                        content: this.newMessage,
                        timestamp: new Date().toISOString(),
                        temp: true
                    };
                    this.selectedConversationMessages.push(tempMessage);
                    this.$nextTick(() => this.scrollToBottom(true));
                    
                    try {
                        let receiverId = this.selectedConversation?.userId;
                        if (!receiverId) return;
                        
                        const messageData = {
                            sender_id: this.currentUser.id,
                            receiver_id: receiverId,
                            content: this.newMessage.trim(),
                            created_at: new Date().toISOString(),
                            is_read: false
                        };
                        
                        const { data, error } = await this.supabase.from('messages').insert([messageData]).select();
                        if (error) throw error;
                        
                        const msgIndex = this.selectedConversationMessages.findIndex(m => m.id === tempMessage.id);
                        if (msgIndex !== -1 && data && data[0]) {
                            this.selectedConversationMessages[msgIndex].id = data[0].id;
                            this.selectedConversationMessages[msgIndex].temp = false;
                        }
                        
                        if (this.selectedConversation) {
                            this.selectedConversation.lastMessage = this.newMessage;
                            this.selectedConversation.timestamp = new Date().toISOString();
                            this.conversations = [this.selectedConversation, ...this.conversations.filter(c => c.id !== this.selectedConversationId)];
                        }
                        
                        this.newMessage = '';
                    } catch (error) {
                        console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
                        const msgIndex = this.selectedConversationMessages.findIndex(m => m.id === tempMessage.id);
                        if (msgIndex !== -1) this.selectedConversationMessages[msgIndex].failed = true;
                        this.showNotification('error', 'å‘é€å¤±è´¥', 'æ¶ˆæ¯å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•');
                    }
                },
                
                sendMessage(userId, username) {
                    const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
                    if (!uuidRegex.test(userId)) {
                        this.showNotification('warning', 'ç”¨æˆ·IDæ ¼å¼é”™è¯¯', 'æ— æ³•å¼€å§‹å¯¹è¯');
                        return;
                    }
                    this.activeTab = 'messages';
                    const conversationId = [this.currentUser.id, userId].sort().join('_');
                    const existingConversation = this.conversations.find(c => c.id === conversationId);
                    if (existingConversation) {
                        this.selectConversation(existingConversation.id);
                    } else {
                        (async () => {
                            let avatarUrl = null;
                            try {
                                const { data } = await this.supabase.from('profiles').select('avatar_url').eq('id', userId).single();
                                if (data) avatarUrl = data.avatar_url;
                            } catch (e) {}
                            const newConversation = {
                                id: conversationId,
                                userId: userId,
                                username: username,
                                avatar_url: avatarUrl,
                                lastMessage: 'ä½ å‘èµ·äº†å¯¹è¯',
                                timestamp: new Date().toISOString(),
                                unread: 0,
                                avatarColor: this.getRandomColor()
                            };
                            this.conversations.unshift(newConversation);
                            this.selectConversation(newConversation.id);
                        })();
                    }
                },
                
                async contactSkillOwner(skill) {
                    if (!this.isAuthenticated) {
                        this.showNotification('warning', 'è¯·å…ˆç™»å½•', 'ç™»å½•åæ‰èƒ½è”ç³»æŠ€èƒ½æ‰€æœ‰è€…');
                        this.activeTab = 'profile';
                        return;
                    }
                    if (skill.author === this.userProfile.username) {
                        this.showNotification('info', 'æç¤º', 'è¿™æ˜¯ä½ è‡ªå·±å‘å¸ƒçš„æŠ€èƒ½å“¦ï¼');
                        return;
                    }
                    
                    let ownerUserId = skill.user_id;
                    let ownerUsername = skill.author;
                    
                    if (!ownerUserId) {
                        const match = this.matches.find(m => m.username === skill.author);
                        if (match && match.id) {
                            ownerUserId = match.id;
                            ownerUsername = match.username;
                        } else {
                            ownerUserId = '00000000-0000-0000-0000-000000000001';
                        }
                    }
                    
                    this.activeTab = 'messages';
                    const conversationId = [this.currentUser.id, ownerUserId].sort().join('_');
                    const existingConversation = this.conversations.find(conv => conv.id === conversationId);
                    
                    if (existingConversation) {
                        this.selectConversation(existingConversation.id);
                    } else {
                        let avatarUrl = null;
                        try {
                            const { data } = await this.supabase.from('profiles').select('avatar_url').eq('id', ownerUserId).single();
                            if (data) avatarUrl = data.avatar_url;
                        } catch (e) {}
                        
                        const newConversation = {
                            id: conversationId,
                            userId: ownerUserId,
                            username: ownerUsername,
                            avatar_url: avatarUrl,
                            skillTitle: skill.title,
                            skillId: skill.id,
                            lastMessage: `æˆ‘æƒ³å­¦ä¹ "${skill.title}"`,
                            timestamp: new Date().toISOString(),
                            unread: 0,
                            avatarColor: this.getRandomColor()
                        };
                        this.conversations.unshift(newConversation);
                        this.selectConversation(newConversation.id);
                        this.newMessage = `ä½ å¥½${ownerUsername}ï¼æˆ‘å¯¹ä½ å‘å¸ƒçš„"${skill.title}"å¾ˆæ„Ÿå…´è¶£ï¼Œæƒ³å‘ä½ å­¦ä¹ ã€‚\næˆ‘çš„åŸºæœ¬æƒ…å†µï¼š\n- æˆ‘æƒ³å­¦ä¹ ï¼š${this.userProfile.learn_skill || 'å¾ˆå¤šæ–°æŠ€èƒ½'}\n- æˆ‘å¯ä»¥åˆ†äº«ï¼š${this.userProfile.teach_skill || 'ä¸€äº›æŠ€èƒ½'}\n\næœŸå¾…ä½ çš„å›å¤ï¼`;
                    }
                },
                
                async deleteConversation(conversationId, username) {
                    if (!confirm(`ç¡®å®šè¦åˆ é™¤ä¸ ${username} çš„å¯¹è¯å—ï¼Ÿ`)) return;
                    try {
                        if (this.selectedConversationId === conversationId) {
                            this.selectedConversationId = null;
                            this.selectedConversation = null;
                            this.selectedConversationMessages = [];
                        }
                        this.conversations = this.conversations.filter(c => c.id !== conversationId);
                        if (!this.deletedConversations.includes(conversationId)) {
                            this.deletedConversations.push(conversationId);
                            this.saveDeletedConversations();
                        }
                        this.unreadCount = this.conversations.reduce((sum, conv) => sum + (conv.unread || 0), 0);
                        this.showNotification('success', 'åˆ é™¤æˆåŠŸ', `å·²åˆ é™¤ä¸ ${username} çš„å¯¹è¯`);
                    } catch (error) {
                        console.error('åˆ é™¤å¯¹è¯å¤±è´¥:', error);
                    }
                },
                
                saveDeletedConversations() {
                    try {
                        localStorage.setItem('deletedConversations', JSON.stringify(this.deletedConversations));
                    } catch (error) {}
                },
                
                loadDeletedConversations() {
                    try {
                        const saved = localStorage.getItem('deletedConversations');
                        if (saved) this.deletedConversations = JSON.parse(saved);
                    } catch (error) {
                        this.deletedConversations = [];
                    }
                },
                
                async pollMessagesIncremental() {
                    if (!this.currentUser) return;
                    try {
                        const { data: messages, error } = await this.supabase
                            .from('messages')
                            .select('*')
                            .or(`sender_id.eq.${this.currentUser.id},receiver_id.eq.${this.currentUser.id}`)
                            .order('created_at', { ascending: false })
                            .limit(50);
                        
                        if (error || !messages) return;
                        
                        const latestMsgMap = new Map();
                        for (const msg of messages) {
                            const otherUserId = msg.sender_id === this.currentUser.id ? msg.receiver_id : msg.sender_id;
                            const convId = [this.currentUser.id, otherUserId].sort().join('_');
                            if (!latestMsgMap.has(convId) || new Date(msg.created_at) > new Date(latestMsgMap.get(convId).created_at)) {
                                latestMsgMap.set(convId, msg);
                            }
                        }
                        
                        const updatedIds = new Set();
                        for (const conv of this.conversations) {
                            const latest = latestMsgMap.get(conv.id);
                            if (latest) {
                                conv.lastMessage = latest.content;
                                conv.timestamp = latest.created_at;
                                if (latest.receiver_id === this.currentUser.id && !latest.is_read) {
                                    conv.unread = (conv.unread || 0) + 1;
                                    this.unreadCount++;
                                }
                                updatedIds.add(conv.id);
                            }
                        }
                        
                        for (const [convId, latest] of latestMsgMap) {
                            if (!updatedIds.has(convId) && !this.deletedConversations.includes(convId)) {
                                const otherUserId = latest.sender_id === this.currentUser.id ? latest.receiver_id : latest.sender_id;
                                let otherUserInfo = { username: 'æœªçŸ¥ç”¨æˆ·', teach_skill: '', avatar_url: null };
                                try {
                                    const { data: profile } = await this.supabase
                                        .from('profiles')
                                        .select('username, teach_skill, avatar_url')
                                        .eq('id', otherUserId)
                                        .single();
                                    if (profile) otherUserInfo = profile;
                                } catch (err) {}
                                
                                const newConv = {
                                    id: convId,
                                    userId: otherUserId,
                                    username: otherUserInfo.username,
                                    skillTitle: otherUserInfo.teach_skill || 'æœªè®¾ç½®æŠ€èƒ½',
                                    avatar_url: otherUserInfo.avatar_url,
                                    lastMessage: latest.content,
                                    timestamp: latest.created_at,
                                    unread: (latest.receiver_id === this.currentUser.id && !latest.is_read) ? 1 : 0,
                                    avatarColor: this.getRandomColor()
                                };
                                this.conversations.unshift(newConv);
                            }
                        }
                        
                        this.conversations.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                        
                        if (this.selectedConversationId) {
                            const exists = this.conversations.some(c => c.id === this.selectedConversationId);
                            if (exists) {
                                await this.selectConversation(this.selectedConversationId, true);
                            } else {
                                this.selectedConversationId = null;
                                this.selectedConversation = null;
                                this.selectedConversationMessages = [];
                            }
                        }
                    } catch (error) {
                        console.error('å¢é‡è½®è¯¢å¤±è´¥:', error);
                    }
                },
                
                startMessagePolling() {
                    if (this.messagePollTimer) return;
                    this.messagePollTimer = setInterval(async () => {
                        if (this.activeTab === 'messages' && this.isAuthenticated) {
                            await this.pollMessagesIncremental();
                        }
                    }, 3000);
                },
                
                stopMessagePolling() {
                    if (this.messagePollTimer) {
                        clearInterval(this.messagePollTimer);
                        this.messagePollTimer = null;
                    }
                },
                
                // ========== è§†é¢‘æ•™å®¤ï¼ˆå®Œå…¨ä¿ç•™åŸæœ‰ï¼‰==========
                
                openVideoRoomModal() {
                    if (!this.selectedConversation) {
                        this.showNotification('warning', 'è¯·å…ˆé€‰æ‹©å¯¹è¯', 'éœ€è¦é€‰æ‹©ä¸€ä¸ªèŠå¤©å¯¹è±¡æ‰èƒ½åˆ›å»ºè§†é¢‘æ•™å®¤');
                        return;
                    }
                    this.showVideoRoomModal = true;
                    this.videoRoomUrl = '';
                    this.videoRoomPassword = '';
                    this.videoError = '';
                    this.createVideoRoom();
                },
                
                closeVideoRoomModal() {
                    this.showVideoRoomModal = false;
                    setTimeout(() => {
                        this.videoRoomUrl = '';
                        this.videoRoomPassword = '';
                        this.videoError = '';
                        this.isCreatingVideoRoom = false;
                    }, 300);
                },
                
                async createVideoRoom() {
                    if (this.isCreatingVideoRoom) return;
                    this.isCreatingVideoRoom = true;
                    
                    try {
                        const timestamp = Date.now();
                        const randomPart1 = Math.random().toString(36).substring(2, 10);
                        const randomPart2 = Math.random().toString(36).substring(2, 10);
                        const roomId = `zhizhou-${timestamp}-${randomPart1}-${randomPart2}`;
                        const password = Math.floor(1000 + Math.random() * 9000).toString();
                        
                        this.videoRoomUrl = `https://chitchatter.im/room/${roomId}`;
                        this.videoRoomPassword = password;
                        
                        try {
                            await this.supabase.from('video_rooms').insert([{
                                room_url: this.videoRoomUrl,
                                room_password: this.videoRoomPassword,
                                creator_id: this.currentUser.id,
                                participant_id: this.selectedConversation.userId,
                                conversation_id: this.selectedConversationId,
                                room_topic: `ä¸ ${this.selectedConversation.username} çš„æŠ€èƒ½äº¤æµ`,
                                status: 'active',
                                created_at: new Date().toISOString()
                            }]);
                        } catch (dbError) {
                            console.warn('ä¿å­˜è§†é¢‘æ•™å®¤åˆ°æ•°æ®åº“å¤±è´¥:', dbError);
                        }
                    } catch (error) {
                        console.error('åˆ›å»ºè§†é¢‘æ•™å®¤å¤±è´¥:', error);
                        this.videoError = 'åˆ›å»ºè§†é¢‘æ•™å®¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
                    } finally {
                        this.isCreatingVideoRoom = false;
                    }
                },
                
                async copyVideoLinkAndPassword() {
                    const textToCopy = `è§†é¢‘æ•™å®¤é“¾æ¥ï¼š${this.videoRoomUrl}\nè¿æ¥å¯†ç ï¼š${this.videoRoomPassword}`;
                    try {
                        await navigator.clipboard.writeText(textToCopy);
                        this.showNotification('success', 'å·²å¤åˆ¶', 'é“¾æ¥å’Œå¯†ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
                    } catch (err) {
                        const tempInput = document.createElement('input');
                        tempInput.value = textToCopy;
                        document.body.appendChild(tempInput);
                        tempInput.select();
                        document.execCommand('copy');
                        document.body.removeChild(tempInput);
                        this.showNotification('info', 'å·²å¤åˆ¶', 'é“¾æ¥å’Œå¯†ç å·²å¤åˆ¶ï¼ˆå…¼å®¹æ¨¡å¼ï¼‰');
                    }
                },
                
                async copyPassword() {
                    if (!this.videoRoomPassword) return;
                    try {
                        await navigator.clipboard.writeText(this.videoRoomPassword);
                        this.showNotification('success', 'å·²å¤åˆ¶', 'å¯†ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
                    } catch (err) {
                        const tempInput = document.createElement('input');
                        tempInput.value = this.videoRoomPassword;
                        document.body.appendChild(tempInput);
                        tempInput.select();
                        document.execCommand('copy');
                        document.body.removeChild(tempInput);
                    }
                },
                
                async sendVideoRoomLinkToChat() {
                    if (!this.videoRoomUrl || !this.selectedConversationId) return;
                    
                    const invitationContent = `ğŸ¥ è§†é¢‘æ•™å®¤é‚€è¯·\n\næˆ‘åˆ›å»ºäº†ä¸€ä¸ªè§†é¢‘æ•™å®¤ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¿™é‡Œè¿›è¡ŒæŠ€èƒ½äº¤æµï¼\n\næˆ¿é—´é“¾æ¥ï¼š${this.videoRoomUrl}\nè¿æ¥å¯†ç ï¼š${this.videoRoomPassword}\n\nâš ï¸ é‡è¦ï¼šè¯·ç‚¹å‡»é“¾æ¥åï¼Œé€‰æ‹© "JOIN PRIVATE ROOM" æŒ‰é’®ï¼Œç„¶åè¾“å…¥ä¸Šé¢çš„å¯†ç è¿›å…¥æˆ¿é—´ã€‚`;
                    
                    try {
                        let receiverId = this.selectedConversation?.userId;
                        if (!receiverId) return;
                        
                        const messageData = {
                            sender_id: this.currentUser.id,
                            receiver_id: receiverId,
                            content: invitationContent,
                            created_at: new Date().toISOString(),
                            is_read: false
                        };
                        
                        const { data, error } = await this.supabase.from('messages').insert([messageData]).select();
                        if (error) throw error;
                        
                        if (data && data[0]) {
                            this.selectedConversationMessages.push({
                                id: data[0].id,
                                sender: 'me',
                                content: data[0].content,
                                timestamp: data[0].created_at,
                                is_read: false
                            });
                            if (this.selectedConversation) {
                                this.selectedConversation.lastMessage = invitationContent;
                                this.selectedConversation.timestamp = new Date().toISOString();
                            }
                            this.scrollToBottom(true);
                            this.showNotification('success', 'å·²å‘é€', 'è§†é¢‘é‚€è¯·å·²å‘é€åˆ°èŠå¤©');
                        }
                    } catch (error) {
                        console.error('å‘é€è§†é¢‘é‚€è¯·å¤±è´¥:', error);
                        this.showNotification('error', 'å‘é€å¤±è´¥', 'æ— æ³•å‘é€è§†é¢‘é‚€è¯·');
                    }
                },
                
                // ========== ç¤¾åŒºæ´»åŠ¨ï¼ˆå®Œå…¨ä¿ç•™åŸæœ‰ï¼‰==========
                
                async loadCommunityEvents() {
                    try {
                        const { data: events, error } = await this.supabase
                            .from('community_events')
                            .select('*')
                            .eq('status', 'active')
                            .order('event_date', { ascending: false })
                            .order('created_at', { ascending: false });
                        
                        if (error) throw error;
                        if (!events || events.length === 0) {
                            this.communityEvents = [];
                            this.filteredCommunityEvents = [];
                            return;
                        }
                        
                        const userIds = [...new Set(events.map(e => e.user_id).filter(Boolean))];
                        let userMap = {};
                        if (userIds.length > 0) {
                            const { data: profiles, error: profileError } = await this.supabase
                                .from('profiles')
                                .select('id, username, city, avatar_url')
                                .in('id', userIds);
                            if (!profileError && profiles) {
                                userMap = Object.fromEntries(profiles.map(p => [p.id, p]));
                            }
                        }
                        
                        this.communityEvents = events.map(event => ({
                            id: event.id,
                            user_id: event.user_id,
                            title: event.title,
                            event_type: event.event_type,
                            description: event.description,
                            city: event.city,
                            address: event.address,
                            event_date: event.event_date,
                            start_time: event.start_time,
                            end_time: event.end_time,
                            max_people: event.max_people,
                            fee_info: event.fee_info || 'å…è´¹',
                            notes: event.notes,
                            organizer_name: userMap[event.user_id]?.username || 'åŒ¿åç”¨æˆ·',
                            organizer_city: userMap[event.user_id]?.city || 'æœªè®¾ç½®',
                            organizer_avatar: userMap[event.user_id]?.avatar_url || null,
                            status: event.status,
                            created_at: event.created_at,
                            updated_at: event.updated_at
                        }));
                        this.filterCommunityEvents();
                    } catch (error) {
                        console.error('åŠ è½½ç¤¾åŒºæ´»åŠ¨å¤±è´¥:', error);
                        this.communityEvents = [];
                        this.filteredCommunityEvents = [];
                    }
                },
                
                async loadMyEvents() {
                    if (!this.currentUser) return;
                    try {
                        const { data: events, error } = await this.supabase
                            .from('community_events')
                            .select('*')
                            .eq('user_id', this.currentUser.id)
                            .order('event_date', { ascending: false })
                            .order('created_at', { ascending: false });
                        if (error) throw error;
                        this.communityEvents = (events || []).map(event => ({
                            ...event,
                            organizer_name: this.userProfile?.username || 'æˆ‘',
                            organizer_city: this.userProfile?.city || 'æœªè®¾ç½®',
                            organizer_avatar: this.userProfile?.avatar_url || null
                        }));
                        this.filterCommunityEvents();
                    } catch (error) {
                        console.error('åŠ è½½æˆ‘çš„æ´»åŠ¨å¤±è´¥:', error);
                    }
                },
                
                filterCommunityEvents() {
                    let filtered = [...this.communityEvents];
                    if (this.communityCityFilter) {
                        filtered = filtered.filter(event => event.city?.includes(this.communityCityFilter));
                    }
                    if (this.communityTypeFilter) {
                        filtered = filtered.filter(event => event.event_type === this.communityTypeFilter);
                    }
                    if (this.communityDateFilter !== 'all') {
                        const today = new Date(); today.setHours(0, 0, 0, 0);
                        const tomorrow = new Date(today); tomorrow.setDate(tomorrow.getDate() + 1);
                        const thisSaturday = new Date(today);
                        const dayOfWeek = today.getDay();
                        thisSaturday.setDate(today.getDate() + (dayOfWeek === 0 ? 6 : 6 - dayOfWeek));
                        const nextSunday = new Date(thisSaturday); nextSunday.setDate(thisSaturday.getDate() + 1);
                        const nextWeekEnd = new Date(today); nextWeekEnd.setDate(today.getDate() + 7);
                        
                        filtered = filtered.filter(event => {
                            const eventDate = new Date(event.event_date); eventDate.setHours(0, 0, 0, 0);
                            switch (this.communityDateFilter) {
                                case 'today': return eventDate.getTime() === today.getTime();
                                case 'tomorrow': return eventDate.getTime() === tomorrow.getTime();
                                case 'weekend': return eventDate >= thisSaturday && eventDate <= nextSunday;
                                case 'nextWeek': return eventDate > today && eventDate <= nextWeekEnd;
                                default: return true;
                            }
                        });
                    }
                    this.filteredCommunityEvents = filtered;
                },
                
                async showEventDetail(eventId) {
                    try {
                        this.communityView = 'eventDetail';
                        const event = this.communityEvents.find(e => e.id === eventId);
                        if (!event) {
                            this.showNotification('error', 'é”™è¯¯', 'æ‰¾ä¸åˆ°æ´»åŠ¨ä¿¡æ¯');
                            return;
                        }
                        
                        const { data: eventDetail, error } = await this.supabase
                            .from('community_events')
                            .select('*')
                            .eq('id', eventId)
                            .single();
                        if (error) throw error;
                        
                        let organizerName = event.organizer_name;
                        let organizerCity = event.organizer_city;
                        let organizerAvatar = event.organizer_avatar;
                        let organizerEventCount = 0;
                        
                        if (eventDetail.user_id) {
                            const { data: profile } = await this.supabase
                                .from('profiles')
                                .select('username, city, avatar_url')
                                .eq('id', eventDetail.user_id)
                                .single();
                            if (profile) {
                                organizerName = profile.username;
                                organizerCity = profile.city;
                                organizerAvatar = profile.avatar_url;
                            }
                            const { count } = await this.supabase
                                .from('community_events')
                                .select('*', { count: 'exact', head: true })
                                .eq('user_id', eventDetail.user_id)
                                .eq('status', 'active');
                            organizerEventCount = count || 0;
                        }
                        
                        this.currentEventDetail = {
                            id: eventDetail.id,
                            user_id: eventDetail.user_id,
                            title: eventDetail.title,
                            event_type: eventDetail.event_type,
                            description: eventDetail.description,
                            city: eventDetail.city,
                            address: eventDetail.address,
                            event_date: eventDetail.event_date,
                            start_time: eventDetail.start_time,
                            end_time: eventDetail.end_time,
                            max_people: eventDetail.max_people,
                            fee_info: eventDetail.fee_info,
                            notes: eventDetail.notes,
                            organizer_name: organizerName,
                            organizer_city: organizerCity,
                            organizer_avatar: organizerAvatar,
                            organizer_event_count: organizerEventCount,
                            status: eventDetail.status,
                            created_at: eventDetail.created_at
                        };
                    } catch (error) {
                        console.error('æŸ¥çœ‹è¯¦æƒ…å¤±è´¥:', error);
                        this.showNotification('error', 'åŠ è½½å¤±è´¥', 'æ— æ³•åŠ è½½æ´»åŠ¨è¯¦æƒ…');
                        this.communityView = 'allEvents';
                    }
                },
                
                async createCommunityEvent() {
                    if (!this.currentUser) {
                        this.showNotification('error', 'è¯·å…ˆç™»å½•', 'ç™»å½•åæ‰èƒ½å‘èµ·æ´»åŠ¨');
                        return;
                    }
                    if (!this.newEvent.disclaimer_accepted) {
                        this.showNotification('error', 'éœ€è¦åŒæ„', 'è¯·é˜…è¯»å¹¶åŒæ„å…è´£å£°æ˜');
                        return;
                    }
                    if (!this.newEvent.title.trim() || !this.newEvent.city.trim() || !this.newEvent.event_date) {
                        this.showNotification('error', 'ä¿¡æ¯ä¸å®Œæ•´', 'è¯·å¡«å†™æ´»åŠ¨æ ‡é¢˜ã€åŸå¸‚å’Œæ—¥æœŸ');
                        return;
                    }
                    this.eventCreating = true;
                    try {
                        const eventData = {
                            user_id: this.currentUser.id,
                            title: this.newEvent.title.trim(),
                            event_type: this.newEvent.event_type,
                            description: this.newEvent.description.trim(),
                            event_date: this.newEvent.event_date,
                            start_time: this.newEvent.start_time,
                            end_time: this.newEvent.end_time,
                            max_people: parseInt(this.newEvent.max_people) || 10,
                            city: this.newEvent.city.trim(),
                            address: this.newEvent.address.trim() || null,
                            fee_info: this.newEvent.fee_info.trim() || null,
                            notes: this.newEvent.notes.trim() || null,
                            status: 'active'
                        };
                        const { data, error } = await this.supabase.from('community_events').insert([eventData]).select();
                        if (error) throw error;
                        
                        const newEvent = {
                            ...data[0],
                            organizer_name: this.userProfile.username || this.currentUser.email.split('@')[0],
                            organizer_city: this.userProfile.city || 'æœªè®¾ç½®',
                            organizer_avatar: this.userProfile.avatar_url || null
                        };
                        this.communityEvents.unshift(newEvent);
                        this.filterCommunityEvents();
                        this.newEvent = { title: '', event_type: 'æ²™é¾™', description: '', event_date: '', start_time: '', end_time: '', max_people: 10, city: '', address: '', fee_info: '', notes: '', disclaimer_accepted: false };
                        this.showCreateEventModal = false;
                        this.showNotification('success', 'å‘å¸ƒæˆåŠŸ', 'æ´»åŠ¨å·²æˆåŠŸå‘å¸ƒï¼');
                        this.communityView = 'allEvents';
                    } catch (error) {
                        console.error('åˆ›å»ºæ´»åŠ¨å¤±è´¥:', error);
                        this.showNotification('error', 'å‘å¸ƒå¤±è´¥', error.message || 'åˆ›å»ºæ´»åŠ¨å¤±è´¥');
                    } finally {
                        this.eventCreating = false;
                    }
                },
                
                async editEvent(eventId) {
                    try {
                        const event = this.communityEvents.find(e => e.id === eventId);
                        if (!event) throw new Error('æ´»åŠ¨ä¸å­˜åœ¨');
                        if (event.user_id !== this.currentUser.id) {
                            this.showNotification('error', 'æƒé™ä¸è¶³', 'åªæœ‰å‘èµ·è€…å¯ä»¥ç¼–è¾‘');
                            return;
                        }
                        const { data, error } = await this.supabase
                            .from('community_events')
                            .select('*')
                            .eq('id', eventId)
                            .single();
                        if (error) throw error;
                        
                        this.editingEvent = {
                            id: data.id,
                            title: data.title,
                            event_type: data.event_type,
                            description: data.description,
                            event_date: data.event_date.split('T')[0],
                            start_time: data.start_time,
                            end_time: data.end_time,
                            max_people: data.max_people,
                            city: data.city,
                            address: data.address,
                            fee_info: data.fee_info || '',
                            notes: data.notes || ''
                        };
                        this.showEditEventModal = true;
                    } catch (error) {
                        console.error('ç¼–è¾‘æ´»åŠ¨å¤±è´¥:', error);
                        this.showNotification('error', 'ç¼–è¾‘å¤±è´¥', 'æ— æ³•è·å–æ´»åŠ¨ä¿¡æ¯');
                    }
                },
                
                async updateEvent() {
                    if (!this.editingEvent) return;
                    try {
                        const updateData = {
                            title: this.editingEvent.title.trim(),
                            event_type: this.editingEvent.event_type,
                            description: this.editingEvent.description.trim(),
                            event_date: this.editingEvent.event_date,
                            start_time: this.editingEvent.start_time,
                            end_time: this.editingEvent.end_time,
                            max_people: parseInt(this.editingEvent.max_people) || 10,
                            city: this.editingEvent.city.trim(),
                            address: this.editingEvent.address.trim() || null,
                            fee_info: this.editingEvent.fee_info.trim() || null,
                            notes: this.editingEvent.notes.trim() || null,
                            updated_at: new Date().toISOString()
                        };
                        const { error } = await this.supabase
                            .from('community_events')
                            .update(updateData)
                            .eq('id', this.editingEvent.id);
                        if (error) throw error;
                        
                        const index = this.communityEvents.findIndex(e => e.id === this.editingEvent.id);
                        if (index !== -1) this.communityEvents[index] = { ...this.communityEvents[index], ...updateData };
                        if (this.currentEventDetail?.id === this.editingEvent.id) {
                            this.currentEventDetail = { ...this.currentEventDetail, ...updateData };
                        }
                        this.showEditEventModal = false;
                        this.editingEvent = null;
                        this.filterCommunityEvents();
                        this.showNotification('success', 'æ›´æ–°æˆåŠŸ', 'æ´»åŠ¨å·²æ›´æ–°');
                    } catch (error) {
                        console.error('æ›´æ–°æ´»åŠ¨å¤±è´¥:', error);
                        this.showNotification('error', 'æ›´æ–°å¤±è´¥', error.message || 'æ›´æ–°æ´»åŠ¨å¤±è´¥');
                    }
                },
                
                async sendMessageToOrganizer(userId, username) {
                    if (!userId || !username) {
                        this.showNotification('error', 'é”™è¯¯', 'æ— æ³•è·å–å‘èµ·è€…ä¿¡æ¯');
                        return;
                    }
                    this.sendMessage(userId, username);
                    this.activeTab = 'messages';
                    setTimeout(() => {
                        if (this.currentEventDetail) {
                            this.newMessage = `æ‚¨å¥½ ${username}ï¼Œæˆ‘å¯¹æ‚¨å‘èµ·çš„æ´»åŠ¨ã€Œ${this.currentEventDetail.title}ã€å¾ˆæ„Ÿå…´è¶£ï¼Œè¯·é—®è¿˜æœ‰åé¢å—ï¼Ÿ\n\næˆ‘æƒ³äº†è§£æ›´å¤šæ´»åŠ¨ç»†èŠ‚ï¼Œæ–¹ä¾¿çš„è¯å¯ä»¥èŠèŠå—ï¼Ÿ`;
                        }
                    }, 500);
                },
                
                async shareEvent(eventId, eventTitle) {
                    try {
                        const shareUrl = `${window.location.origin}${window.location.pathname}#event-${eventId}`;
                        const shareText = `å‘ç°ä¸€ä¸ªå¾ˆæ£’çš„æ´»åŠ¨ï¼š"${eventTitle}"ï¼Œä¸€èµ·æ¥å‚åŠ å§ï¼`;
                        if (navigator.share) {
                            await navigator.share({ title: eventTitle, text: shareText, url: shareUrl });
                        } else {
                            await navigator.clipboard.writeText(`${shareText}\n\n${shareUrl}`);
                            this.showNotification('success', 'å·²å¤åˆ¶', 'æ´»åŠ¨é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                        }
                    } catch (error) {
                        console.error('åˆ†äº«å¤±è´¥:', error);
                    }
                },
                
                getCommunityEmptyMessage() {
                    if (this.communityView === 'myEvents') return 'æ‚¨è¿˜æ²¡æœ‰å‘èµ·è¿‡æ´»åŠ¨';
                    if (this.communityCityFilter) return `åœ¨"${this.communityCityFilter}"æ²¡æœ‰æ‰¾åˆ°ç›¸å…³æ´»åŠ¨`;
                    if (this.communityTypeFilter) return `æ²¡æœ‰æ‰¾åˆ°"${this.communityTypeFilter}"ç±»å‹çš„æ´»åŠ¨`;
                    return 'è¿˜æ²¡æœ‰äººå‘èµ·æ´»åŠ¨';
                },
                
                // ========== æŸ¥çœ‹ç”¨æˆ·èµ„æ–™ï¼ˆå·²ä¿®æ”¹ï¼šå®æ—¶è®¡ç®—è¯„åˆ†ï¼‰ ==========
                
                async viewProfile(userId) {
                    this.viewProfileLoading = true;
                    this.showViewProfileModal = true;
                    this.viewedUserProfile = null;
                    this.recentReviews = [];
                    try {
                        // å…ˆå°è¯•ä»æ•°æ®åº“åŠ è½½ profile
                        let profile = null;
                        const { data, error } = await this.supabase
                            .from('profiles')
                            .select('*')
                            .eq('id', userId)
                            .single();
                        if (!error && data) {
                            profile = data;
                        } else {
                            // å¦‚æœæ•°æ®åº“åŠ è½½å¤±è´¥ï¼Œä» matches ä¸­æ‰¾
                            const localMatch = this.matches.find(match => match.id === userId);
                            if (localMatch) {
                                profile = localMatch;
                            } else {
                                throw error || new Error('ç”¨æˆ·ä¸å­˜åœ¨');
                            }
                        }

                        // è®¡ç®—è¯„åˆ†å’Œè¯„ä»·æ•°
                        const { data: reviews, error: reviewsError } = await this.supabase
                            .from('reviews')
                            .select('skill_level, teaching_attitude, punctuality, communication')
                            .eq('reviewee_id', userId);

                        let totalReviews = 0;
                        let overallRating = 0;
                        if (!reviewsError && reviews) {
                            totalReviews = reviews.length;
                            if (totalReviews > 0) {
                                let sum = 0;
                                reviews.forEach(r => {
                                    sum += (r.skill_level + r.teaching_attitude + r.punctuality + r.communication) / 4;
                                });
                                overallRating = sum / totalReviews;
                            }
                        }

                        this.viewedUserProfile = {
                            ...profile,
                            overall_rating: overallRating,
                            total_reviews: totalReviews
                        };

                        // åŠ è½½æœ€æ–°ä¸‰æ¡è¯„ä»·
                        if (totalReviews > 0) {
                            const { data: recent, error: recentError } = await this.supabase
                                .from('reviews')
                                .select(`
                                    *,
                                    reviewer:reviewer_id ( username, avatar_url )
                                `)
                                .eq('reviewee_id', userId)
                                .order('created_at', { ascending: false })
                                .limit(3);
                            if (!recentError && recent) {
                                this.recentReviews = recent;
                            }
                        }
                    } catch (error) {
                        console.error('æŸ¥çœ‹èµ„æ–™å‡ºé”™:', error);
                        this.showNotification('error', 'åŠ è½½å¤±è´¥', 'æ— æ³•åŠ è½½ç”¨æˆ·è¯¦ç»†èµ„æ–™');
                    } finally {
                        this.viewProfileLoading = false;
                    }
                },
                
                // ========== æ–°å¢ï¼šåŠ è½½å…¨éƒ¨è¯„ä»·ï¼ˆç”¨äºå¼¹çª—ï¼‰ ==========
                async loadAllReviews(userId) {
                    const { data, error } = await this.supabase
                        .from('reviews')
                        .select(`
                            *,
                            reviewer:reviewer_id ( username, avatar_url )
                        `)
                        .eq('reviewee_id', userId)
                        .order('created_at', { ascending: false });
                    if (!error && data) {
                        this.allReviews = data;
                    }
                },
                
                // ========== è¯„ä»·ç³»ç»Ÿæ–¹æ³•ï¼ˆä¿ç•™ï¼‰ ==========
                
                async loadUserReviewStats() {
                    if (!this.currentUser) return;
                    try {
                        const { data: stats, error } = await this.supabase
                            .from('user_review_stats')
                            .select('*')
                            .eq('user_id', this.currentUser.id)
                            .single();
                        
                        if (stats && !error) {
                            this.userReviewStats = stats;
                        }
                    } catch (error) {
                        console.error('åŠ è½½è¯„ä»·ç»Ÿè®¡å¤±è´¥:', error);
                    }
                },
                
                async loadMyReviews() {
                    if (!this.currentUser) return;
                    try {
                        const { data: reviews, error } = await this.supabase
                            .from('reviews')
                            .select(`
                                *,
                                reviewer:reviewer_id(username, avatar_url)
                            `)
                            .eq('reviewee_id', this.currentUser.id)
                            .eq('is_visible', true)
                            .order('created_at', { ascending: false });
                        
                        if (error) throw error;
                        
                        this.myReviews = (reviews || []).map(review => ({
                            ...review,
                            reviewer_name: review.reviewer?.username || 'åŒ¿åç”¨æˆ·',
                            reviewer_avatar: review.reviewer?.avatar_url,
                            overall_rating: Math.round((review.skill_level + review.teaching_attitude + review.punctuality + review.communication) / 4)
                        }));
                    } catch (error) {
                        console.error('åŠ è½½è¯„ä»·å¤±è´¥:', error);
                    }
                },
                
                openReviewModalFromChat() {
                    if (!this.selectedConversation) {
                        this.showNotification('warning', 'è¯·å…ˆé€‰æ‹©å¯¹è¯');
                        return;
                    }
                    const user = {
                        id: this.selectedConversation.userId,
                        username: this.selectedConversation.username,
                        avatar_url: this.selectedConversation.avatar_url
                    };
                    this.openReviewModal(user, { type: 'skill_exchange', id: this.selectedConversationId });
                },
                
                openReviewModal(user, context = {}) {
                    this.reviewTarget = user;
                    this.reviewForm = {
                        skill_level: 0,
                        teaching_attitude: 0,
                        punctuality: 0,
                        communication: 0,
                        hover_skill: 0,
                        hover_teaching: 0,
                        hover_punctuality: 0,
                        hover_communication: 0,
                        tags: [],
                        content: '',
                        is_anonymous: false,
                        context_type: context.type || 'skill_exchange',
                        context_id: context.id || null
                    };
                    this.showReviewModal = true;
                },
                
                toggleReviewTag(tag) {
                    const index = this.reviewForm.tags.indexOf(tag);
                    if (index > -1) {
                        this.reviewForm.tags.splice(index, 1);
                    } else {
                        this.reviewForm.tags.push(tag);
                    }
                },
                
                isReviewValid() {
                    return this.reviewForm.skill_level > 0 &&
                           this.reviewForm.teaching_attitude > 0 &&
                           this.reviewForm.punctuality > 0 &&
                           this.reviewForm.communication > 0;
                },
                
                async submitReview() {
                    if (!this.isReviewValid() || !this.reviewTarget) return;
                    
                    try {
                        const reviewData = {
                            reviewer_id: this.currentUser.id,
                            reviewee_id: this.reviewTarget.id,
                            context_type: this.reviewForm.context_type,
                            context_id: this.reviewForm.context_id,
                            skill_level: this.reviewForm.skill_level,
                            teaching_attitude: this.reviewForm.teaching_attitude,
                            punctuality: this.reviewForm.punctuality,
                            communication: this.reviewForm.communication,
                            content: this.reviewForm.content,
                            tags: this.reviewForm.tags,
                            is_anonymous: this.reviewForm.is_anonymous,
                            created_at: new Date().toISOString()
                        };
                        
                        const { error } = await this.supabase.from('reviews').insert([reviewData]);
                        if (error) throw error;
                        
                        this.showReviewModal = false;
                        this.showNotification('success', 'è¯„ä»·æˆåŠŸ', 'æ„Ÿè°¢æ‚¨çš„åé¦ˆï¼');
                        await this.loadUserReviewStats();
                        
                    } catch (error) {
                        console.error('æäº¤è¯„ä»·å¤±è´¥:', error);
                        this.showNotification('error', 'è¯„ä»·å¤±è´¥', error.message);
                    }
                },
                
                async viewUserReviews(userId) {
                    this.showViewProfileModal = false;
                    this.profileSubTab = 'reviews';
                    await this.loadMyReviews();
                },
                
                // ========== æ–°å¢ï¼šåˆ†äº«ç³»ç»Ÿæ–¹æ³• ==========
                
                openMatchShareModal(match) {
                    this.shareMatchData = {
                        myName: this.userProfile.username,
                        myAvatar: this.userProfile.avatar_url,
                        mySkill: this.userProfile.teach_skill?.split(',')[0] || 'åˆ†äº«æŠ€èƒ½',
                        matchName: match.username,
                        matchAvatar: match.avatar_url,
                        matchSkill: match.teach_skill?.split(',')[0] || 'åˆ†äº«æŠ€èƒ½',
                        matchScore: match.matchScore,
                        sameCity: this.isSameCity(this.userProfile.city, match.city),
                        city: match.city
                    };
                    this.showMatchShareModal = true;
                },
                
                async downloadShareCard() {
                    try {
                        const element = document.getElementById('matchShareCard');
                        const canvas = await html2canvas(element, { scale: 2, backgroundColor: null, useCORS: true });
                        const link = document.createElement('a');
                        link.download = `çŸ¥èˆŸåŒ¹é…æˆåŠŸ-${Date.now()}.png`;
                        link.href = canvas.toDataURL();
                        link.click();
                        this.showNotification('success', 'ä¸‹è½½æˆåŠŸ', 'åˆ†äº«å¡ç‰‡å·²ä¿å­˜');
                    } catch (error) {
                        console.error('ç”Ÿæˆåˆ†äº«å¡ç‰‡å¤±è´¥:', error);
                        this.showNotification('error', 'ä¸‹è½½å¤±è´¥', 'è¯·å°è¯•æˆªå›¾ä¿å­˜');
                    }
                },
                
                shareToSocial() {
                    const text = `æˆ‘åœ¨çŸ¥èˆŸæŠ€èƒ½äº¤æ¢å¹³å°æ‰¾åˆ°äº†å®Œç¾çš„æŠ€èƒ½ä¼™ä¼´ï¼${this.shareMatchData.mySkill} äº¤æ¢ ${this.shareMatchData.matchSkill}ï¼ŒåŒ¹é…åº¦${this.shareMatchData.matchScore}%ï¼å¿«æ¥åŠ å…¥å§ï½`;
                    if (navigator.share) {
                        navigator.share({ title: 'æŠ€èƒ½åŒ¹é…æˆåŠŸï¼', text: text, url: window.location.origin });
                    } else {
                        navigator.clipboard.writeText(text);
                        this.showNotification('success', 'å·²å¤åˆ¶', 'åˆ†äº«æ–‡æ¡ˆå·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                    }
                },
                
                copyShareText() {
                    const text = `ğŸ‰ æŠ€èƒ½åŒ¹é…æˆåŠŸï¼\n\næˆ‘åœ¨ã€çŸ¥èˆŸæŠ€èƒ½äº¤æ¢å¹³å°ã€‘æ‰¾åˆ°äº†å®Œç¾çš„æŠ€èƒ½ä¼™ä¼´ï¼\n\nğŸ‘¤ ${this.shareMatchData.myName} (${this.shareMatchData.mySkill})\n   ğŸ¤\nğŸ‘¤ ${this.shareMatchData.matchName} (${this.shareMatchData.matchSkill})\n\nğŸ“Š åŒ¹é…åº¦ï¼š${this.shareMatchData.matchScore}%\n${this.shareMatchData.sameCity ? 'ğŸ“ åŒåŸä¼™ä¼´ï¼š' + this.shareMatchData.city : ''}\n\nğŸ’¡ æŠ€èƒ½äº¤æ¢ï¼Œè®©çŸ¥è¯†æµåŠ¨èµ·æ¥ï¼\nğŸŒ å¿«æ¥åŠ å…¥çŸ¥èˆŸï¼Œæ‰¾åˆ°ä½ çš„æŠ€èƒ½ä¼™ä¼´`;
                    navigator.clipboard.writeText(text);
                    this.showNotification('success', 'å·²å¤åˆ¶', 'åˆ†äº«æ–‡æ¡ˆå·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                },
                
                // ========== æ–°å¢ï¼šç²¾å½©æ—¶åˆ»æ–¹æ³• ==========
                
                async loadMoments() {
                    try {
                        const { data: moments, error } = await this.supabase
                            .from('moments')
                            .select(`
                                *,
                                author:user_id(username, avatar_url),
                                likes:moment_likes(count),
                                comments:moment_comments(count)
                            `)
                            .eq('is_public', true)
                            .order('created_at', { ascending: false })
                            .limit(20);

                        if (error) throw error;

                        let likedIds = new Set();
                        if (this.currentUser) {
                            const { data: myLikes } = await this.supabase
                                .from('moment_likes')
                                .select('moment_id')
                                .eq('user_id', this.currentUser.id);
                            likedIds = new Set((myLikes || []).map(l => l.moment_id));
                        }

                        this.moments = (moments || []).map(moment => ({
                            ...moment,
                            author_name: moment.author?.username,
                            author_avatar: moment.author?.avatar_url,
                            likes_count: moment.likes?.[0]?.count || 0,
                            comments_count: moment.comments?.[0]?.count || 0,
                            is_liked: likedIds.has(moment.id)
                        }));

                    } catch (error) {
                        console.error('åŠ è½½ç²¾å½©æ—¶åˆ»å¤±è´¥:', error);
                        this.moments = [];
                    }
                },
                
                openCreateMomentModal() {
                    this.momentForm = {
                        title: '',
                        description: '',
                        skill_given: this.userProfile?.teach_skill?.split(',')[0] || '',
                        skill_received: '',
                        media_type: 'image',
                        media_url: '',
                        preview_url: '',
                        submitting: false
                    };
                    this.showCreateMomentModal = true;
                },
                
                handleMomentFileUpload(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    if (file.size > 20 * 1024 * 1024) {
                        this.showNotification('error', 'æ–‡ä»¶è¿‡å¤§', 'è¯·ä¸Šä¼ å°äº20MBçš„æ–‡ä»¶');
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.momentForm.preview_url = e.target.result;
                        this.momentForm.media_type = file.type.startsWith('video/') ? 'video' : 'image';
                    };
                    reader.readAsDataURL(file);
                    this.momentForm.file = file;
                },
                
                async submitMoment() {
                    if (!this.momentForm.file) {
                        this.showNotification('warning', 'è¯·ä¸Šä¼ å›¾ç‰‡æˆ–è§†é¢‘');
                        return;
                    }
                    this.momentForm.submitting = true;
                    try {
                        const fileExt = this.momentForm.file.name.split('.').pop();
                        const fileName = `${this.currentUser.id}-${Date.now()}.${fileExt}`;
                        const filePath = `moments/${fileName}`;
                        
                        const { error: uploadError } = await this.supabase.storage
                            .from('moments')
                            .upload(filePath, this.momentForm.file);
                        
                        if (uploadError) throw uploadError;
                        
                        const { data: { publicUrl } } = this.supabase.storage
                            .from('moments')
                            .getPublicUrl(filePath);
                        
                        const { error: insertError } = await this.supabase.from('moments').insert([{
                            user_id: this.currentUser.id,
                            title: this.momentForm.title,
                            description: this.momentForm.description,
                            skill_given: this.momentForm.skill_given,
                            skill_received: this.momentForm.skill_received,
                            media_type: this.momentForm.media_type,
                            media_url: publicUrl,
                            is_public: true,
                            created_at: new Date().toISOString()
                        }]);
                        
                        if (insertError) throw insertError;
                        
                        this.showCreateMomentModal = false;
                        this.showNotification('success', 'å‘å¸ƒæˆåŠŸ', 'ä½ çš„ç²¾å½©æ—¶åˆ»å·²åˆ†äº«ï¼');
                        await this.loadMoments();
                        
                    } catch (error) {
                        console.error('å‘å¸ƒå¤±è´¥:', error);
                        this.showNotification('error', 'å‘å¸ƒå¤±è´¥', error.message);
                    } finally {
                        this.momentForm.submitting = false;
                    }
                },
                
                async likeMoment(moment) {
                    if (!this.currentUser) {
                        this.showNotification('warning', 'è¯·å…ˆç™»å½•');
                        return;
                    }
                    try {
                        if (moment.is_liked) {
                            await this.supabase.from('moment_likes').delete().eq('moment_id', moment.id).eq('user_id', this.currentUser.id);
                            moment.is_liked = false;
                            moment.likes_count--;
                        } else {
                            await this.supabase.from('moment_likes').insert([{ moment_id: moment.id, user_id: this.currentUser.id }]);
                            moment.is_liked = true;
                            moment.likes_count++;
                        }
                    } catch (error) {
                        console.error('ç‚¹èµå¤±è´¥:', error);
                    }
                },
                
                shareMoment(moment) {
                    const text = `ğŸ“¸ ç²¾å½©æ—¶åˆ» | ${moment.title}\n\n${moment.author_name} åˆ†äº«äº†æŠ€èƒ½äº¤æ¢æ•…äº‹ï¼š\nç”¨ "${moment.skill_given}" äº¤æ¢ "${moment.skill_received}"\n\n${moment.description}\n\nå¿«æ¥çŸ¥èˆŸå‘ç°æ›´å¤šç²¾å½©ï¼`;
                    if (navigator.share) {
                        navigator.share({ title: moment.title, text: text, url: window.location.href });
                    } else {
                        navigator.clipboard.writeText(text);
                        this.showNotification('success', 'å·²å¤åˆ¶', 'åˆ†äº«æ–‡æ¡ˆå·²å¤åˆ¶');
                    }
                },
                
                openMomentDetail(moment) {
                    console.log('æŸ¥çœ‹è¯¦æƒ…:', moment);
                },

                // ========== æ–°å¢ï¼šè¯„è®ºæ¨¡æ€æ¡†æ–¹æ³• ==========
                
                async openCommentModal(moment) {
                    this.currentCommentMomentId = moment.id;
                    this.newCommentContent = '';
                    this.showCommentModal = true;
                    await this.loadComments(moment.id);
                },
                
                async loadComments(momentId) {
                    try {
                        const { data: comments, error } = await this.supabase
                            .from('moment_comments')
                            .select(`*, author:user_id(username, avatar_url)`)
                            .eq('moment_id', momentId)
                            .order('created_at', { ascending: true });
                        
                        if (error) throw error;
                        
                        this.currentMomentComments = (comments || []).map(comment => ({
                            ...comment,
                            author_name: comment.author?.username || 'åŒ¿åç”¨æˆ·',
                            author_avatar: comment.author?.avatar_url
                        }));
                    } catch (error) {
                        console.error('åŠ è½½è¯„è®ºå¤±è´¥:', error);
                        this.currentMomentComments = [];
                    }
                },
                
                async submitComment() {
                    if (!this.newCommentContent.trim() || !this.currentCommentMomentId) return;
                    
                    try {
                        const { error } = await this.supabase.from('moment_comments').insert([{
                            moment_id: this.currentCommentMomentId,
                            user_id: this.currentUser.id,
                            content: this.newCommentContent.trim(),
                            created_at: new Date().toISOString()
                        }]);
                        
                        if (error) throw error;
                        
                        await this.loadComments(this.currentCommentMomentId);
                        
                        const moment = this.moments.find(m => m.id === this.currentCommentMomentId);
                        if (moment) {
                            moment.comments_count++;
                        }
                        
                        this.newCommentContent = '';
                        this.showNotification('success', 'è¯„è®ºæˆåŠŸ', 'ä½ çš„è¯„è®ºå·²å‘å¸ƒ');
                    } catch (error) {
                        console.error('æäº¤è¯„è®ºå¤±è´¥:', error);
                        this.showNotification('error', 'è¯„è®ºå¤±è´¥', error.message);
                    }
                },
                
                // ========== å·¥å…·å‡½æ•° ==========
                
                formatDate(dateString) {
                    const date = new Date(dateString);
                    const now = new Date();
                    const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));
                    if (diffDays === 0) return 'ä»Šå¤©';
                    if (diffDays === 1) return 'æ˜¨å¤©';
                    if (diffDays < 7) return `${diffDays}å¤©å‰`;
                    return date.toLocaleDateString('zh-CN', { month: 'long', day: 'numeric' });
                },
                
                formatTime(dateString) {
                    const date = new Date(dateString);
                    const now = new Date();
                    const diffHours = (now - date) / (1000 * 60 * 60);
                    if (diffHours < 24) {
                        return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
                    } else {
                        return date.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' });
                    }
                },
                
                formatEventDate(dateString) {
                    const date = new Date(dateString);
                    const today = new Date();
                    const tomorrow = new Date(today); tomorrow.setDate(tomorrow.getDate() + 1);
                    if (date.toDateString() === today.toDateString()) return 'ä»Šå¤©';
                    if (date.toDateString() === tomorrow.toDateString()) return 'æ˜å¤©';
                    return date.toLocaleDateString('zh-CN', { month: 'long', day: 'numeric', weekday: 'short' });
                },
                
                getUserInitial(name) {
                    return name ? name.charAt(0).toUpperCase() : '?';
                },
                
                formatEventDescription(desc) {
                    return desc ? desc.replace(/\n/g, '<br>') : '';
                },
                
                formatTimeAgo(dateString) {
                    const date = new Date(dateString);
                    const diff = (Date.now() - date) / 1000;
                    if (diff < 60) return 'åˆšåˆš';
                    if (diff < 3600) return `${Math.floor(diff / 60)}åˆ†é’Ÿå‰`;
                    if (diff < 86400) return `${Math.floor(diff / 3600)}å°æ—¶å‰`;
                    return `${Math.floor(diff / 86400)}å¤©å‰`;
                },
                
                showNotification(type, title, message) {
                    const id = ++this.notificationId;
                    const notification = { id, type, title, message, visible: true };
                    this.notifications.push(notification);
                    setTimeout(() => this.closeNotification(id), 5000);
                },
                
                closeNotification(id) {
                    const notification = this.notifications.find(n => n.id === id);
                    if (notification) {
                        notification.visible = false;
                        setTimeout(() => {
                            this.notifications = this.notifications.filter(n => n.id !== id);
                        }, 300);
                    }
                },
                
                // ========== å­¦ä¹ æ­å­ç›¸å…³æ–¹æ³• ==========
                async loadBuddies() {
                    if (!this.currentUser) return;
                    try {
                        const { data, error } = await this.supabase
                            .from('study_buddies')
                            .select(`
                                *,
                                profiles:user_id ( username, avatar_url )
                            `)
                            .eq('status', 'active')
                            .order('created_at', { ascending: false });
                        if (error) throw error;
                        this.buddies = (data || []).map(b => ({
                            ...b,
                            username: b.profiles?.username,
                            avatar_url: b.profiles?.avatar_url
                        }));
                        this.filterBuddies();
                    } catch (error) {
                        console.error('åŠ è½½å­¦ä¹ æ­å­å¤±è´¥:', error);
                    }
                },
                
                filterBuddies() {
                    let filtered = this.buddies;
                    
                    if (this.buddySearchKeyword) {
                        const q = this.buddySearchKeyword.toLowerCase();
                        filtered = filtered.filter(b => 
                            (b.goal && b.goal.toLowerCase().includes(q)) ||
                            (b.time_slot && b.time_slot.toLowerCase().includes(q)) ||
                            (b.city && b.city.toLowerCase().includes(q))
                        );
                    }
                    
                    if (this.buddyGoalFilter) {
                        filtered = filtered.filter(b => b.goal === this.buddyGoalFilter);
                    }
                    
                    if (this.buddyModeFilter) {
                        filtered = filtered.filter(b => b.mode === this.buddyModeFilter);
                    }
                    
                    if (this.sameCityActive) {
                        const userCity = this.userProfile?.city;
                        if (userCity) {
                            filtered = filtered.filter(b => b.city && this.isSameCity(userCity, b.city));
                        }
                    }
                    
                    this.filteredBuddies = filtered;
                },
                
                toggleSameCityBuddy() {
                    if (!this.userProfile?.city) {
                        this.showNotification('warning', 'è¯·å…ˆè®¾ç½®åŸå¸‚', 'è¯·åœ¨ä¸ªäººä¸­å¿ƒè®¾ç½®æ‚¨çš„åŸå¸‚ï¼Œæ‰èƒ½ä½¿ç”¨åŒåŸç­›é€‰');
                        this.activeTab = 'profile';
                        this.showEditModal = true;
                        return;
                    }
                    this.sameCityActive = !this.sameCityActive;
                    this.filterBuddies();
                },
                
                async submitBuddy() {
                    if (!this.currentUser) {
                        this.showNotification('warning', 'è¯·å…ˆç™»å½•');
                        return;
                    }
                    if (!this.newBuddy.goal || !this.newBuddy.time_slot) {
                        this.showNotification('error', 'è¯·å¡«å†™ç›®æ ‡å’Œæ—¶é—´æ®µ');
                        return;
                    }
                    try {
                        const { error } = await this.supabase.from('study_buddies').insert([{
                            user_id: this.currentUser.id,
                            goal: this.newBuddy.goal,
                            time_slot: this.newBuddy.time_slot,
                            city: this.newBuddy.city || null,
                            mode: this.newBuddy.mode
                        }]);
                        if (error) throw error;
                        this.showBuddyModal = false;
                        this.newBuddy = { goal: '', time_slot: '', city: '', mode: 'çº¿ä¸Š' };
                        this.showNotification('success', 'å‘å¸ƒæˆåŠŸ', 'ä½ çš„å­¦ä¹ æ­å­ä¿¡æ¯å·²å‘å¸ƒ');
                        await this.loadBuddies();
                    } catch (error) {
                        console.error('å‘å¸ƒå¤±è´¥:', error);
                        this.showNotification('error', 'å‘å¸ƒå¤±è´¥', error.message);
                    }
                },
                
                contactBuddy(buddy) {
                    if (!this.currentUser) {
                        this.showNotification('warning', 'è¯·å…ˆç™»å½•');
                        return;
                    }
                    this.sendMessage(buddy.user_id, buddy.username);
                    this.newMessage = `ä½ å¥½ ${buddy.username}ï¼Œæˆ‘åœ¨çŸ¥èˆŸä¸Šçœ‹åˆ°ä½ åœ¨æ‰¾å­¦ä¹ æ­å­ï¼ˆç›®æ ‡ï¼š${buddy.goal}ï¼‰ï¼Œå¸Œæœ›èƒ½ä¸€èµ·å­¦ä¹ ï¼`;
                    this.activeTab = 'messages';
                },
                
                async loadSavedBuddies() {
                    if (!this.currentUser) return;
                    try {
                        const { data: favs, error } = await this.supabase
                            .from('favorites')
                            .select('target_id')
                            .eq('user_id', this.currentUser.id)
                            .eq('target_type', 'buddy');
                        if (error) throw error;
                        this.savedBuddies = (favs || []).map(f => f.target_id);
                        
                        if (this.savedBuddies.length > 0) {
                            const { data: buddies, error: buddyError } = await this.supabase
                                .from('study_buddies')
                                .select(`
                                    *,
                                    profiles:user_id ( username, avatar_url )
                                `)
                                .in('id', this.savedBuddies)
                                .eq('status', 'active');
                            if (!buddyError && buddies) {
                                this.savedBuddiesList = buddies.map(b => ({
                                    ...b,
                                    username: b.profiles?.username,
                                    avatar_url: b.profiles?.avatar_url
                                }));
                            }
                        } else {
                            this.savedBuddiesList = [];
                        }
                    } catch (error) {
                        console.error('åŠ è½½æ”¶è—çš„æ­å­å¤±è´¥:', error);
                    }
                },
                
                isSaved(buddyId) {
                    return this.savedBuddies.includes(buddyId);
                },
                
                async toggleSaveBuddy(buddy) {
                    if (!this.currentUser) {
                        this.showNotification('warning', 'è¯·å…ˆç™»å½•');
                        return;
                    }
                    const buddyId = buddy.id;
                    try {
                        if (this.isSaved(buddyId)) {
                            const { error } = await this.supabase
                                .from('favorites')
                                .delete()
                                .eq('user_id', this.currentUser.id)
                                .eq('target_type', 'buddy')
                                .eq('target_id', buddyId);
                            if (error) throw error;
                            this.savedBuddies = this.savedBuddies.filter(id => id !== buddyId);
                            this.savedBuddiesList = this.savedBuddiesList.filter(b => b.id !== buddyId);
                            this.showNotification('success', 'å·²å–æ¶ˆæ”¶è—');
                        } else {
                            const { error } = await this.supabase
                                .from('favorites')
                                .insert([{
                                    user_id: this.currentUser.id,
                                    target_type: 'buddy',
                                    target_id: buddyId
                                }]);
                            if (error) throw error;
                            this.savedBuddies.push(buddyId);
                            await this.loadSavedBuddies();
                            this.showNotification('success', 'å·²æ”¶è—');
                        }
                    } catch (error) {
                        console.error('æ”¶è—æ“ä½œå¤±è´¥:', error);
                        this.showNotification('error', 'æ“ä½œå¤±è´¥', error.message);
                    }
                },

                // ========== æ–°å¢ï¼šæ¸…ç©ºèŠå¤©è®°å½•ç›¸å…³æ–¹æ³• ==========
                confirmClearChat() {
                    if (!this.selectedConversation) return;
                    if (confirm('ç¡®å®šæ¸…ç©ºä¸ ' + this.selectedConversation.username + ' çš„æ‰€æœ‰æ¶ˆæ¯å—ï¼Ÿ')) {
                        this.clearChatMessages();
                    }
                },

                async clearChatMessages() {
                    const otherId = this.selectedConversation.userId;
                    const { error } = await this.supabase
                        .from('messages')
                        .delete()
                        .or(`and(sender_id.eq.${this.currentUser.id},receiver_id.eq.${otherId}),and(sender_id.eq.${otherId},receiver_id.eq.${this.currentUser.id})`);
                    if (!error) {
                        this.selectedConversationMessages = [];
                        this.showNotification('success', 'èŠå¤©è®°å½•å·²æ¸…ç©º');
                        // æ›´æ–°å¯¹è¯åˆ—è¡¨çš„æœ€åä¸€æ¡æ¶ˆæ¯
                        const conv = this.conversations.find(c => c.id === this.selectedConversationId);
                        if (conv) conv.lastMessage = 'æš‚æ— æ¶ˆæ¯';
                    } else {
                        this.showNotification('error', 'æ¸…ç©ºå¤±è´¥', error.message);
                    }
                },
            }));
        });
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</body>
</html>