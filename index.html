<!DOCTYPE html>
<html lang="zh-CN" x-data="app()" x-cloak>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çŸ¥èˆŸæŠ€èƒ½äº¤æ¢å¹³å°</title>
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com/3.3.3"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <!-- è‡ªå®šä¹‰æ ·å¼ -->
    <style>
        [x-cloak] { display: none !important; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .skill-tag {
            display: inline-block;
            padding: 4px 12px;
            background: #e6f7ff;
            color: #1890ff;
            border-radius: 16px;
            font-size: 14px;
            margin: 4px;
        }
        
        .skill-tag.teach {
            background: #f6ffed;
            color: #52c41a;
            border: 1px solid #b7eb8f;
        }
        
        .skill-tag.learn {
            background: #fff7e6;
            color: #fa8c16;
            border: 1px solid #ffd591;
        }
        
        .match-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .match-high {
            background: #f6ffed;
            color: #52c41a;
        }
        
        .match-medium {
            background: #fff7e6;
            color: #fa8c16;
        }
        
        .match-low {
            background: #fff2f0;
            color: #ff4d4f;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: #1890ff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .message-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            margin-bottom: 8px;
        }
        
        .message-sent {
            background: #1890ff;
            color: white;
            margin-left: auto;
        }
        
        .message-received {
            background: #f0f0f0;
            color: #333;
        }
        
        .message-failed {
            background: linear-gradient(135deg, #ffcdd2 0%, #ffebee 100%);
            color: #d32f2f;
            margin-left: auto;
            position: relative;
            border: 1px solid #ffcdd2;
        }
        
        .message-failed::after {
            content: "å‘é€å¤±è´¥";
            position: absolute;
            top: -18px;
            right: 10px;
            font-size: 11px;
            color: #d32f2f;
            background: #ffebee;
            padding: 1px 6px;
            border-radius: 8px;
        }
        
        .fade-enter-active, .fade-leave-active {
            transition: opacity 0.3s ease;
        }
        
        .fade-enter-from, .fade-leave-to {
            opacity: 0;
        }
        
        .slide-enter-active {
            transition: all 0.3s ease-out;
        }
        
        .slide-leave-active {
            transition: all 0.3s ease-in;
        }
        
        .slide-enter-from {
            opacity: 0;
            transform: translateY(-10px);
        }
        
        .slide-leave-to {
            opacity: 0;
            transform: translateY(10px);
        }
        
        /* ç¡®ä¿æ¨¡æ€æ¡†åœ¨æœ€ä¸Šå±‚ */
        .z-50 {
            z-index: 50;
        }
        
        /* æ¨¡æ€æ¡†ç»ç’ƒæ•ˆæœ */
        .glasscard {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        /* è¡¨å•å…ƒç´ æ ·å¼å¢å¼º */
        input, textarea, select {
            transition: all 0.2s ease;
        }
        
        input:focus, textarea:focus, select:focus {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-6">
    <div class="max-w-6xl mx-auto">
        <!-- å¯¼èˆªæ  -->
        <nav class="glass-card p-4 mb-6 flex justify-between items-center" x-show="isAuthenticated">
            <div class="flex items-center space-x-4">
                <div class="w-10 h-10 rounded-full bg-gradient-to-r from-blue-500 to-blue-600 flex items-center justify-center text-white font-bold">
                    çŸ¥
                </div>
                <div>
                    <h1 class="text-xl font-bold text-gray-800">çŸ¥èˆŸæŠ€èƒ½äº¤æ¢</h1>
                    <p class="text-sm text-gray-600">æŠ€èƒ½äº¤æ¢ Â· çŸ¥è¯†å…±äº«</p>
                </div>
            </div>
            
            <div class="flex items-center space-x-4">
                <button @click="activeTab = 'profile'" :class="activeTab === 'profile' ? 'text-blue-600 font-medium' : 'text-gray-600'">
                    <i class="fas fa-user mr-2"></i>ä¸ªäººä¸­å¿ƒ
                </button>
                <button @click="activeTab = 'explore'" :class="activeTab === 'explore' ? 'text-blue-600 font-medium' : 'text-gray-600'">
                    <i class="fas fa-search mr-2"></i>æŠ€èƒ½æ¢ç´¢
                </button>
                <button @click="activeTab = 'messages'" :class="activeTab === 'messages' ? 'text-blue-600 font-medium' : 'text-gray-600'">
                    <i class="fas fa-comments mr-2"></i>æ¶ˆæ¯
                    <span x-show="unreadCount > 0" class="ml-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">
                        <span x-text="unreadCount"></span>
                    </span>
                </button>
                <button @click="logout" class="text-gray-600 hover:text-red-600">
                    <i class="fas fa-sign-out-alt mr-2"></i>é€€å‡º
                </button>
            </div>
        </nav>

        <!-- æœªç™»å½•çŠ¶æ€ï¼šç™»å½•/æ³¨å†Œè¡¨å• -->
        <div x-show="!isAuthenticated" class="flex flex-col items-center justify-center min-h-[80vh]">
            <div class="glass-card w-full max-w-md p-8">
                <!-- Logoå’Œæ ‡é¢˜ -->
                <div class="text-center mb-8">
                    <h1 class="text-2xl font-bold text-gray-800 mb-2">çŸ¥èˆŸæŠ€èƒ½äº¤æ¢å¹³å°</h1>
                    <p class="text-gray-600">åˆ†äº«æŠ€èƒ½ï¼Œå­¦ä¹ æ–°çŸ¥ - æ¯ä¸ªäººéƒ½æœ‰è‡ªå·±çš„ç‹¬ç‰¹ä»·å€¼</p>
                </div>

                <!-- æ ‡ç­¾åˆ‡æ¢ -->
                <div class="flex border-b mb-6">
                    <button 
                        @click="authMode = 'login'" 
                        :class="authMode === 'login' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-500'"
                        class="flex-1 py-3 font-medium text-center"
                    >
                        ç™»å½•
                    </button>
                    <button 
                        @click="authMode = 'register'" 
                        :class="authMode === 'register' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-500'"
                        class="flex-1 py-3 font-medium text-center"
                    >
                        æ³¨å†Œ
                    </button>
                </div>

                <!-- ç™»å½•è¡¨å• -->
                <div x-show="authMode === 'login'" x-transition:enter="fade-enter-active" x-transition:leave="fade-leave-active">
                    <form @submit.prevent="handleLogin" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“§ é‚®ç®±åœ°å€</label>
                            <input 
                                type="email" 
                                x-model="loginForm.email"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"
                                placeholder="è¯·è¾“å…¥æ³¨å†Œé‚®ç®±"
                                required
                            >
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ”‘ å¯†ç </label>
                            <input 
                                type="password" 
                                x-model="loginForm.password"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"
                                placeholder="è¯·è¾“å…¥å¯†ç "
                                required
                            >
                        </div>
                        
                        <button 
                            type="submit" 
                            :disabled="loading"
                            class="w-full py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white font-medium rounded-lg hover:from-blue-600 hover:to-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            <span x-show="!loading">ç™»å½•</span>
                            <span x-show="loading" class="flex items-center justify-center">
                                <span class="loading-spinner mr-2"></span>ç™»å½•ä¸­...
                            </span>
                        </button>
                    </form>
                </div>

                <!-- æ³¨å†Œè¡¨å• -->
                <div x-show="authMode === 'register'" x-transition:enter="fade-enter-active" x-transition:leave="fade-leave-active">
                    <form @submit.prevent="handleRegister" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“§ é‚®ç®±åœ°å€</label>
                            <input 
                                type="email" 
                                x-model="registerForm.email"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"
                                placeholder="è¯·è¾“å…¥é‚®ç®±"
                                required
                            >
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ”‘ å¯†ç </label>
                            <input 
                                type="password" 
                                x-model="registerForm.password"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"
                                placeholder="è‡³å°‘6ä½å­—ç¬¦"
                                required
                            >
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ‘¤ ç”¨æˆ·å</label>
                            <input 
                                type="text" 
                                x-model="registerForm.username"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"
                                placeholder="ç»™è‡ªå·±èµ·ä¸ªæ˜µç§°"
                                required
                            >
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ğŸŒŸ æˆ‘èƒ½åˆ†äº«çš„æŠ€èƒ½</label>
                            <textarea 
                                x-model="registerForm.teachSkills"
                                rows="3"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"
                                placeholder="æˆ‘æ“…é•¿åˆ†äº«çš„æŠ€èƒ½ï¼ˆæœ€å¤š5é¡¹ï¼‰&#10;æ¯è¡Œä¸€é¡¹æŠ€èƒ½ï¼Œä¾‹å¦‚ï¼š&#10;è§†é¢‘å‰ªè¾‘&#10;æ‘„å½±åæœŸ"
                            ></textarea>
                            <div class="text-xs text-gray-500 mt-1">æ¯è¡Œä¸€é¡¹æŠ€èƒ½ï¼Œæœ€å¤š5é¡¹</div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“š æˆ‘æƒ³å­¦ä¹ çš„æŠ€èƒ½</label>
                            <textarea 
                                x-model="registerForm.learnSkills"
                                rows="3"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"
                                placeholder="æˆ‘æ„Ÿå…´è¶£çš„å­¦ä¹ æŠ€èƒ½ï¼ˆæœ€å¤š5é¡¹ï¼‰&#10;æ¯è¡Œä¸€é¡¹æŠ€èƒ½ï¼Œä¾‹å¦‚ï¼š&#10;å•†åŠ¡è‹±è¯­&#10;æ•°æ®åˆ†æ"
                            ></textarea>
                            <div class="text-xs text-gray-500 mt-1">æ¯è¡Œä¸€é¡¹æŠ€èƒ½ï¼Œæœ€å¤š5é¡¹</div>
                        </div>
                        
                        <button 
                            type="submit" 
                            :disabled="loading"
                            class="w-full py-3 bg-gradient-to-r from-green-500 to-green-600 text-white font-medium rounded-lg hover:from-green-600 hover:to-green-700 transition disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            <span x-show="!loading">æ³¨å†Œ</span>
                            <span x-show="loading" class="flex items-center justify-center">
                                <span class="loading-spinner mr-2"></span>æ³¨å†Œä¸­...
                            </span>
                        </button>
                    </form>
                </div>

                <!-- åˆ‡æ¢æç¤º -->
                <div class="mt-6 text-center">
                    <p class="text-gray-600">
                        <span x-show="authMode === 'login'">è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ</span>
                        <span x-show="authMode === 'register'">å·²æœ‰è´¦å·ï¼Ÿ</span>
                        <button 
                            @click="authMode = authMode === 'login' ? 'register' : 'login'" 
                            class="text-blue-600 hover:text-blue-800 font-medium ml-1"
                        >
                            <span x-show="authMode === 'login'">ç«‹å³æ³¨å†Œ</span>
                            <span x-show="authMode === 'register'">ç«‹å³ç™»å½•</span>
                        </button>
                    </p>
                </div>
            </div>
        </div>

        <!-- å·²ç™»å½•çŠ¶æ€ï¼šç”¨æˆ·ä¸­å¿ƒ -->
        <div x-show="isAuthenticated" x-transition:enter="slide-enter-active" x-transition:leave="slide-leave-active">
            <!-- ä¸ªäººä¸­å¿ƒ -->
            <div x-show="activeTab === 'profile'" x-transition:enter="fade-enter-active" x-transition:leave="fade-leave-active">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- å·¦ä¾§ï¼šç”¨æˆ·ä¿¡æ¯ -->
                    <div class="glass-card p-6">
                        <div class="flex items-center mb-6">
                            <div class="w-16 h-16 rounded-full bg-gradient-to-r from-blue-500 to-blue-600 flex items-center justify-center text-white text-2xl font-bold">
                                <span x-text="userProfile.username ? userProfile.username.charAt(0) : '?'"></span>
                            </div>
                            <div class="ml-4">
                                <h2 class="text-xl font-bold text-gray-800" x-text="userProfile.username || 'ç”¨æˆ·'"></h2>
                                <p class="text-gray-600" x-text="userProfile.email"></p>
                            </div>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <h3 class="font-medium text-gray-700 mb-2">ğŸŒŸ æˆ‘èƒ½åˆ†äº«</h3>
                                <div>
                                    <span x-show="userProfile.teach_skill" class="skill-tag teach" x-text="userProfile.teach_skill"></span>
                                    <span x-show="!userProfile.teach_skill" class="text-gray-500 text-sm">æœªè®¾ç½®</span>
                                </div>
                            </div>
                            
                            <div>
                                <h3 class="font-medium text-gray-700 mb-2">ğŸ“š æˆ‘æƒ³å­¦ä¹ </h3>
                                <div>
                                    <span x-show="userProfile.learn_skill" class="skill-tag learn" x-text="userProfile.learn_skill"></span>
                                    <span x-show="!userProfile.learn_skill" class="text-gray-500 text-sm">æœªè®¾ç½®</span>
                                </div>
                            </div>
                            
                            <div>
                                <h3 class="font-medium text-gray-700 mb-2">ğŸ“ æ‰€åœ¨åŸå¸‚</h3>
                                <div>
                                    <span x-show="userProfile.city" class="skill-tag" x-text="userProfile.city"></span>
                                    <span x-show="!userProfile.city" class="text-gray-500 text-sm">æœªè®¾ç½®</span>
                                </div>
                            </div>
                            
                            <div>
                                <h3 class="font-medium text-gray-700 mb-2">ğŸ“ ä¸ªäººç®€ä»‹</h3>
                                <p x-show="userProfile.bio" class="text-gray-600 text-sm" x-text="userProfile.bio"></p>
                                <p x-show="!userProfile.bio" class="text-gray-500 text-sm">æœªè®¾ç½®</p>
                            </div>
                        </div>
                        
                        <button 
                            @click="showEditModal = true"
                            class="mt-6 w-full py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white font-medium rounded-lg hover:from-blue-600 hover:to-blue-700 transition"
                        >
                            <i class="fas fa-edit mr-2"></i>ç¼–è¾‘èµ„æ–™
                        </button>
                    </div>

                    <!-- ä¸­é—´ï¼šæŠ€èƒ½åŒ¹é… -->
                    <div class="glass-card p-6 md:col-span-2">
                        <h2 class="text-xl font-bold text-gray-800 mb-6">ğŸ¯ æ¨èåŒ¹é…</h2>
                        
                        <div x-show="matches.length === 0" class="text-center py-8">
                            <i class="fas fa-users text-gray-300 text-4xl mb-4"></i>
                            <p class="text-gray-500">æš‚æ— åŒ¹é…ç”¨æˆ·</p>
                            <p class="text-gray-400 text-sm mt-2">è¯·å®Œå–„æ‚¨çš„æŠ€èƒ½ä¿¡æ¯ä»¥è·å¾—æ›´ç²¾å‡†çš„åŒ¹é…</p>
                        </div>
                        
                        <div class="space-y-4" x-show="matches.length > 0">
                            <template x-for="match in matches" :key="match.id">
                                <div class="border border-gray-200 rounded-lg p-4 hover:border-blue-300 transition">
                                    <div class="flex justify-between items-start mb-3">
                                        <div>
                                            <h3 class="font-bold text-gray-800" x-text="match.username"></h3>
                                            <p class="text-gray-600 text-sm" x-text="match.email"></p>
                                        </div>
                                        <div class="flex flex-col items-end">
                                            <span 
                                                :class="{
                                                    'match-high': match.matchScore >= 80,
                                                    'match-medium': match.matchScore >= 50 && match.matchScore < 80,
                                                    'match-low': match.matchScore < 50
                                                }" 
                                                class="match-badge mb-1"
                                            >
                                                åŒ¹é…åº¦: <span x-text="match.matchScore"></span>%
                                            </span>
                                            <span x-show="match.city" class="text-xs text-gray-500">
                                                <i class="fas fa-map-marker-alt mr-1"></i><span x-text="match.city"></span>
                                            </span>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                        <div>
                                            <h4 class="font-medium text-gray-700 text-sm mb-2">èƒ½åˆ†äº«ï¼š</h4>
                                            <span class="skill-tag teach" x-text="match.teach_skill || 'æœªè®¾ç½®'"></span>
                                        </div>
                                        <div>
                                            <h4 class="font-medium text-gray-700 text-sm mb-2">æƒ³å­¦ä¹ ï¼š</h4>
                                            <span class="skill-tag learn" x-text="match.learn_skill || 'æœªè®¾ç½®'"></span>
                                        </div>
                                    </div>
                                    
                                    <div class="flex space-x-3">
                                        <button 
                                            @click="sendMessage(match.id, match.username)"
                                            class="flex-1 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white font-medium rounded-lg hover:from-blue-600 hover:to-blue-700 transition text-sm"
                                        >
                                            <i class="fas fa-comment mr-2"></i>å‘é€æ¶ˆæ¯
                                        </button>
                                        <button 
                                            @click="viewProfile(match.id)"
                                            class="flex-1 py-2 border border-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-50 transition text-sm"
                                        >
                                            <i class="fas fa-eye mr-2"></i>æŸ¥çœ‹èµ„æ–™
                                        </button>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æŠ€èƒ½æ¢ç´¢ -->
            <div x-show="activeTab === 'explore'" x-transition:enter="fade-enter-active" x-transition:leave="fade-leave-active">
                <div class="glass-card p-6">
                    <!-- æ ‡é¢˜è¡Œ -->
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                        <div>
                            <h2 class="text-xl font-bold text-gray-800 mb-2">ğŸ” æŠ€èƒ½æ¢ç´¢</h2>
                            <p class="text-gray-600">å‘ç°ä½ æ„Ÿå…´è¶£çš„æŠ€èƒ½ï¼Œæˆ–åˆ†äº«ä½ çš„ä¸“é•¿</p>
                        </div>
                        
                        <!-- å‘å¸ƒæŠ€èƒ½æŒ‰é’® -->
                        <button 
                            @click="openSkillModal()"
                            class="px-5 py-3 bg-gradient-to-r from-green-500 to-green-600 text-white font-medium rounded-lg hover:from-green-600 hover:to-green-700 transition-all duration-300 shadow-md hover:shadow-lg flex items-center"
                        >
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                            å‘å¸ƒæŠ€èƒ½
                        </button>
                    </div>
                    
                    <!-- æœç´¢å’Œç­›é€‰ -->
                    <div class="mb-6">
                        <div class="flex flex-col md:flex-row md:items-center space-y-4 md:space-y-0 md:space-x-4">
                            <div class="flex-1">
                                <input 
                                    type="text" 
                                    x-model="searchQuery"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"
                                    placeholder="æœç´¢æŠ€èƒ½æˆ–ç”¨æˆ·..."
                                >
                            </div>
                            <div class="flex space-x-4">
                                <select 
                                    x-model="skillFilter"
                                    class="px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"
                                >
                                    <option value="">å…¨éƒ¨æŠ€èƒ½</option>
                                    <option value="teach">æˆ‘èƒ½åˆ†äº«çš„</option>
                                    <option value="learn">æˆ‘æƒ³å­¦ä¹ çš„</option>
                                </select>
                                
                                <!-- åŒåŸç­›é€‰æŒ‰é’® -->
                                <button 
                                    @click="toggleSameCityFilter()"
                                    :class="showSameCityOnly ? 'bg-blue-600 text-white border-blue-600 hover:bg-blue-700' : 'border-gray-300 text-gray-700 hover:bg-gray-50'"
                                    class="px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition flex items-center"
                                    title="åªæ˜¾ç¤ºåŒåŸæŠ€èƒ½"
                                >
                                    <i class="fas fa-map-marker-alt mr-2"></i> 
                                    <span x-text="showSameCityOnly ? 'åŒåŸâœ“' : 'åŒåŸ'"></span>
                                </button>
                                
                                <button 
                                    @click="searchSkills"
                                    class="px-6 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white font-medium rounded-lg hover:from-blue-600 hover:to-blue-700 transition"
                                >
                                    <i class="fas fa-search mr-2"></i>æœç´¢
                                </button>
                            </div>
                        </div>
                        
                        <!-- åŒåŸç­›é€‰æç¤º -->
                        <div x-show="showSameCityOnly && userProfile && userProfile.city" class="mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                            <div class="flex items-center text-blue-800">
                                <i class="fas fa-info-circle mr-2"></i>
                                <span>æ­£åœ¨æ˜¾ç¤ºä¸ <strong x-text="userProfile.city"></strong> åŒåŸçš„æŠ€èƒ½</span>
                            </div>
                        </div>
                        <div x-show="showSameCityOnly && (!userProfile || !userProfile.city)" class="mt-3 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                            <div class="flex items-center text-yellow-800">
                                <i class="fas fa-exclamation-triangle mr-2"></i>
                                <span>è¯·å…ˆåœ¨<strong class="cursor-pointer text-blue-600 hover:text-blue-800" @click="activeTab = 'profile'">ä¸ªäººä¸­å¿ƒ</strong>è®¾ç½®æ‚¨çš„åŸå¸‚ï¼Œæ‰èƒ½ä½¿ç”¨åŒåŸç­›é€‰</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- æŠ€èƒ½å¡ç‰‡ç½‘æ ¼ -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <template x-for="skill in filteredSkills" :key="skill.id">
                            <div class="border border-gray-200 rounded-lg p-5 hover:shadow-lg transition">
                                <div class="flex justify-between items-start mb-4">
                                    <div>
                                        <h3 class="font-bold text-gray-800" x-text="skill.title"></h3>
                                        <p class="text-gray-600 text-sm" x-text="skill.author"></p>
                                    </div>
                                    <span 
                                        :class="{
                                            'bg-blue-100 text-blue-800': skill.category === 'ç¼–ç¨‹å¼€å‘',
                                            'bg-purple-100 text-purple-800': skill.category === 'è®¾è®¡åˆ›æ„',
                                            'bg-orange-100 text-orange-800': skill.category === 'ç”Ÿæ´»æŠ€èƒ½',
                                            'bg-green-100 text-green-800': skill.category === 'è¯­è¨€å­¦ä¹ ',
                                            'bg-pink-100 text-pink-800': skill.category === 'éŸ³ä¹è‰ºæœ¯',
                                            'bg-red-100 text-red-800': skill.category === 'è¿åŠ¨å¥èº«',
                                            'bg-yellow-100 text-yellow-800': skill.category === 'å•†ä¸šæŠ€èƒ½',
                                            'bg-indigo-100 text-indigo-800': skill.category === 'å­¦æœ¯è¾…å¯¼',
                                            'bg-gray-100 text-gray-800': skill.category === 'å…¶ä»–'
                                        }" 
                                        class="px-3 py-1 rounded-full text-xs font-medium"
                                    >
                                        <span x-text="skill.category"></span>
                                    </span>
                                </div>
                                
                                <p class="text-gray-600 text-sm mb-4" x-text="skill.description"></p>
                                
                                <div class="mb-4">
                                    <template x-for="tag in skill.tags" :key="tag">
                                        <span class="skill-tag" x-text="tag"></span>
                                    </template>
                                </div>
                                
                                <div class="flex justify-between items-center">
                                    <div class="text-left">
                                        <span class="text-gray-500 text-sm block">
                                            <i class="far fa-clock mr-1"></i>
                                            <span x-text="formatDate(skill.created_at)"></span>
                                        </span>
                                        <span x-show="skill.city" class="text-gray-500 text-sm">
                                            <i class="fas fa-map-marker-alt mr-1"></i>
                                            <span x-text="skill.city"></span>
                                        </span>
                                    </div>
                                    <button 
                                        @click="contactSkillOwner(skill)"
                                        class="px-4 py-2 bg-gradient-to-r from-green-500 to-green-600 text-white text-sm font-medium rounded-lg hover:from-green-600 hover:to-green-700 transition"
                                    >
                                        è”ç³»å­¦ä¹ 
                                    </button>
                                </div>
                            </div>
                        </template>
                    </div>
                    
                    <!-- ç©ºçŠ¶æ€ -->
                    <div x-show="filteredSkills.length === 0" class="text-center py-12">
                        <i class="fas fa-search text-gray-300 text-4xl mb-4"></i>
                        <p class="text-gray-500" x-text="getEmptyStateMessage()"></p>
                        <button 
                            @click="resetFilters()"
                            class="mt-4 px-6 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white font-medium rounded-lg hover:from-blue-600 hover:to-blue-700 transition"
                        >
                            æ¸…é™¤ç­›é€‰æ¡ä»¶
                        </button>
                    </div>
                </div>
            </div>

            <!-- æ¶ˆæ¯ä¸­å¿ƒ -->
            <div x-show="activeTab === 'messages'" x-transition:enter="fade-enter-active" x-transition:leave="fade-leave-active">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- å·¦ä¾§ï¼šå¯¹è¯åˆ—è¡¨ -->
                    <div class="glass-card p-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-6">ğŸ’¬ å¯¹è¯åˆ—è¡¨</h2>
                        
                        <!-- æœç´¢å¯¹è¯ -->
                        <div class="mb-4">
                            <input 
                                type="text" 
                                x-model="searchConversation"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"
                                placeholder="æœç´¢å¯¹è¯..."
                            >
                        </div>
                        
                        <div class="space-y-3">
                            <template x-for="conversation in filteredConversations" :key="conversation.id">
                                <div 
                                    @click="selectConversation(conversation.id)"
                                    :class="{
                                        'border-blue-300 bg-blue-50': selectedConversationId === conversation.id,
                                        'border-gray-200': selectedConversationId !== conversation.id
                                    }"
                                    class="border rounded-lg p-3 cursor-pointer hover:border-blue-300 transition flex items-start relative"
                                >
                                    <!-- åˆ é™¤æŒ‰é’® - æ–°å¢ -->
                                    <button 
                                        @click.stop="deleteConversation(conversation.id, conversation.username)"
                                        class="absolute top-2 right-2 w-6 h-6 rounded-full bg-gray-100 hover:bg-red-100 hover:text-red-600 text-gray-500 flex items-center justify-center transition-all duration-200 opacity-0 group-hover:opacity-100"
                                        title="åˆ é™¤å¯¹è¯"
                                    >
                                        <i class="fas fa-times text-xs"></i>
                                    </button>
                                    
                                    <!-- å½©è‰²å¤´åƒ -->
                                    <div :class="['w-10 h-10 rounded-full flex items-center justify-center text-white font-bold bg-gradient-to-r', conversation.avatarColor || 'from-blue-500 to-blue-600']">
                                        <span x-text="conversation.username.charAt(0)"></span>
                                    </div>
                                    
                                    <div class="ml-3 flex-1">
                                        <div class="flex justify-between items-start">
                                            <div>
                                                <h3 class="font-bold text-gray-800" x-text="conversation.username"></h3>
                                                <p x-show="conversation.skillTitle" class="text-xs text-blue-600 bg-blue-50 px-2 py-0.5 rounded inline-block">
                                                    <i class="fas fa-graduation-cap mr-1"></i>
                                                    <span x-text="conversation.skillTitle"></span>
                                                </p>
                                            </div>
                                            <span x-show="conversation.unread > 0" class="bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">
                                                <span x-text="conversation.unread"></span>
                                            </span>
                                        </div>
                                        
                                        <p class="text-gray-600 text-sm truncate mt-1" x-text="conversation.lastMessage"></p>
                                        
                                        <div class="flex justify-between items-center mt-2">
                                            <span class="text-gray-500 text-xs" x-text="formatTime(conversation.timestamp)"></span>
                                            <span x-show="conversation.skillId" class="text-blue-500 text-xs">
                                                <i class="fas fa-link"></i>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                        
                        <!-- ç©ºçŠ¶æ€ - ä¿®æ”¹ï¼šå»æ‰æ¨¡æ‹Ÿå¯¹è¯ -->
                        <div x-show="conversations.length === 0" class="text-center py-8">
                            <i class="fas fa-comments text-gray-300 text-4xl mb-4"></i>
                            <p class="text-gray-500">æš‚æ— å¯¹è¯</p>
                            <p class="text-gray-400 text-sm mt-2">å»æŠ€èƒ½æ¢ç´¢é¡µé¢è”ç³»æ„Ÿå…´è¶£çš„æŠ€èƒ½å‘å¸ƒè€…</p>
                            <button 
                                @click="activeTab = 'explore'"
                                class="mt-4 px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white text-sm font-medium rounded-lg hover:from-blue-600 hover:to-blue-700 transition"
                            >
                                <i class="fas fa-search mr-2"></i>æ¢ç´¢æŠ€èƒ½
                            </button>
                        </div>
                    </div>

                    <!-- å³ä¾§ï¼šèŠå¤©çª—å£ -->
                    <div class="glass-card p-6 md:col-span-2 flex flex-col">
                        <div x-show="selectedConversationId">
                            <!-- èŠå¤©å¤´éƒ¨ -->
                            <div class="border-b pb-4 mb-4">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center">
                                        <div class="w-12 h-12 rounded-full bg-gradient-to-r from-blue-500 to-blue-600 flex items-center justify-center text-white font-bold">
                                            <span x-text="selectedConversation ? selectedConversation.username.charAt(0) : ''"></span>
                                        </div>
                                        <div class="ml-4">
                                            <h3 class="font-bold text-gray-800" x-text="selectedConversation ? selectedConversation.username : ''"></h3>
                                            <p class="text-gray-600 text-sm">åœ¨çº¿</p>
                                        </div>
                                    </div>
                                    <button 
                                        @click="selectedConversationId = null"
                                        class="text-gray-500 hover:text-gray-700"
                                    >
                                        <i class="fas fa-times text-xl"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- æ¶ˆæ¯åŒºåŸŸ -->
                            <div class="flex-1 overflow-y-auto mb-4 space-y-4" style="max-height: 400px;">
                                <template x-for="message in selectedConversationMessages" :key="message.id">
                                    <div :class="message.sender === 'me' ? 'flex justify-end' : 'flex justify-start'">
                                        <div 
                                            :class="{
                                                'message-bubble message-sent': message.sender === 'me' && !message.failed,
                                                'message-bubble message-failed': message.sender === 'me' && message.failed,
                                                'message-bubble message-received': message.sender === 'other'
                                            }"
                                        >
                                            <p x-text="message.content"></p>
                                            <p class="text-xs opacity-70 mt-1" x-text="formatTime(message.timestamp)"></p>
                                        </div>
                                    </div>
                                </template>
                            </div>
                            
                            <!-- æ¶ˆæ¯è¾“å…¥ -->
                            <div class="border-t pt-4">
                                <div class="flex space-x-3">
                                    <input 
                                        type="text" 
                                        x-model="newMessage"
                                        @keyup.enter="sendNewMessage"
                                        class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"
                                        placeholder="è¾“å…¥æ¶ˆæ¯..."
                                    >
                                    <button 
                                        @click="sendNewMessage"
                                        :disabled="!newMessage.trim()"
                                        class="px-6 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white font-medium rounded-lg hover:from-blue-600 hover:to-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed"
                                    >
                                        å‘é€
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- æœªé€‰æ‹©å¯¹è¯çŠ¶æ€ -->
                        <div x-show="!selectedConversationId" class="flex-1 flex flex-col items-center justify-center">
                            <i class="fas fa-comments text-gray-300 text-6xl mb-6"></i>
                            <h3 class="text-xl font-medium text-gray-700 mb-2">é€‰æ‹©ä¸€ä¸ªå¯¹è¯</h3>
                            <p class="text-gray-500 text-center max-w-md">
                                ä»å·¦ä¾§é€‰æ‹©å¯¹è¯å¼€å§‹èŠå¤©ï¼Œæˆ–ä»æŠ€èƒ½åŒ¹é…ä¸­è”ç³»æ–°çš„ä¼™ä¼´
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç¼–è¾‘èµ„æ–™æ¨¡æ€æ¡† -->
        <div 
            x-show="showEditModal" 
            class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50"
            x-transition:enter="transition ease-out duration-300"
            x-transition:enter-start="opacity-0"
            x-transition:enter-end="opacity-100"
            x-transition:leave="transition ease-in duration-200"
            x-transition:leave-start="opacity-100"
            x-transition:leave-end="opacity-0"
        >
            <div 
                class="glasscard w-full max-w-md p-6 max-h-[90vh] overflow-y-auto"
                @click.away="showEditModal = false"
            >
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-800">ç¼–è¾‘ä¸ªäººèµ„æ–™</h2>
                    <button @click="showEditModal = false" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <form @submit.prevent="updateProfile" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ‘¤ ç”¨æˆ·å</label>
                        <input 
                            type="text" 
                            x-model="editForm.username"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"
                            placeholder="è¾“å…¥ç”¨æˆ·å"
                            required
                        >
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“ æ‰€åœ¨åŸå¸‚</label>
                        <input 
                            type="text" 
                            x-model="editForm.city"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"
                            placeholder="ä¾‹å¦‚ï¼šåŒ—äº¬å¸‚ã€ä¸Šæµ·å¸‚ã€å¹¿å·å¸‚"
                            required
                        >
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ğŸŒŸ æˆ‘èƒ½åˆ†äº«çš„æŠ€èƒ½</label>
                        <input 
                            type="text" 
                            x-model="editForm.teach_skill"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"
                            placeholder="ä¾‹å¦‚ï¼šè‹±è¯­æ•™å­¦ã€ç¼–ç¨‹ã€æ‘„å½±..."
                        >
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“š æˆ‘æƒ³å­¦ä¹ çš„æŠ€èƒ½</label>
                        <input 
                            type="text" 
                            x-model="editForm.learn_skill"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"
                            placeholder="ä¾‹å¦‚ï¼šè§†é¢‘å‰ªè¾‘ã€çƒ¹é¥ªã€è¥¿ç­ç‰™è¯­..."
                        >
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“ ä¸ªäººç®€ä»‹</label>
                        <textarea 
                            x-model="editForm.bio"
                            rows="3"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"
                            placeholder="ç®€å•ä»‹ç»ä¸€ä¸‹è‡ªå·±..."
                        ></textarea>
                    </div>
                    
                    <div class="flex space-x-3 pt-4">
                        <button 
                            type="submit" 
                            :disabled="loading"
                            class="flex-1 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white font-medium rounded-lg hover:from-blue-600 hover:to-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            <span x-show="!loading">ä¿å­˜ä¿®æ”¹</span>
                            <span x-show="loading" class="flex items-center justify-center">
                                <span class="loading-spinner mr-2"></span>ä¿å­˜ä¸­...
                            </span>
                        </button>
                        <button 
                            type="button" 
                            @click="showEditModal = false"
                            class="flex-1 py-3 border border-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-50 transition"
                        >
                            å–æ¶ˆ
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- æŸ¥çœ‹ç”¨æˆ·èµ„æ–™æ¨¡æ€æ¡† -->
        <div 
            x-show="showViewProfileModal" 
            class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50"
            x-transition:enter="transition ease-out duration-300"
            x-transition:enter-start="opacity-0"
            x-transition:enter-end="opacity-100"
            x-transition:leave="transition ease-in duration-200"
            x-transition:leave-start="opacity-100"
            x-transition:leave-end="opacity-0"
        >
            <div 
                class="glasscard w-full max-w-md p-6 max-h-[90vh] overflow-y-auto"
                @click.away="showViewProfileModal = false"
            >
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-800">ç”¨æˆ·èµ„æ–™</h2>
                    <button @click="showViewProfileModal = false" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <!-- èµ„æ–™å†…å®¹åŒºåŸŸ -->
                <div x-show="!viewProfileLoading && viewedUserProfile" class="space-y-4">
                    <div class="flex items-center mb-4">
                        <div class="w-16 h-16 rounded-full bg-gradient-to-r from-blue-500 to-blue-600 flex items-center justify-center text-white text-2xl font-bold">
                            <span x-text="viewedUserProfile.username ? viewedUserProfile.username.charAt(0) : '?'"></span>
                        </div>
                        <div class="ml-4">
                            <h2 class="text-xl font-bold text-gray-800" x-text="viewedUserProfile.username || 'ç”¨æˆ·'"></h2>
                            <p class="text-gray-600" x-text="viewedUserProfile.email || ''"></p>
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="font-medium text-gray-700 mb-2">ğŸ“ æ‰€åœ¨åŸå¸‚</h3>
                        <p x-show="viewedUserProfile.city" class="text-gray-600" x-text="viewedUserProfile.city"></p>
                        <p x-show="!viewedUserProfile.city" class="text-gray-500 text-sm">æœªè®¾ç½®</p>
                    </div>
                    
                    <div>
                        <h3 class="font-medium text-gray-700 mb-2">ğŸŒŸ æˆ‘èƒ½åˆ†äº«</h3>
                        <div>
                            <span x-show="viewedUserProfile.teach_skill" class="skill-tag teach" x-text="viewedUserProfile.teach_skill"></span>
                            <span x-show="!viewedUserProfile.teach_skill" class="text-gray-500 text-sm">æœªè®¾ç½®</span>
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="font-medium text-gray-700 mb-2">ğŸ“š æˆ‘æƒ³å­¦ä¹ </h3>
                        <div>
                            <span x-show="viewedUserProfile.learn_skill" class="skill-tag learn" x-text="viewedUserProfile.learn_skill"></span>
                            <span x-show="!viewedUserProfile.learn_skill" class="text-gray-500 text-sm">æœªè®¾ç½®</span>
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="font-medium text-gray-700 mb-2">ğŸ“ ä¸ªäººç®€ä»‹</h3>
                        <p x-show="viewedUserProfile.bio" class="text-gray-600 text-sm" x-text="viewedUserProfile.bio"></p>
                        <p x-show="!viewedUserProfile.bio" class="text-gray-500 text-sm">æœªè®¾ç½®</p>
                    </div>
                </div>
                
                <!-- åŠ è½½çŠ¶æ€ -->
                <div x-show="viewProfileLoading" class="text-center py-8">
                    <span class="loading-spinner"></span>
                    <p class="text-gray-500 mt-2">æ­£åœ¨åŠ è½½ç”¨æˆ·èµ„æ–™...</p>
                </div>
                
                <!-- åŠ è½½å¤±è´¥çŠ¶æ€ -->
                <div x-show="!viewProfileLoading && !viewedUserProfile" class="text-center py-8">
                    <i class="fas fa-user-slash text-gray-300 text-4xl mb-4"></i>
                    <p class="text-gray-500">æ— æ³•åŠ è½½ç”¨æˆ·èµ„æ–™</p>
                </div>
                
                <div class="flex space-x-3 pt-6">
                    <button 
                        @click="sendMessage(viewedUserProfile.id, viewedUserProfile.username)"
                        x-show="viewedUserProfile"
                        class="flex-1 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white font-medium rounded-lg hover:from-blue-600 hover:to-blue-700 transition"
                    >
                        <i class="fas fa-comment mr-2"></i>å‘é€æ¶ˆæ¯
                    </button>
                    <button 
                        type="button" 
                        @click="showViewProfileModal = false"
                        class="flex-1 py-3 border border-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-50 transition"
                    >
                        å…³é—­
                    </button>
                </div>
            </div>
        </div>

        <!-- ã€å·²ä¿®å¤ã€‘å‘å¸ƒæŠ€èƒ½æ¨¡æ€æ¡† -->
        <div 
            x-show="showSkillModal" 
            class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50"
            x-transition:enter="transition ease-out duration-300"
            x-transition:enter-start="opacity-0"
            x-transition:enter-end="opacity-100"
            x-transition:leave="transition ease-in duration-200"
            x-transition:leave-start="opacity-100"
            x-transition:leave-end="opacity-0"
        >
            <div 
                class="glasscard w-full max-w-md p-6 max-h-[90vh] overflow-y-auto"
                @click.away="showSkillModal = false"
            >
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-800">å‘å¸ƒæŠ€èƒ½</h2>
                    <button @click="showSkillModal = false" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <form @submit.prevent="publishSkill()" class="space-y-6">
                    <!-- æŠ€èƒ½æ ‡é¢˜ -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            æŠ€èƒ½æ ‡é¢˜
                        </label>
                        <input
                            type="text"
                            x-model="newSkill.title"
                            placeholder="ä¾‹å¦‚ï¼šVue.js å‰ç«¯å¼€å‘å®æˆ˜"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"
                            required
                        >
                    </div>
                    
                    <!-- æŠ€èƒ½æè¿° -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            æŠ€èƒ½æè¿°
                        </label>
                        <textarea
                            x-model="newSkill.description"
                            rows="6"
                            placeholder="è¯¦ç»†æè¿°ä½ çš„æŠ€èƒ½å†…å®¹ã€æ•™å­¦æ–¹å¼ã€èƒ½æ•™ä»€ä¹ˆã€é€‚åˆä»€ä¹ˆäººç¾¤..."
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition resize-none"
                            required
                        ></textarea>
                        <p class="text-sm text-gray-500 mt-2">
                            ç¤ºä¾‹ï¼šæˆ‘æ˜¯ä¸“ä¸šè§†é¢‘å‰ªè¾‘å¸ˆï¼Œæœ‰5å¹´è¡Œä¸šç»éªŒã€‚æˆ‘èƒ½æ•™ä½ ï¼š1. è§†é¢‘å‰ªè¾‘åŸºç¡€ï¼›Premiereã€Final Cut Proè½¯ä»¶æ“ä½œï¼›2. å‰ªè¾‘æŠ€å·§ï¼›3. é•œå¤´è¡”æ¥ã€èŠ‚å¥æ§åˆ¶ã€æ•…äº‹å™è¿°ï¼›4. ç‰¹æ•ˆåˆ¶ä½œï¼›5. è½¬åœºç‰¹æ•ˆã€æ–‡å­—åŠ¨ç”»ã€è°ƒè‰²æŠ€æœ¯ã€‚
                        </p>
                    </div>
                    
                    <!-- é€‰æ‹©åˆ†ç±» -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            é€‰æ‹©åˆ†ç±»
                        </label>
                        <select
                            x-model="newSkill.category"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"
                            required
                        >
                            <option value="">è¯·é€‰æ‹©åˆ†ç±»</option>
                            <option value="è¯­è¨€å­¦ä¹ ">è¯­è¨€å­¦ä¹ </option>
                            <option value="è§†é¢‘å‰ªè¾‘">è§†é¢‘å‰ªè¾‘</option>
                            <option value="ç¼–ç¨‹å¼€å‘">ç¼–ç¨‹å¼€å‘</option>
                            <option value="è®¾è®¡åˆ›æ„">è®¾è®¡åˆ›æ„</option>
                            <option value="éŸ³ä¹è‰ºæœ¯">éŸ³ä¹è‰ºæœ¯</option>
                            <option value="ç”Ÿæ´»æŠ€èƒ½">ç”Ÿæ´»æŠ€èƒ½</option>
                            <option value="å¥åº·è¿åŠ¨">å¥åº·è¿åŠ¨</option>
                            <option value="å•†ä¸šé‡‘è">å•†ä¸šé‡‘è</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                    </div>
                    
                    <!-- æ•™å­¦æ–¹å¼ -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            æ•™å­¦æ–¹å¼
                        </label>
                        <div class="flex space-x-4">
                            <label class="flex items-center">
                                <input
                                    type="radio"
                                    x-model="newSkill.teachingMethod"
                                    value="åœ¨çº¿"
                                    class="mr-2 text-blue-600 focus:ring-blue-500"
                                >
                                <span>åœ¨çº¿</span>
                            </label>
                            <label class="flex items-center">
                                <input
                                    type="radio"
                                    x-model="newSkill.teachingMethod"
                                    value="çº¿ä¸‹"
class="mr-2 text-blue-600 focus:ring-blue-500"
                                >
                                <span>çº¿ä¸‹</span>
                            </label>
                            <label class="flex items-center">
                                <input
                                    type="radio"
                                    x-model="newSkill.teachingMethod"
                                    value="çº¿ä¸Šçº¿ä¸‹ç»“åˆ"
                                    class="mr-2 text-blue-600 focus:ring-blue-500"
                                >
                                <span>çº¿ä¸Šçº¿ä¸‹ç»“åˆ</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- åŸå¸‚ -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            åŸå¸‚
                        </label>
                        <input
                            type="text"
                            x-model="newSkill.city"
                            placeholder="è¾“å…¥æ•™å­¦åŸå¸‚"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"
                        >
                        <p class="text-sm text-gray-500 mt-2">
                            å¦‚æœé€‰æ‹©åœ¨çº¿æ•™å­¦ï¼Œå¯ä»¥ä¸å¡«å†™åŸå¸‚
                        </p>
                    </div>
                    
                    <!-- æ“ä½œæŒ‰é’® -->
                    <div class="flex space-x-3 pt-4">
                        <button
                            type="submit"
                            class="flex-1 py-3 bg-gradient-to-r from-green-500 to-green-600 text-white font-medium rounded-lg hover:from-green-600 hover:to-green-700 transition"
                        >
                            <i class="fas fa-paper-plane mr-2"></i>å‘å¸ƒæŠ€èƒ½
                        </button>
                        <button
                            type="button"
                            @click="showSkillModal = false"
                            class="flex-1 py-3 border border-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-50 transition"
                        >
                            å–æ¶ˆ
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- é€šçŸ¥åŒºåŸŸ -->
    <div class="fixed top-4 right-4 z-50 space-y-3">
        <template x-for="notification in notifications" :key="notification.id">
            <div 
                x-show="notification.visible"
                x-transition:enter="transition ease-out duration-300"
                x-transition:enter-start="translate-x-full opacity-0"
                x-transition:enter-end="translate-x-0 opacity-100"
                x-transition:leave="transition ease-in duration-200"
                x-transition:leave-start="translate-x-0 opacity-100"
                x-transition:leave-end="translate-x-full opacity-0"
                :class="{
                    'bg-green-100 border-green-400 text-green-800': notification.type === 'success',
                    'bg-red-100 border-red-400 text-red-800': notification.type === 'error',
                    'bg-blue-100 border-blue-400 text-blue-800': notification.type === 'info'
                }"
                class="border rounded-lg p-4 shadow-lg max-w-sm"
            >
                <div class="flex justify-between items-start">
                    <div class="flex items-center">
                        <i 
                            :class="{
                                'fas fa-check-circle text-green-600': notification.type === 'success',
                                'fas fa-exclamation-circle text-red-600': notification.type === 'error',
                                'fas fa-info-circle text-blue-600': notification.type === 'info'
                            }"
                            class="mr-3"
                        ></i>
                        <div>
                            <h4 class="font-medium" x-text="notification.title"></h4>
                            <p class="text-sm mt-1" x-text="notification.message"></p>
                        </div>
                    </div>
                    <button @click="closeNotification(notification.id)" class="text-gray-500 hover:text-gray-700 ml-4">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        </template>
    </div>

    <!-- Alpine.js åº”ç”¨é€»è¾‘ -->
    <script>
        const SUPABASE_URL = 'https://bsxrwsgewqgeeikfeeoa.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_kABjoeJgvH8l196MDbpA-A_3YyAGNqo';
        
        document.addEventListener('alpine:init', () => {
            Alpine.data('app', () => ({
                supabase: null,
                
                authMode: 'login',
                activeTab: 'profile',
                isAuthenticated: false,
                loading: false,
                
                currentUser: null,
                userProfile: {},
                
                loginForm: {
                    email: '',
                    password: ''
                },
                
                registerForm: {
                    email: '',
                    password: '',
                    username: '',
                    teachSkills: '',
                    learnSkills: ''
                },
                
                editForm: {
                    username: '',
                    city: '',
                    teach_skill: '',
                    learn_skill: '',
                    bio: ''
                },
                
                // æ›´æ–° newSkill å¯¹è±¡ä»¥åŒ¹é…ä¿®å¤åçš„æ¨¡æ€æ¡†
                newSkill: {
                    title: '',
                    description: '',
                    category: '',
                    teachingMethod: 'åœ¨çº¿', // ä¿®æ”¹ï¼šå°† method æ”¹ä¸º teachingMethod
                    city: ''
                },
                
                showEditModal: false,
                showSkillModal: false,
                
                // ======== ã€æ–°å¢çš„å˜é‡ã€‘ ========
                showViewProfileModal: false,        // æ§åˆ¶æŸ¥çœ‹èµ„æ–™å¼¹çª—æ˜¾ç¤º
                viewProfileLoading: false,          // æŸ¥çœ‹èµ„æ–™åŠ è½½çŠ¶æ€
                viewedUserProfile: null,            // å­˜å‚¨æŸ¥çœ‹çš„ç”¨æˆ·èµ„æ–™
                // ====================================
                
                showSameCityOnly: false,
                
                notifications: [],
                notificationId: 0,
                
                searchQuery: '',
                skillFilter: '',
                skills: [],
                
                matches: [],
                
                conversations: [],
                selectedConversationId: null,
                selectedConversation: null,
                selectedConversationMessages: [],
                newMessage: '',
                unreadCount: 0,
                
                searchConversation: '',
                
                // æ–°å¢ï¼šå­˜å‚¨å·²åˆ é™¤çš„å¯¹è¯ID
                deletedConversations: [],
                
                // ============ ä¿®å¤åçš„viewProfileå‡½æ•° ============
                async viewProfile(userId) {
                    console.log('æŸ¥çœ‹ç”¨æˆ·èµ„æ–™ï¼Œç”¨æˆ·ID:', userId);
                    
                    if (!userId) {
                        this.showNotification('error', 'é”™è¯¯', 'æ— æ³•è·å–ç”¨æˆ·ä¿¡æ¯');
                        return;
                    }
                    
                    this.viewProfileLoading = true;
                    this.showViewProfileModal = true;
                    this.viewedUserProfile = null;
                    
                    try {
                        // 1. ä»Supabaseè·å–ç”¨æˆ·èµ„æ–™
                        const { data, error } = await this.supabase
                            .from('profiles')
                            .select('*')
                            .eq('id', userId)
                            .single();
                        
                        if (error) {
                            console.error('è·å–ç”¨æˆ·èµ„æ–™å¤±è´¥:', error);
                            // å°è¯•ä»æœ¬åœ°åŒ¹é…åˆ—è¡¨ä¸­æŸ¥æ‰¾ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
                            const localMatch = this.matches.find(match => match.id === userId);
                            if (localMatch) {
                                this.viewedUserProfile = localMatch;
                                this.showNotification('info', 'èµ„æ–™åŠ è½½', `å·²æ˜¾ç¤º ${localMatch.username} çš„åŸºæœ¬ä¿¡æ¯`);
                            } else {
                                throw new Error('æœªæ‰¾åˆ°è¯¥ç”¨æˆ·èµ„æ–™');
                            }
                        } else {
                            // æˆåŠŸä»æ•°æ®åº“è·å–
                            this.viewedUserProfile = data;
                            console.log('æˆåŠŸåŠ è½½ç”¨æˆ·èµ„æ–™:', data);
                        }
                        
                    } catch (error) {
                        console.error('æŸ¥çœ‹èµ„æ–™è¿‡ç¨‹ä¸­å‡ºé”™:', error);
                        this.showNotification('error', 'åŠ è½½å¤±è´¥', 'æ— æ³•åŠ è½½ç”¨æˆ·è¯¦ç»†èµ„æ–™ï¼Œå¯èƒ½è¯¥ç”¨æˆ·å°šæœªå®Œå–„ä¿¡æ¯ã€‚');
                    } finally {
                        this.viewProfileLoading = false;
                    }
                },
                
                // ============ æ–°å¢å‡½æ•° ============
                
                // åˆ é™¤å¯¹è¯
                async deleteConversation(conversationId, username) {
                    if (!confirm(`ç¡®å®šè¦åˆ é™¤ä¸ ${username} çš„å¯¹è¯å—ï¼Ÿ\n\næ³¨æ„ï¼šè¿™ä¼šåˆ é™¤æœ¬åœ°å¯¹è¯è®°å½•ï¼Œä½†ä¸ä¼šåˆ é™¤æ•°æ®åº“ä¸­çš„æ¶ˆæ¯ã€‚`)) {
                        return;
                    }
                    
                    try {
                        // å¦‚æœå½“å‰æ­£åœ¨æŸ¥çœ‹è¿™ä¸ªå¯¹è¯ï¼Œå…ˆå…³é—­å®ƒ
                        if (this.selectedConversationId === conversationId) {
                            this.selectedConversationId = null;
                            this.selectedConversation = null;
                            this.selectedConversationMessages = [];
                        }
                        
                        // ä»å¯¹è¯åˆ—è¡¨ä¸­ç§»é™¤
                        this.conversations = this.conversations.filter(c => c.id !== conversationId);
                        
                        // è®°å½•åˆ°å·²åˆ é™¤åˆ—è¡¨ä¸­ï¼ˆé¿å…é‡æ–°åŠ è½½æ—¶å†æ¬¡æ˜¾ç¤ºï¼‰
                        if (!this.deletedConversations.includes(conversationId)) {
                            this.deletedConversations.push(conversationId);
                            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                            this.saveDeletedConversations();
                        }
                        
                        // é‡æ–°è®¡ç®—æœªè¯»æ•°
                        this.unreadCount = this.conversations.reduce((sum, conv) => sum + (conv.unread || 0), 0);
                        
                        this.showNotification('success', 'åˆ é™¤æˆåŠŸ', `å·²åˆ é™¤ä¸ ${username} çš„å¯¹è¯`);
                        
                    } catch (error) {
                        console.error('åˆ é™¤å¯¹è¯å¤±è´¥:', error);
                        this.showNotification('error', 'åˆ é™¤å¤±è´¥', 'åˆ é™¤å¯¹è¯æ—¶å‡ºç°é”™è¯¯');
                    }
                },
                
                // ä¿å­˜å·²åˆ é™¤çš„å¯¹è¯åˆ°æœ¬åœ°å­˜å‚¨
                saveDeletedConversations() {
                    try {
                        localStorage.setItem('deletedConversations', JSON.stringify(this.deletedConversations));
                    } catch (error) {
                        console.warn('ä¿å­˜å·²åˆ é™¤å¯¹è¯åˆ°æœ¬åœ°å­˜å‚¨å¤±è´¥:', error);
                    }
                },
                
                // ä»æœ¬åœ°å­˜å‚¨åŠ è½½å·²åˆ é™¤çš„å¯¹è¯
                loadDeletedConversations() {
                    try {
                        const saved = localStorage.getItem('deletedConversations');
                        if (saved) {
                            this.deletedConversations = JSON.parse(saved);
                        }
                    } catch (error) {
                        console.warn('ä»æœ¬åœ°å­˜å‚¨åŠ è½½å·²åˆ é™¤å¯¹è¯å¤±è´¥:', error);
                        this.deletedConversations = [];
                    }
                },
                
                // è¿‡æ»¤å·²åˆ é™¤çš„å¯¹è¯
                filterDeletedConversations(conversationsList) {
                    if (!this.deletedConversations || this.deletedConversations.length === 0) {
                        return conversationsList;
                    }
                    
                    return conversationsList.filter(conv => !this.deletedConversations.includes(conv.id));
                },
                
                toggleSameCityFilter() {
                    if (!this.userProfile || !this.userProfile.city) {
                        this.showNotification('warning', 'è¯·å…ˆè®¾ç½®åŸå¸‚', 'è¯·åœ¨ä¸ªäººä¸­å¿ƒè®¾ç½®æ‚¨çš„åŸå¸‚ï¼Œæ‰èƒ½ä½¿ç”¨åŒåŸç­›é€‰åŠŸèƒ½');
                        this.activeTab = 'profile';
                        this.showEditModal = true;
                        return;
                    }
                    
                    this.showSameCityOnly = !this.showSameCityOnly;
                    
                    if (this.showSameCityOnly) {
                        console.log('å¯ç”¨åŒåŸç­›é€‰ï¼Œç”¨æˆ·åŸå¸‚:', this.userProfile.city);
                        this.searchSkills();
                    }
                },
                
                getEmptyStateMessage() {
                    if (this.showSameCityOnly && this.userProfile && this.userProfile.city) {
                        return `å½“å‰æ²¡æœ‰æ‰¾åˆ°ä¸"${this.userProfile.city}"åŒåŸçš„æŠ€èƒ½`;
                    }
                    if (this.searchQuery) {
                        return `æ²¡æœ‰æ‰¾åˆ°"${this.searchQuery}"ç›¸å…³çš„æŠ€èƒ½`;
                    }
                    if (this.skillFilter) {
                        if (this.skillFilter === 'teach') {
                            return 'æš‚æ—¶æ²¡æœ‰å¯åˆ†äº«çš„æŠ€èƒ½';
                        } else {
                            return 'æš‚æ—¶æ²¡æœ‰å¯å­¦ä¹ çš„æŠ€èƒ½';
                        }
                    }
                    return 'è¿˜æ²¡æœ‰æŠ€èƒ½å‘å¸ƒ';
                },
                
                resetFilters() {
                    this.searchQuery = '';
                    this.skillFilter = '';
                    this.showSameCityOnly = false;
                },
                
                // ============ æ ¸å¿ƒé€»è¾‘ ============
                
                async init() {
                    this.supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    
                    // åŠ è½½å·²åˆ é™¤çš„å¯¹è¯åˆ—è¡¨
                    this.loadDeletedConversations();
                    
                    await this.checkAuthStatus();
                    
                    if (this.isAuthenticated) {
                        await this.loadUserProfile();
                        await this.loadMatches();
                        await this.loadSkills();
                        await this.loadConversations();
                    }
                    
                    this.supabase.auth.onAuthStateChange((event, session) => {
                        console.log('è®¤è¯çŠ¶æ€å˜åŒ–:', event);
                        if (event === 'SIGNED_IN' || event === 'USER_UPDATED') {
                            this.isAuthenticated = true;
                            this.currentUser = session.user;
                            this.loadUserProfile();
                            this.loadMatches();
                            this.loadSkills();
                            this.loadConversations();
                        } else if (event === 'SIGNED_OUT') {
                            this.isAuthenticated = false;
                            this.currentUser = null;
                            this.userProfile = {};
                            this.matches = [];
                            this.conversations = [];
                            this.skills = [];
                            this.showSameCityOnly = false;
                        }
                    });
                },
                
                async checkAuthStatus() {
                    try {
                        const { data: { session } } = await this.supabase.auth.getSession();
                        if (session) {
                            this.isAuthenticated = true;
                            this.currentUser = session.user;
                        }
                    } catch (error) {
                        console.error('æ£€æŸ¥è®¤è¯çŠ¶æ€å¤±è´¥:', error);
                    }
                },
                
                async loadUserProfile() {
                    if (!this.currentUser) return;
                    
                    try {
                        const { data, error } = await this.supabase
                            .from('profiles')
                            .select('*')
                            .eq('id', this.currentUser.id)
                            .single();
                        
                        if (error) {
                            if (error.code === 'PGRST116') {
                                await this.createUserProfile();
                                return;
                            }
                            throw error;
                        }
                        
                        this.userProfile = data;
                        
                        this.editForm = {
                            username: data.username || '',
                            city: data.city || '',
                            teach_skill: data.teach_skill || '',
                            learn_skill: data.learn_skill || '',
                            bio: data.bio || ''
                        };
                        
                    } catch (error) {
                        console.error('åŠ è½½ç”¨æˆ·èµ„æ–™å¤±è´¥:', error);
                        this.showNotification('error', 'åŠ è½½å¤±è´¥', 'æ— æ³•åŠ è½½ç”¨æˆ·èµ„æ–™');
                    }
                },
                
                async createUserProfile() {
                    try {
                        const { error } = await this.supabase
                            .from('profiles')
                            .insert({
                                id: this.currentUser.id,
                                username: this.currentUser.email.split('@')[0],
                                email: this.currentUser.email,
                                created_at: new Date().toISOString(),
                                updated_at: new Date().toISOString()
                            });
                        
                        if (error) throw error;
                        
                        await this.loadUserProfile();
                        
                    } catch (error) {
                        console.error('åˆ›å»ºç”¨æˆ·èµ„æ–™å¤±è´¥:', error);
                        this.showNotification('error', 'åˆ›å»ºå¤±è´¥', 'æ— æ³•åˆ›å»ºç”¨æˆ·èµ„æ–™');
                    }
                },
                
                async updateProfile() {
                    if (!this.currentUser) return;
                    
                    this.loading = true;
                    
                    try {
                        const cleanSkill = (skill) => {
                            if (!skill) return '';
                            return skill.trim().replace(/[ã€ï¼Œ,]/g, ',').split(',')[0].trim();
                        };
                        
                        const updates = {
                            username: this.editForm.username || '',
                            city: this.editForm.city || '',
                            teach_skill: cleanSkill(this.editForm.teach_skill),
                            learn_skill: cleanSkill(this.editForm.learn_skill),
                            bio: this.editForm.bio || '',
                            updated_at: new Date().toISOString()
                        };
                        
                        console.log('ğŸ“ æ›´æ–°ç”¨æˆ·èµ„æ–™:', updates);
                        
                        const { error } = await this.supabase
                            .from('profiles')
                            .update(updates)
                            .eq('id', this.currentUser.id);
                        
                        if (error) throw error;
                        
                        this.userProfile = { ...this.userProfile, ...updates };
                        
                        this.showEditModal = false;
                        
                        this.showNotification('success', 'æ›´æ–°æˆåŠŸ', 'ä¸ªäººèµ„æ–™å·²æ›´æ–°');
                        
                        await this.loadMatches();
                        
                        console.log('âœ… ç”¨æˆ·èµ„æ–™æ›´æ–°æˆåŠŸï¼ŒåŒ¹é…åº¦å·²é‡æ–°è®¡ç®—');
                        
                    } catch (error) {
                        console.error('æ›´æ–°ç”¨æˆ·èµ„æ–™å¤±è´¥:', error);
                        this.showNotification('error', 'æ›´æ–°å¤±è´¥', 'æ— æ³•æ›´æ–°ä¸ªäººèµ„æ–™');
                    } finally {
                        this.loading = false;
                    }
                },
                
                async handleLogin() {
                    if (!this.loginForm.email || !this.loginForm.password) {
                        this.showNotification('error', 'è¾“å…¥é”™è¯¯', 'è¯·å¡«å†™é‚®ç®±å’Œå¯†ç ');
                        return;
                    }
                    
                    this.loading = true;
                    
                    try {
                        const { data, error } = await this.supabase.auth.signInWithPassword({
                            email: this.loginForm.email,
                            password: this.loginForm.password
                        });
                        
                        if (error) throw error;
                        
                        this.isAuthenticated = true;
                        this.currentUser = data.user;
                        
                        this.loginForm = { email: '', password: '' };
                        
                        await this.loadUserProfile();
                        await this.loadMatches();
                        await this.loadSkills();
                        await this.loadConversations();
                        
                        this.showNotification('success', 'ç™»å½•æˆåŠŸ', 'æ¬¢è¿å›æ¥ï¼');
                        
                    } catch (error) {
                        console.error('ç™»å½•å¤±è´¥:', error);
                        this.showNotification('error', 'ç™»å½•å¤±è´¥', error.message || 'è¯·æ£€æŸ¥é‚®ç®±å’Œå¯†ç ');
                    } finally {
                        this.loading = false;
                    }
                },
                
                async handleRegister() {
                    if (!this.registerForm.email || !this.registerForm.password || !this.registerForm.username) {
                        this.showNotification('error', 'è¾“å…¥é”™è¯¯', 'è¯·å¡«å†™é‚®ç®±ã€å¯†ç å’Œç”¨æˆ·å');
                        return;
                    }
                    
                    if (this.registerForm.password.length < 6) {
                        this.showNotification('error', 'å¯†ç å¤ªçŸ­', 'å¯†ç è‡³å°‘éœ€è¦6ä½å­—ç¬¦');
                        return;
                    }
                    
                    this.loading = true;
                    
                    try {
                        const processSkills = (skillText) => {
                            if (!skillText) return '';
                            const skills = skillText
                                .split('\n')
                                .map(s => s.trim())
                                .filter(s => s.length > 0)
                                .slice(0, 5);
                            return skills[0] || '';
                        };
                        
                        const mainTeachSkill = processSkills(this.registerForm.teachSkills);
                        const mainLearnSkill = processSkills(this.registerForm.learnSkills);
                        
                        console.log('æ³¨å†ŒæŠ€èƒ½å¤„ç†ç»“æœ:', {
                            teachSkills: this.registerForm.teachSkills,
                            mainTeachSkill: mainTeachSkill,
                            learnSkills: this.registerForm.learnSkills,
                            mainLearnSkill: mainLearnSkill
                        });
                        
                        const { data: authData, error: authError } = await this.supabase.auth.signUp({
                            email: this.registerForm.email,
                            password: this.registerForm.password,
                            options: {
                                data: {
                                    username: this.registerForm.username
                                }
                            }
                        });
                        
                        if (authError) throw authError;
                        
                        const userProfileData = {
                            id: authData.user.id,
                            username: this.registerForm.username,
                            email: this.registerForm.email,
                            city: '',
                            teach_skill: mainTeachSkill || '',
                            learn_skill: mainLearnSkill || '',
                            created_at: new Date().toISOString(),
                            updated_at: new Date().toISOString()
                        };
                        
                        console.log('å‡†å¤‡åˆ›å»ºç”¨æˆ·èµ„æ–™:', userProfileData);
                        
                        const { data: profileData, error: profileError } = await this.supabase
                            .from('profiles')
                            .insert([userProfileData]);
                        
                        if (profileError) {
                            if (profileError.code === '23505') {
                                console.log('ç”¨æˆ·èµ„æ–™å·²å­˜åœ¨ï¼Œç»§ç»­ç™»å½•æµç¨‹');
                            } else {
                                throw profileError;
                            }
                        } else {
                            console.log('âœ… ç”¨æˆ·èµ„æ–™åˆ›å»ºæˆåŠŸ:', profileData);
                        }
                        
                        this.isAuthenticated = true;
                        this.currentUser = authData.user;
                        
                        this.registerForm = {
                            email: '',
                            password: '',
                            username: '',
                            teachSkills: '',
                            learnSkills: ''
                        };
                        
                        await this.loadUserProfile();
                        await this.loadMatches();
                        await this.loadSkills();
                        
                        this.showNotification('success', 'æ³¨å†ŒæˆåŠŸ', 'æ¬¢è¿åŠ å…¥çŸ¥èˆŸæŠ€èƒ½äº¤æ¢å¹³å°ï¼');
                        
                        this.activeTab = 'profile';
                        
                    } catch (error) {
                        console.error('æ³¨å†Œå¤±è´¥:', error);
                        this.showNotification('error', 'æ³¨å†Œå¤±è´¥', error.message || 'æ³¨å†Œè¿‡ç¨‹ä¸­å‡ºç°é—®é¢˜');
                    } finally {
                        this.loading = false;
                    }
                },
                
                async loadSkills() {
                    try {
                        console.log('æ­£åœ¨ä»æ•°æ®åº“åŠ è½½æŠ€èƒ½æ•°æ®...');
                        
                        const { data, error } = await this.supabase
                            .from('skills')
                            .select('*')
                            .order('created_at', { ascending: false });
                        
                        if (error) {
                            console.error('åŠ è½½æŠ€èƒ½å¤±è´¥:', error);
                            this.loadMockSkills();
                            this.showNotification('info', 'æç¤º', 'å½“å‰æ˜¾ç¤ºçš„æ˜¯æ¨¡æ‹Ÿæ•°æ®ï¼Œè¯·å‘å¸ƒçœŸå®æŠ€èƒ½');
                            return;
                        }
                        
                        if (!data || data.length === 0) {
                            console.log('æ•°æ®åº“ä¸­æš‚æ— æŠ€èƒ½æ•°æ®');
                            this.loadMockSkills();
                            return;
                        }
                        
                        this.skills = data.map(skill => {
                            let tags = skill.tags || [];
                            if (typeof tags === 'string') {
                                tags = tags.split(',').map(tag => tag.trim()).filter(tag => tag);
                            }
                            
                            return {
                                id: skill.id,
                                user_id: skill.user_id,
                                title: skill.title || 'æœªå‘½åæŠ€èƒ½',
                                author: skill.author || 'åŒ¿åç”¨æˆ·',
                                description: skill.description || 'æš‚æ— æè¿°',
                                category: skill.category || 'æœªåˆ†ç±»',
                                city: skill.city || '',
                                tags: tags,
                                method: skill.method || 'çº¿ä¸Šæ•™å­¦',
                                schedule: skill.schedule || 'æ—¶é—´çµæ´»',
                                created_at: skill.created_at || new Date().toISOString()
                            };
                        });
                        
                        console.log(`æˆåŠŸåŠ è½½ ${this.skills.length} æ¡æŠ€èƒ½æ•°æ®`);
                        
                    } catch (error) {
                        console.error('æŠ€èƒ½åŠ è½½é”™è¯¯:', error);
                        this.loadMockSkills();
                        this.showNotification('error', 'åŠ è½½å¤±è´¥', 'æ— æ³•åŠ è½½æŠ€èƒ½åˆ—è¡¨ï¼Œå·²æ˜¾ç¤ºæ¨¡æ‹Ÿæ•°æ®');
                    }
                },
                
                loadMockSkills() {
                    this.skills = [
                        {
                            id: 1,
                            title: 'Pythonç¼–ç¨‹å…¥é—¨',
                            author: 'å¼ è€å¸ˆ',
                            description: 'ä»é›¶å¼€å§‹å­¦ä¹ Pythonç¼–ç¨‹ï¼Œé€‚åˆå®Œå…¨æ²¡æœ‰ç¼–ç¨‹åŸºç¡€çš„æ–°æ‰‹ã€‚',
                            category: 'ç¼–ç¨‹å¼€å‘',
                            city: 'åŒ—äº¬å¸‚',
                            tags: ['ç¼–ç¨‹', 'Python', 'å…¥é—¨'],
                            method: 'çº¿ä¸Šæ•™å­¦',
                            schedule: 'å‘¨æœ«å…¨å¤©',
                            created_at: '2023-10-15T10:30:00Z'
                        },
                        {
                            id: 2,
                            title: 'å•†åŠ¡è‹±è¯­å£è¯­',
                            author: 'æè€å¸ˆ',
                            description: 'ä¸“æ³¨äºå•†åŠ¡åœºæ™¯ä¸‹çš„è‹±è¯­å£è¯­è¡¨è¾¾ï¼Œæå‡èŒåœºæ²Ÿé€šèƒ½åŠ›ã€‚',
                            category: 'è¯­è¨€å­¦ä¹ ',
                            city: 'ä¸Šæµ·å¸‚',
                            tags: ['è‹±è¯­', 'å•†åŠ¡', 'å£è¯­'],
                            method: 'çº¿ä¸Š+çº¿ä¸‹',
                            schedule: 'å·¥ä½œæ—¥æ™šä¸Š',
                            created_at: '2023-10-18T14:20:00Z'
                        },
                        {
                            id: 3,
                            title: 'æ‰‹æœºæ‘„å½±æŠ€å·§',
                            author: 'ç‹æ‘„å½±å¸ˆ',
                            description: 'æ•™ä½ å¦‚ä½•ç”¨æ‰‹æœºæ‹å‡ºä¸“ä¸šçº§åˆ«çš„ç…§ç‰‡ï¼Œæ— éœ€ä¸“ä¸šè®¾å¤‡ã€‚',
                            category: 'è®¾è®¡åˆ›æ„',
                            city: 'åŒ—äº¬å¸‚',
                            tags: ['æ‘„å½±', 'æ‰‹æœº', 'è‰ºæœ¯'],
                            method: 'è§†é¢‘æ•™ç¨‹',
                            schedule: 'æ—¶é—´çµæ´»',
                            created_at: '2023-10-20T09:15:00Z'
                        },
                        {
                            id: 4,
                            title: 'å®¶å¸¸èœçƒ¹é¥ª',
                            author: 'é™ˆå¤§å¨',
                            description: 'å­¦ä¹ åˆ¶ä½œç¾å‘³å®¶å¸¸èœï¼Œè®©å®¶äººäº«å—å¥åº·ç¾é£Ÿã€‚',
                            category: 'ç”Ÿæ´»æŠ€èƒ½',
                            city: 'åŒ—äº¬å¸‚',
                            tags: ['çƒ¹é¥ª', 'ç¾é£Ÿ', 'ç”Ÿæ´»'],
                            method: 'çº¿ä¸‹æ•™å­¦',
                            schedule: 'å‘¨æœ«ä¸‹åˆ',
                            created_at: '2023-10-22T16:45:00Z'
                        },
                        {
                            id: 5,
                            title: 'ç‘œä¼½åŸºç¡€ä¸è¿›é˜¶',
                            author: 'æç‘œä¼½',
                            description: 'ä»åŸºç¡€åˆ°è¿›é˜¶çš„ç‘œä¼½æ•™å­¦ï¼Œé€‚åˆå„æ°´å¹³å­¦å‘˜ã€‚',
                            category: 'è¿åŠ¨å¥èº«',
                            city: 'åŒ—äº¬å¸‚',
                            tags: ['ç‘œä¼½', 'å¥èº«', 'å¥åº·'],
                            method: 'çº¿ä¸‹æ•™å­¦',
                            schedule: 'å‘¨æœ«ä¸Šåˆ',
                            created_at: '2023-10-24T09:30:00Z'
                        }
                    ];
                },
                
                openSkillModal() {
                    if (!this.currentUser) {
                        this.showNotification('warning', 'è¯·å…ˆç™»å½•', 'ç™»å½•åæ‰èƒ½å‘å¸ƒæŠ€èƒ½');
                        return;
                    }
                    // é¢„å¡«å……å½“å‰ç”¨æˆ·çš„åŸå¸‚
                    if (this.userProfile && this.userProfile.city) {
                        this.newSkill.city = this.userProfile.city;
                    }
                    this.showSkillModal = true;
                },
                
                // ä¿®æ”¹ publishSkill å‡½æ•°ä»¥é€‚é…ä¿®å¤åçš„æ¨¡æ€æ¡†
                async publishSkill() {
                    if (!this.currentUser) {
                        this.showNotification('warning', 'è¯·å…ˆç™»å½•', 'ç™»å½•åæ‰èƒ½å‘å¸ƒæŠ€èƒ½');
                        return;
                    }
                    
                    // éªŒè¯å¿…å¡«å­—æ®µ
                    if (!this.newSkill.title.trim()) {
                        this.showNotification('error', 'è¯·è¾“å…¥æŠ€èƒ½æ ‡é¢˜', 'æŠ€èƒ½æ ‡é¢˜ä¸èƒ½ä¸ºç©º');
                        return;
                    }
                    
                    if (!this.newSkill.description.trim()) {
                        this.showNotification('error', 'è¯·è¾“å…¥æŠ€èƒ½æè¿°', 'æŠ€èƒ½æè¿°ä¸èƒ½ä¸ºç©º');
                        return;
                    }
                    
                    if (!this.newSkill.category) {
                        this.showNotification('error', 'è¯·é€‰æ‹©åˆ†ç±»', 'è¯·é€‰æ‹©æŠ€èƒ½åˆ†ç±»');
                        return;
                    }
                    
                    this.loading = true;
                    
                    try {
                        // æ„å»ºæŠ€èƒ½æ•°æ® - é€‚é…ä¿®å¤åçš„è¡¨å•å­—æ®µ
                        const skillData = {
                            user_id: this.currentUser.id,
                           author: this.userProfile.username || this.currentUser.email.split('@')[0] || 'åŒ¿åç”¨æˆ·',
                            title: this.newSkill.title.trim(),
                            description: this.newSkill.description.trim(),
                            category: this.newSkill.category,
                            method: this.newSkill.teachingMethod || 'åœ¨çº¿',
                            city: this.newSkill.city || (this.userProfile && this.userProfile.city) || 'æœªè®¾ç½®',
                            created_at: new Date().toISOString(),
                            updated_at: new Date().toISOString()
                        };
                        
                        console.log('å‡†å¤‡å‘å¸ƒçš„æŠ€èƒ½æ•°æ®:', skillData);
                        
                        // ä¿å­˜åˆ°Supabase
                        const { data, error } = await this.supabase
                            .from('skills')
                            .insert([skillData])
                            .select();
                        
                        if (error) {
                            console.error('å‘å¸ƒæŠ€èƒ½å¤±è´¥:', error);
                            
                            if (error.code === '42501') {
                                this.showNotification('error', 'æƒé™ä¸è¶³', 'è¯·ç¡®è®¤æ‚¨å·²ç™»å½•');
                            } else if (error.message.includes('network')) {
                                this.showNotification('error', 'ç½‘ç»œé”™è¯¯', 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                            } else {
                                this.showNotification('error', 'å‘å¸ƒå¤±è´¥', error.message || 'å‘å¸ƒè¿‡ç¨‹ä¸­å‡ºç°é—®é¢˜');
                            }
                            return;
                        }
                        
                        console.log('âœ… æŠ€èƒ½å‘å¸ƒæˆåŠŸ:', data);
                        
                        // æ¸…ç©ºè¡¨å•
                        this.newSkill = {
                            title: '',
                            description: '',
                            category: '',
                            teachingMethod: 'åœ¨çº¿',
                            city: ''
                        };
                        
                        // å…³é—­æ¨¡æ€æ¡†
                        this.showSkillModal = false;
                        
                        // æ˜¾ç¤ºæˆåŠŸé€šçŸ¥
                        this.showNotification('success', 'å‘å¸ƒæˆåŠŸ', 'æŠ€èƒ½å·²æˆåŠŸå‘å¸ƒï¼');
                        
                        // åˆ·æ–°æŠ€èƒ½åˆ—è¡¨
                        await this.loadSkills();
                        
                        // æ›´æ–°ç”¨æˆ·çš„åˆ†äº«æŠ€èƒ½
                        await this.updateUserTeachSkills(skillData.title);
                        
                    } catch (error) {
                        console.error('å‘å¸ƒæŠ€èƒ½è¿‡ç¨‹ä¸­å‡ºç°å¼‚å¸¸:', error);
                        this.showNotification('error', 'å‘å¸ƒå¤±è´¥', 'å‘å¸ƒæŠ€èƒ½æ—¶å‡ºç°å¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•');
                    } finally {
                        this.loading = false;
                    }
                },
                
                // æ›´æ–°ç”¨æˆ·åˆ†äº«æŠ€èƒ½çš„å‡½æ•°
                async updateUserTeachSkills(newSkill) {
                    if (!this.userProfile || !this.currentUser) return;
                    
                    try {
                        const currentSkills = this.userProfile.teach_skill || '';
                        const skillsArray = currentSkills.split(',').filter(s => s.trim());
                        
                        if (!skillsArray.includes(newSkill)) {
                            skillsArray.push(newSkill);
                            const updatedSkills = skillsArray.join(',');
                            
                            await this.supabase
                                .from('profiles')
                                .update({
                                    teach_skill: updatedSkills,
                                    updated_at: new Date().toISOString()
                                })
                                .eq('id', this.currentUser.id);
                        }
                    } catch (error) {
                        console.warn('æ›´æ–°ç”¨æˆ·æŠ€èƒ½å¤±è´¥:', error);
                    }
                },
                
                async loadMatches() {
                    if (!this.currentUser) return;
                    
                    try {
                        const { data: profiles, error } = await this.supabase
                            .from('profiles')
                            .select('*')
                            .neq('id', this.currentUser.id);
                        
                        if (error) throw error;
                        
                        const currentUserTeachSkill = this.userProfile.teach_skill || '';
                        const currentUserLearnSkill = this.userProfile.learn_skill || '';
                        const currentUserCity = this.userProfile.city || '';
                        
                        const cleanSkill = (skill) => {
                            if (!skill) return null;
                            
                            const cleaned = skill.toString()
                                .trim()
                                .replace(/\s+/g, ' ')
                                .replace(/[\r\n]+/g, '')
                                .replace(/[ã€ï¼Œ,]/g, ',')
                                .split(',')[0]
                                .trim();
                            
                            if (!cleaned || cleaned === '' || cleaned === 'æœªè®¾ç½®' || cleaned === 'null') {
                                return null;
                            }
                            
                            return cleaned;
                        };
                        
                        const currentTeach = cleanSkill(currentUserTeachSkill);
                        const currentLearn = cleanSkill(currentUserLearnSkill);
                        
                        console.log('ğŸ” å½“å‰ç”¨æˆ·æŠ€èƒ½:', { 
                            teach: currentTeach, 
                            learn: currentLearn,
                            city: currentUserCity 
                        });
                        
                        this.matches = profiles.map(profile => {
                            const otherTeach = cleanSkill(profile.teach_skill);
                            const otherLearn = cleanSkill(profile.learn_skill);
                            const otherCity = profile.city || '';
                            
                            console.log(`åŒ¹é…ç”¨æˆ· ${profile.username}:`, { 
                                teach: otherTeach, 
                                learn: otherLearn,
                                city: otherCity
                            });
                            
                            let matchScore = 0;
                            
                            if (!otherTeach && !otherLearn) {
                                console.log(`âŒ ${profile.username} æ— æŠ€èƒ½ï¼ŒåŒ¹é…åº¦0`);
                                return {
                                    ...profile,
                                    matchScore: 0
                                };
                            }
                            
                            if (!currentTeach && !currentLearn) {
                                console.log(`âš ï¸ å½“å‰ç”¨æˆ·æ— æŠ€èƒ½ï¼Œç»™äºˆåŸºç¡€åˆ†`);
                                matchScore = 10;
                            } else {
                                if (currentLearn && otherTeach) {
                                    if (currentLearn === otherTeach) {
                                        matchScore += 50;
                                        console.log(`âœ… æ ¸å¿ƒç²¾ç¡®åŒ¹é… +50: ${currentLearn} = ${otherTeach}`);
                                    } 
                                    else if (otherTeach.includes(currentLearn) || currentLearn.includes(otherTeach)) {
                                        matchScore += 40;
                                        console.log(`âœ… æ ¸å¿ƒåŒ…å«åŒ¹é… +40: ${currentLearn} åŒ…å«äº ${otherTeach}`);
                                    }
                                }
                                
                                if (currentTeach && otherLearn) {
                                    if (currentTeach === otherLearn) {
                                        matchScore += 30;
                                        console.log(`âœ… æ¬¡è¦ç²¾ç¡®åŒ¹é… +30: ${currentTeach} = ${otherLearn}`);
                                    }
                                    else if (otherLearn.includes(currentTeach) || currentTeach.includes(otherLearn)) {
                                        matchScore += 20;
                                        console.log(`âœ… æ¬¡è¦åŒ…å«åŒ¹é… +20: ${currentTeach} åŒ…å«äº ${otherLearn}`);
                                    }
                                }
                                
                                if ((currentTeach || currentLearn) && (otherTeach || otherLearn)) {
                                    matchScore += 10;
                                    console.log(`âœ… åŒæ–¹æœ‰æŠ€èƒ½ï¼ŒåŸºç¡€åˆ† +10`);
                                }
                                
                                if (currentUserCity && otherCity && this.isSameCity(currentUserCity, otherCity)) {
                                    matchScore += 20;
                                    console.log(`ğŸ™ï¸ åŒåŸåŒ¹é… +20: ${currentUserCity} = ${otherCity}`);
                                }
                            }
                            
                            matchScore = Math.min(100, Math.max(0, matchScore));
                            
                            console.log(`ğŸ“Š ${profile.username} æœ€ç»ˆåŒ¹é…åº¦: ${matchScore}%`);
                            
                            return {
                                ...profile,
                                matchScore: matchScore
                            };
                        })
                        .filter(match => match.matchScore > 0)
                        .sort((a, b) => b.matchScore - a.matchScore)
                        .slice(0, 10);
                        
                        console.log('æœ€ç»ˆåŒ¹é…ç»“æœ:', this.matches);
                        
                    } catch (error) {
                        console.error('åŠ è½½åŒ¹é…ç”¨æˆ·å¤±è´¥:', error);
                        this.matches = [];
                    }
                },
                
                isSameCity(city1, city2) {
                    if (!city1 || !city2) return false;
                    
                    const normalizeCity = (city) => {
                        if (!city) return '';
                        return city.replace(/å¸‚|åŒº|å¿|é•‡|ä¹¡|è¡—é“|åœ°åŒº$/g, '').trim();
                    };
                    
                    const normalized1 = normalizeCity(city1);
                    const normalized2 = normalizeCity(city2);
                    
                    if (normalized1 === normalized2) return true;
                    
                    if (city1.includes(city2) || city2.includes(city1)) return true;
                    
                    return false;
                },
                
                searchSkills() {
                    return this.skills;
                },
                
                get filteredSkills() {
                    let filtered = this.skills;
                    
                    console.log('å¼€å§‹ç­›é€‰ï¼ŒåŸå§‹æŠ€èƒ½æ•°é‡:', filtered.length);
                    
                    if (this.searchQuery) {
                        const query = this.searchQuery.toLowerCase();
                        filtered = filtered.filter(skill => 
                            skill.title.toLowerCase().includes(query) ||
                            skill.description.toLowerCase().includes(query) ||
                            skill.author.toLowerCase().includes(query) ||
                            (skill.tags && skill.tags.some(tag => tag.toLowerCase().includes(query)))
                        );
                        console.log('æœç´¢è¿‡æ»¤å:', filtered.length);
                    }
                    
                    if (this.skillFilter) {
                        filtered = filtered.filter(skill => {
                            if (this.skillFilter === 'teach') {
                                return skill.category !== 'è¯­è¨€å­¦ä¹ ';
                            } else if (this.skillFilter === 'learn') {
                                return skill.category === 'è¯­è¨€å­¦ä¹ ';
                            }
                            return true;
                        });
                        console.log('åˆ†ç±»è¿‡æ»¤å:', filtered.length);
                    }
                    
                    if (this.showSameCityOnly && this.userProfile && this.userProfile.city) {
                        const userCity = this.userProfile.city;
                        console.log('è¿›è¡ŒåŒåŸç­›é€‰ï¼Œç”¨æˆ·åŸå¸‚:', userCity);
                        
                        const beforeFilterCount = filtered.length;
                        
                        filtered = filtered.filter(skill => {
                            if (!skill.city) {
                                console.log('æŠ€èƒ½æ— åŸå¸‚ä¿¡æ¯:', skill.title);
                                return false;
                            }
                            
                            const isSame = this.isSameCity(userCity, skill.city);
                            
                            if (isSame) {
                                console.log('åŒåŸåŒ¹é…æˆåŠŸ:', userCity, '==', skill.city, 'æŠ€èƒ½:', skill.title);
                            } else {
                                console.log('åŒåŸåŒ¹é…å¤±è´¥:', userCity, '!=', skill.city, 'æŠ€èƒ½:', skill.title);
                            }
                            
                            return isSame;
                        });
                        
                        console.log(`åŒåŸç­›é€‰: ${beforeFilterCount} -> ${filtered.length} (ç”¨æˆ·åŸå¸‚: ${userCity})`);
                        
                        if (filtered.length === 0 && this.skills.length > 0) {
                            console.log('æœªæ‰¾åˆ°åŒåŸæŠ€èƒ½ï¼Œæ‰€æœ‰æŠ€èƒ½:', this.skills.map(s => ({title: s.title, city: s.city})));
                        }
                    } else if (this.showSameCityOnly) {
                        console.log('åŒåŸç­›é€‰å·²å¼€å¯ï¼Œä½†ç”¨æˆ·æœªè®¾ç½®åŸå¸‚');
                    }
                    
                    console.log('æœ€ç»ˆç­›é€‰ç»“æœ:', filtered.length);
                    return filtered;
                },
                
                get filteredConversations() {
                    if (!this.searchConversation) {
                        return this.conversations;
                    }
                    
                    const searchTerm = this.searchConversation.toLowerCase();
                    return this.conversations.filter(conv => 
                        conv.username.toLowerCase().includes(searchTerm) ||
                        (conv.skillTitle && conv.skillTitle.toLowerCase().includes(searchTerm)) ||
                        conv.lastMessage.toLowerCase().includes(searchTerm)
                    );
                },
                
                getRandomColor() {
                    const colors = ['from-blue-500 to-blue-600', 'from-green-500 to-green-600', 
                                   'from-purple-500 to-purple-600', 'from-pink-500 to-pink-600',
                                   'from-orange-500 to-orange-600', 'from-teal-500 to-teal-600'];
                    return colors[Math.floor(Math.random() * colors.length)];
                },
                
                // ä¿®æ”¹ï¼šåŠ è½½å¯¹è¯æ—¶è¿‡æ»¤å·²åˆ é™¤çš„å¯¹è¯
                async loadConversations() {
                    try {
                        if (!this.currentUser) {
                            console.log('æœªç™»å½•ç”¨æˆ·ï¼Œæ— æ³•åŠ è½½å¯¹è¯');
                            return;
                        }
                        
                        console.log('æ­£åœ¨ä»æ•°æ®åº“åŠ è½½å¯¹è¯åˆ—è¡¨ï¼Œå½“å‰ç”¨æˆ·ID:', this.currentUser.id);
                        
                        const { data: messages, error } = await this.supabase
                            .from('messages')
                            .select('*')
                            .or(`sender_id.eq.${this.currentUser.id},receiver_id.eq.${this.currentUser.id}`)
                            .order('created_at', { ascending: false });
                        
                        if (error) {
                            console.error('åŠ è½½æ¶ˆæ¯å¤±è´¥:', error);
                            return;
                        }
                        
                        console.log('æŸ¥è¯¢åˆ°çš„æ¶ˆæ¯æ•°é‡:', messages?.length);
                        
                        if (!messages || messages.length === 0) {
                            console.log('æ²¡æœ‰æ‰¾åˆ°æ¶ˆæ¯è®°å½•');
                            return;
                        }
                        
                        const conversationsMap = new Map();
                        
                        for (const message of messages) {
                            const otherUserId = message.sender_id === this.currentUser.id 
                                ? message.receiver_id 
                                : message.sender_id;
                            
                            const conversationId = [this.currentUser.id, otherUserId]
                                .sort()
                                .join('_');
                            
                            // è·³è¿‡å·²åˆ é™¤çš„å¯¹è¯
                            if (this.deletedConversations.includes(conversationId)) {
                                continue;
                            }
                            
                            if (!conversationsMap.has(conversationId)) {
                                let otherUserInfo = { username: 'æœªçŸ¥ç”¨æˆ·', teach_skill: '' };
                                
                                try {
                                    const { data: profile } = await this.supabase
                                        .from('profiles')
                                        .select('username, teach_skill')
                                        .eq('id', otherUserId)
                                        .single();
                                    
                                    if (profile) {
                                        otherUserInfo = profile;
                                    }
                                } catch (err) {
                                    console.warn('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', err);
                                }
                                
                                conversationsMap.set(conversationId, {
                                    id: conversationId,
                                    userId: otherUserId,
                                    username: otherUserInfo.username,
                                    skillTitle: otherUserInfo.teach_skill || 'æœªè®¾ç½®æŠ€èƒ½',
                                    lastMessage: message.content,
                                    timestamp: message.created_at,
                                    unread: !message.is_read && message.receiver_id === this.currentUser.id ? 1 : 0,
                                    avatarColor: this.getRandomColor()
                                });
                            } else {
                                const existing = conversationsMap.get(conversationId);
                                const currentTime = new Date(existing.timestamp);
                                const messageTime = new Date(message.created_at);
                                
                                if (messageTime > currentTime) {
                                    existing.lastMessage = message.content;
                                    existing.timestamp = message.created_at;
                                    if (!message.is_read && message.receiver_id === this.currentUser.id) {
                                        existing.unread = (existing.unread || 0) + 1;
                                    }
                                } else if (!message.is_read && message.receiver_id === this.currentUser.id) {
                                    existing.unread = (existing.unread || 0) + 1;
                                }
                            }
                        }
                        
                        this.conversations = Array.from(conversationsMap.values())
                            .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                        
                        this.unreadCount = this.conversations.reduce((sum, conv) => sum + (conv.unread || 0), 0);
                        
                        console.log('æ„å»ºçš„å¯¹è¯åˆ—è¡¨:', this.conversations);
                        
                    } catch (error) {
                        console.error('åŠ è½½å¯¹è¯å¼‚å¸¸:', error);
                        // ä¸å†åŠ è½½æ¨¡æ‹Ÿæ•°æ®
                    }
                },
                
                async selectConversation(conversationId) {
                    console.log('é€‰æ‹©å¯¹è¯:', conversationId);
                    
                    this.selectedConversationId = conversationId;
                    this.selectedConversation = this.conversations.find(c => c.id === conversationId);
                    
                    if (!this.selectedConversation || !this.selectedConversation.userId) {
                        console.error('æ‰¾ä¸åˆ°å¯¹è¯æˆ–ç”¨æˆ·ID:', conversationId);
                        this.selectedConversationMessages = [];
                        return;
                    }
                    
                    try {
                        const otherUserId = this.selectedConversation.userId;
                        
                        console.log('åŠ è½½å¯¹è¯æ¶ˆæ¯ï¼Œå¯¹æ–¹ç”¨æˆ·:', otherUserId);
                        
                        const { data: messages, error } = await this.supabase
                            .from('messages')
                            .select('*')
                            .or(`and(sender_id.eq.${this.currentUser.id},receiver_id.eq.${otherUserId}),and(sender_id.eq.${otherUserId},receiver_id.eq.${this.currentUser.id})`)
                            .order('created_at', { ascending: true });
                        
                        if (error) {
                            console.error('åŠ è½½æ¶ˆæ¯å¤±è´¥:', error);
                            throw error;
                        }
                        
                        console.log('æŸ¥è¯¢åˆ°çš„æ¶ˆæ¯æ•°é‡:', messages?.length);
                        
                        this.selectedConversationMessages = (messages || []).map(msg => ({
                            id: msg.id,
                            sender: msg.sender_id === this.currentUser.id ? 'me' : 'other',
                            content: msg.content,
                            timestamp: msg.created_at,
                            is_read: msg.is_read
                        }));
                        
                        const unreadMessages = messages.filter(msg => 
                            !msg.is_read && msg.receiver_id === this.currentUser.id
                        );

                        if (unreadMessages.length > 0) {
                            const unreadIds = unreadMessages.map(msg => msg.id);
                            
                            console.log('æ ‡è®°ä»¥ä¸‹æ¶ˆæ¯ä¸ºå·²è¯»:', unreadIds);
                            
                            try {
                                const { error: updateError } = await this.supabase
                                    .from('messages')
                                    .update({ is_read: true })
                                    .in('id', unreadIds);
                                
                                if (updateError) {
                                    console.error('æ›´æ–°æ¶ˆæ¯å·²è¯»çŠ¶æ€å¤±è´¥:', updateError);
                                } else {
                                    console.log('âœ… æˆåŠŸæ ‡è®°æ¶ˆæ¯ä¸ºå·²è¯»');
                                }
                            } catch (updateErr) {
                                console.error('æ›´æ–°å·²è¯»çŠ¶æ€å¼‚å¸¸:', updateErr);
                            }
                            
                            if (this.selectedConversation) {
                                this.selectedConversation.unread = 0;
                                
                                const convIndex = this.conversations.findIndex(c => c.id === conversationId);
                                if (convIndex !== -1) {
                                    this.conversations[convIndex].unread = 0;
                                }
                                
                                this.unreadCount = this.conversations.reduce((sum, conv) => sum + (conv.unread || 0), 0);
                                console.log('æ›´æ–°åæœªè¯»æ€»æ•°:', this.unreadCount);
                            }
                        }
                        
                    } catch (error) {
                        console.error('åŠ è½½å¯¹è¯æ¶ˆæ¯å¼‚å¸¸:', error);
                        
                        this.selectedConversationMessages = [
                            { 
                                id: 'temp_1', 
                                sender: 'other', 
                                content: 'ä½ å¥½ï¼å¾ˆé«˜å…´è®¤è¯†ä½ ã€‚', 
                                timestamp: new Date().toISOString() 
                            }
                        ];
                    }
                    
                    setTimeout(() => {
                        const messageInput = document.querySelector('input[placeholder="è¾“å…¥æ¶ˆæ¯..."]');
                        if (messageInput) {
                            messageInput.focus();
                            messageInput.scrollIntoView({ behavior: 'smooth' });
                        }
                    }, 100);
                },
                
                async sendNewMessage() {
                    console.log('ğŸš€ å¼€å§‹å‘é€æ¶ˆæ¯...');
                    
                    if (!this.newMessage.trim() || !this.selectedConversationId || !this.currentUser) {
                        console.log('å‘é€æ¶ˆæ¯æ¡ä»¶ä¸æ»¡è¶³');
                        this.showNotification('warning', 'æ— æ³•å‘é€', 'è¯·å…ˆé€‰æ‹©å¯¹è¯æˆ–ç™»å½•');
                        return;
                    }
                    
                    console.log('å‘é€æ¶ˆæ¯ç»™å¯¹è¯:', this.selectedConversationId, 'å†…å®¹:', this.newMessage);
                    
                    if (!navigator.onLine) {
                        this.showNotification('error', 'ç½‘ç»œè¿æ¥å¤±è´¥', 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åå†å‘é€æ¶ˆæ¯');
                        return;
                    }
                    
                    const tempMessage = {
                        id: 'temp_' + Date.now(),
                        sender: 'me',
                        content: this.newMessage,
                        timestamp: new Date().toISOString(),
                        temp: true
                    };
                    
                    this.selectedConversationMessages.push(tempMessage);
                    
                    try {
                        let receiverId = null;
                        
                        if (this.selectedConversation && this.selectedConversation.userId) {
                            receiverId = this.selectedConversation.userId;
                        } else {
                            console.warn('âš ï¸ æœªæ‰¾åˆ°æ¥æ”¶è€…IDï¼Œå°†æ¶ˆæ¯å‘é€ç»™è‡ªå·±ä½œä¸ºæµ‹è¯•');
                            receiverId = this.currentUser.id;
                        }
                        
                        console.log('å‘é€è€…ID:', this.currentUser.id);
                        console.log('æ¥æ”¶è€…ID:', receiverId);
                        
                        const messageData = {
                            sender_id: this.currentUser.id,
                            receiver_id: receiverId,
                            content: this.newMessage.trim(),
                            created_at: new Date().toISOString(),
                            is_read: false
                        };
                        
                        console.log('å‡†å¤‡æ’å…¥æ¶ˆæ¯æ•°æ®:', messageData);
                        
                        const { data, error } = await this.supabase
                            .from('messages')
                            .insert([messageData])
                            .select();
                        
                        if (error) {
                            console.error('âŒ ä¿å­˜æ¶ˆæ¯åˆ°æ•°æ®åº“å¤±è´¥:', error);
                            
                            const msgIndex = this.selectedConversationMessages.findIndex(m => m.id === tempMessage.id);
                            if (msgIndex !== -1) {
                                this.selectedConversationMessages[msgIndex].failed = true;
                                this.selectedConversationMessages[msgIndex].errorDetails = 
                                    `é”™è¯¯ç  ${error.code}: ${error.message || 'æ•°æ®åº“é”™è¯¯'}`;
                            }
                            
                            let errorMsg = 'æ¶ˆæ¯å‘é€å¤±è´¥';
                            if (error.code === '42501') {
                                errorMsg = 'æƒé™ä¸è¶³ï¼šè¯·æ£€æŸ¥messagesè¡¨çš„RLSç­–ç•¥';
                            } else if (error.code === '22P02') {
                                errorMsg = 'æ ¼å¼é”™è¯¯ï¼šæ¥æ”¶è€…IDå¿…é¡»æ˜¯æœ‰æ•ˆçš„UUIDæ ¼å¼';
                            } else if (error.code === '23503') {
                                errorMsg = 'å¤–é”®é”™è¯¯ï¼šå‘é€è€…æˆ–æ¥æ”¶è€…ç”¨æˆ·ä¸å­˜åœ¨';
                            }
                            
                            this.showNotification('error', 'å‘é€å¤±è´¥', errorMsg);
                            return;
                        }
                        
                        console.log('âœ… æ¶ˆæ¯ä¿å­˜æˆåŠŸï¼Œæ•°æ®åº“è¿”å›:', data);
                        
                        const msgIndex = this.selectedConversationMessages.findIndex(m => m.id === tempMessage.id);
                        if (msgIndex !== -1 && data && data[0]) {
                            this.selectedConversationMessages[msgIndex].id = data[0].id;
                            this.selectedConversationMessages[msgIndex].temp = false;
                        }
                        
                        if (this.selectedConversation) {
                            this.selectedConversation.lastMessage = this.newMessage;
                            this.selectedConversation.timestamp = new Date().toISOString();
                            
                            this.conversations.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                        }
                        
                        this.newMessage = '';
                        
                        this.showNotification('success', 'å‘é€æˆåŠŸ', 'æ¶ˆæ¯å·²ä¿å­˜åˆ°æ•°æ®åº“ï¼');
                        
                        await this.loadConversations();
                        
                        if (this.selectedConversationId) {
                            await this.selectConversation(this.selectedConversationId);
                        }
                        
                        setTimeout(async () => {
                            const replyMsg = {
                                id: 'reply_' + Date.now(),
                                sender: 'other',
                                content: 'æ”¶åˆ°ä½ çš„æ¶ˆæ¯äº†ï¼Œæˆ‘ä¼šå°½å¿«å›å¤ï¼',
                                timestamp: new Date().toISOString()
                            };
                            
                            this.selectedConversationMessages.push(replyMsg);
                            
                            if (this.selectedConversation) {
                                this.selectedConversation.lastMessage = replyMsg.content;
                                this.selectedConversation.timestamp = replyMsg.timestamp;
                                
                                console.log('æ¨¡æ‹Ÿå›å¤å·²å‘é€ï¼Œä¸å¢åŠ æœªè¯»è®¡æ•°');
                            }
                            
                            try {
                                const replyMessageData = {
                                    sender_id: this.selectedConversation.userId,
                                    receiver_id: this.currentUser.id,
                                    content: replyMsg.content,
                                    created_at: replyMsg.timestamp,
                                    is_read: false
                                };
                                
                                const { data, error } = await this.supabase
                                    .from('messages')
                                    .insert([replyMessageData])
                                    .select();
                                
                                if (error) {
                                    console.error('ä¿å­˜æ¨¡æ‹Ÿå›å¤å¤±è´¥:', error);
                                } else {
                                    console.log('æ¨¡æ‹Ÿå›å¤å·²ä¿å­˜åˆ°æ•°æ®åº“:', data);
                                    
                                    await this.loadConversations();
                                    
                                    if (this.selectedConversationId) {
                                        await this.selectConversation(this.selectedConversationId);
                                    }
                                }
                            } catch (err) {
                                console.error('æ¨¡æ‹Ÿå›å¤å¼‚å¸¸:', err);
                            }
                        }, 2000);
                        
                    } catch (error) {
                        console.error('ğŸ”¥ å‘é€æ¶ˆæ¯è¿‡ç¨‹ä¸­å‡ºç°å¼‚å¸¸:', error);
                        
                        const msgIndex = this.selectedConversationMessages.findIndex(m => m.id === tempMessage.id);
                        if (msgIndex !== -1) {
                            this.selectedConversationMessages[msgIndex].failed = true;
                            this.selectedConversationMessages[msgIndex].errorDetails = error.message || 'æœªçŸ¥é”™è¯¯';
                        }
                        
                        this.showNotification('error', 'å‘é€å¼‚å¸¸', 'å‘é€è¿‡ç¨‹ä¸­å‡ºç°å¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•');
                    }
                },
                
                sendMessage(userId, username) {
                    console.log('å¼€å§‹ä¸ç”¨æˆ·å¯¹è¯:', userId, username);
                    
                    const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
                    
                    if (!uuidRegex.test(userId)) {
                        console.warn('âš ï¸ ç”¨æˆ·IDä¸æ˜¯æœ‰æ•ˆçš„UUIDæ ¼å¼:', userId);
                        this.showNotification('warning', 'ç”¨æˆ·IDæ ¼å¼é”™è¯¯', 'æ— æ³•å¼€å§‹å¯¹è¯ï¼Œç”¨æˆ·IDæ ¼å¼ä¸æ­£ç¡®');
                        return;
                    }
                    
                    this.showNotification('info', 'å‘é€æ¶ˆæ¯', `å¼€å§‹ä¸ ${username} å¯¹è¯`);
                    this.activeTab = 'messages';
                    
                    const conversationId = [this.currentUser.id, userId].sort().join('_');
                    
                    const existingConversation = this.conversations.find(c => c.id === conversationId);
                    
                    if (existingConversation) {
                        this.selectConversation(existingConversation.id);
                        this.showNotification('info', 'ç»§ç»­å¯¹è¯', `ä½ ä¹‹å‰å·²ç»è”ç³»è¿‡${username}äº†`);
                    } else {
                        const newConversation = {
                            id: conversationId,
                            userId: userId,
                            username: username,
                            lastMessage: 'ä½ å‘èµ·äº†å¯¹è¯',
                            timestamp: new Date().toISOString(),
                            unread: 0,
                            avatarColor: this.getRandomColor()
                        };
                        
                        this.conversations.unshift(newConversation);
                        this.selectConversation(newConversation.id);
                    }
                },
                
                async contactSkillOwner(skill) {
                    console.log('å¼€å§‹è”ç³»æŠ€èƒ½æ‰€æœ‰è€…:', skill);
                    
                    if (!this.isAuthenticated) {
                        this.showNotification('warning', 'è¯·å…ˆç™»å½•', 'ç™»å½•åæ‰èƒ½è”ç³»æŠ€èƒ½æ‰€æœ‰è€…');
                        this.activeTab = 'profile';
                        return;
                    }
                    
                    if (skill.author === this.userProfile.username) {
                        this.showNotification('info', 'æç¤º', 'è¿™æ˜¯ä½ è‡ªå·±å‘å¸ƒçš„æŠ€èƒ½å“¦ï¼');
                        return;
                    }
                    
                    let ownerUserId = skill.user_id;
                    let ownerUsername = skill.author;
                    
                    if (!ownerUserId) {
                        const match = this.matches.find(m => m.username === skill.author);
                        if (match && match.id) {
                            ownerUserId = match.id;
                            ownerUsername = match.username;
                        } else {
                            console.warn('âš ï¸ æ— æ³•æ‰¾åˆ°æŠ€èƒ½æ‰€æœ‰è€…çš„ç”¨æˆ·IDï¼Œä½¿ç”¨é»˜è®¤ID');
                            ownerUserId = '00000000-0000-0000-0000-000000000001';
                        }
                    }
                    
                    this.activeTab = 'messages';
                    
                    const conversationId = [this.currentUser.id, ownerUserId].sort().join('_');
                    
                    const existingConversation = this.conversations.find(conv => conv.id === conversationId);
                    
                    if (existingConversation) {
                        this.selectConversation(existingConversation.id);
                        this.showNotification('info', 'ç»§ç»­å¯¹è¯', `ä½ ä¹‹å‰å·²ç»è”ç³»è¿‡${ownerUsername}äº†`);
                    } else {
                        const newConversation = {
                            id: conversationId,
                            userId: ownerUserId,
                            username: ownerUsername,
                            skillTitle: skill.title,
                            skillId: skill.id,
                            lastMessage: `æˆ‘æƒ³å­¦ä¹ "${skill.title}"`,
                            timestamp: new Date().toISOString(),
                            unread: 0,
                            avatarColor: this.getRandomColor()
                        };
                        
                        this.conversations.unshift(newConversation);
                        this.selectConversation(newConversation.id);
                        
                        const skillOwnerCity = skill.city ? `ï¼Œçœ‹åˆ°ä½ åœ¨${skill.city}` : '';
                        const myCity = this.userProfile.city ? `ï¼Œæˆ‘åœ¨${this.userProfile.city}` : '';
                        
                        this.newMessage = `ä½ å¥½${ownerUsername}${skillOwnerCity}ï¼\n\n` +
                                         `æˆ‘å¯¹ä½ å‘å¸ƒçš„"${skill.title}"å¾ˆæ„Ÿå…´è¶£ï¼Œæƒ³å‘ä½ å­¦ä¹ ã€‚\n` +
                                         `${myCity}ï¼Œæˆ‘ä»¬å¯ä»¥çº¦ä¸ªæ—¶é—´äº¤æµä¸€ä¸‹å—ï¼Ÿ\n\n` +
                                         `æˆ‘çš„åŸºæœ¬æƒ…å†µï¼š\n` +
                                         `- æˆ‘æƒ³å­¦ä¹ ï¼š${this.userProfile.learn_skill || 'å¾ˆå¤šæ–°æŠ€èƒ½'}\n` +
                                         `- æˆ‘å¯ä»¥åˆ†äº«ï¼š${this.userProfile.teach_skill || 'ä¸€äº›æŠ€èƒ½'}\n\n` +
                                         `æœŸå¾…ä½ çš„å›å¤ï¼`;
                        
                        this.showNotification('success', 'å¯¹è¯å·²åˆ›å»º', `å·²å¼€å§‹ä¸${ownerUsername}çš„å¯¹è¯`);
                    }
                    
                    setTimeout(() => {
                        const messageInput = document.querySelector('input[placeholder="è¾“å…¥æ¶ˆæ¯..."]');
                        if (messageInput) {
                            messageInput.focus();
                        }
                    }, 300);
                },
                
                async logout() {
                    try {
                        const { error } = await this.supabase.auth.signOut();
                        
                        if (error) throw error;
                        
                        this.isAuthenticated = false;
                        this.currentUser = null;
                        this.userProfile = {};
                        this.matches = [];
                        this.conversations = [];
                        this.skills = [];
                        this.selectedConversationId = null;
                        this.showSameCityOnly = false;
                        
                        this.showNotification('success', 'å·²é€€å‡º', 'æ‚¨å·²æˆåŠŸé€€å‡ºç™»å½•');
                        
                    } catch (error) {
                        console.error('é€€å‡ºç™»å½•å¤±è´¥:', error);
                        this.showNotification('error', 'é€€å‡ºå¤±è´¥', 'é€€å‡ºç™»å½•è¿‡ç¨‹ä¸­å‡ºç°é—®é¢˜');
                    }
                },
                
                formatDate(dateString) {
                    const date = new Date(dateString);
                    const now = new Date();
                    const diffMs = now - date;
                    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                    
                    if (diffDays === 0) {
                        return 'ä»Šå¤©';
                    } else if (diffDays === 1) {
                        return 'æ˜¨å¤©';
                    } else if (diffDays < 7) {
                        return `${diffDays}å¤©å‰`;
                    } else {
                        return date.toLocaleDateString('zh-CN', {
                            month: 'long',
                            day: 'numeric'
                        });
                    }
                },
                
                formatTime(dateString) {
                    const date = new Date(dateString);
                    const now = new Date();
                    const diffMs = now - date;
                    const diffHours = diffMs / (1000 * 60 * 60);
                    
                    if (diffHours < 24) {
                        return date.toLocaleTimeString('zh-CN', { 
                            hour: '2-digit', 
                            minute: '2-digit' 
                        });
                    } else {
                        return date.toLocaleDateString('zh-CN', {
                            month: 'short',
                            day: 'numeric'
                        });
                    }
                },
                
                showNotification(type, title, message) {
                    const ignoredMessages = [
                        'æ— æ³•åˆ›å»ºç”¨æˆ·èµ„æ–™',
                        'ç”¨æˆ·èµ„æ–™åˆ›å»ºå¤±è´¥',
                        'duplicate key',
                        'already exists',
                        '23505',
                        'ç”¨æˆ·è¡¨ä¿¡æ¯'
                    ];
                    
                    for (const keyword of ignoredMessages) {
                        if (message && message.toLowerCase().includes(keyword.toLowerCase())) {
                            console.log(`ğŸš« å·²å¿½ç•¥é€šçŸ¥: ${message}`);
                            return;
                        }
                    }
                    
                    const id = ++this.notificationId;
                    const notification = {
                        id,
                        type,
                        title,
                        message,
                        visible: true
                    };
                    
                    this.notifications.push(notification);
                    
                    setTimeout(() => {
                        this.closeNotification(id);
                    }, 5000);
                },
                
                closeNotification(id) {
                    const notification = this.notifications.find(n => n.id === id);
                    if (notification) {
                        notification.visible = false;
                        
                        setTimeout(() => {
                            this.notifications = this.notifications.filter(n => n.id !== id);
                        }, 300);
                    }
                }
            }));
        });
    </script>
    
    <!-- åˆå§‹åŒ– Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</body>
</html>
